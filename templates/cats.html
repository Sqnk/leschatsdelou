{% extends "base.html" %}
{% block content %}

<h1 class="mb-4">Chats</h1>

<!-- ============================
     ONGLET NAVIGATION
     ============================ -->
<ul class="nav nav-tabs mb-4" id="catsTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="tab-search" data-bs-toggle="tab" data-bs-target="#pane-search"
            type="button" role="tab">Rechercher</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-add" data-bs-toggle="tab" data-bs-target="#pane-add"
            type="button" role="tab">Ajouter un chat</button>
  </li>
</ul>


<!-- ============================
     CONTENU ONGLET
     ============================ -->
<div class="tab-content">

  <!-- ============================
       ONGLET 1 : RECHERCHE
      ============================ -->
  <div class="tab-pane fade show active" id="pane-search" role="tabpanel">


    <!-- === BOUTON TRIER === -->
    <div class="mb-3 d-flex justify-content-start">

      <div class="dropdown">
        <button class="btn btn-outline-secondary" type="button" data-bs-toggle="dropdown">
          Trier : <span id="current-sort-label">Nom (A â†’ Z)</span>
        </button>

        <ul class="dropdown-menu">

          <li><a class="dropdown-item sort-option active" data-sort="name_asc" href="#">
            Nom (A â†’ Z) âœ”
          </a></li>

          <li><a class="dropdown-item sort-option" data-sort="mod_desc" href="#">
            DerniÃ¨re modification (rÃ©cent â†’ ancien)
          </a></li>

          <li><a class="dropdown-item sort-option" data-sort="tasks_desc" href="#">
            Nombre de tÃ¢ches (plus â†’ moins)
          </a></li>

          <li><a class="dropdown-item sort-option" data-sort="age_desc" href="#">
            Ã‚ge (plus Ã¢gÃ© â†’ plus jeune)
          </a></li>

        </ul>
      </div>

    </div>


    <!-- === CHAMP RECHERCHE === -->
    <input id="q" class="form-control form-control-lg mb-3"
           placeholder="Tapez un nomâ€¦ (liste complÃ¨te filtrÃ©e au fur et Ã  mesure)">

    <div id="cats-list" class="list-group"></div>


    <!-- ============================
         SCRIPTS
         ============================ -->
    <script>

    // --- RequÃªte API ---
    async function fetchCats(q="") {
      const url = new URL('{{ url_for("api_cats") }}', window.location.origin);
      if (q) url.searchParams.set("q", q);
      const res = await fetch(url);
      return await res.json();
    }


    // --------------------------
    //        TRI
    // --------------------------
    let currentSort = "name_asc";

    function sortCats(data) {

        return data.sort((a, b) => {

          if (currentSort === "name_asc") {
              return a.name.localeCompare(b.name);
          }

          if (currentSort === "mod_desc") {
              const parse = t => {
                if (!t || t === "â€”") return 0;
                const [date, time] = t.split(" ");
                const [d, m, y] = date.split("/");
                return new Date(`${y}-${m}-${d}T${time}`).getTime();
              };
              return parse(b.last_update) - parse(a.last_update);
          }

          if (currentSort === "tasks_desc") {
              return (b.tasks_todo || 0) - (a.tasks_todo || 0);
          }

          if (currentSort === "age_desc") {
              const parseAge = s => {
                if (!s) return 0;
                const parts = s.split(",");
                const years = parseInt(parts[0]) || 0;
                const months = parseInt(parts[1]) || 0;
                return years * 12 + months;
              };
              return parseAge(b.age_human) - parseAge(a.age_human);
          }

          return 0;
        });
    }


    // --- TEMPLATE dâ€™une ligne ---
    function itemHtml(c) {

      const img = c.photo
        ? `<img src="/uploads/${c.photo}" class="rounded me-3" style="width:48px;height:48px;object-fit:cover;">`
        : `<span class="me-3 rounded bg-secondary d-inline-block" style="width:48px;height:48px;"></span>`;

      const fiv = c.fiv ? `<span class="badge bg-danger ms-2">FIV+</span>` : "";
      const needVet = c.need_vet ? `<span class="badge bg-warning text-dark ms-2">Besoin vÃ©to</span>` : "";

      const tasks = c.tasks_todo || 0;
      const taskBadge = tasks > 0
          ? `<span class="badge bg-primary ms-2">${tasks} tÃ¢che(s)</span>`
          : `<span class="badge bg-secondary ms-2">0 tÃ¢che</span>`;

      const lastMod = c.last_update || "â€”";
      const status = c.status || "â€”";
      const age = c.age_human || "â€”";

      const href = `/cats/${c.id}`;

      return `
<a href="${href}" class="list-group-item list-group-item-action d-flex align-items-center py-3">

  ${img}

  <div class="flex-grow-1">
    <div class="fw-semibold">
        ${c.name}
        ${fiv} ${needVet}
    </div>

    <div class="text-muted small d-flex align-items-center flex-wrap">
      <span>
          Ã‚ge : ${age}
          | Statut : <strong>${status}</strong>
          | ModifiÃ© : ${lastMod}
      </span>

      <span class="ms-3">
          ${taskBadge}
      </span>
    </div>
  </div>

</a>
`;
    }


    // --------------------------
    //        RENDER
    // --------------------------
    async function render(q="") {
      const data = await fetchCats(q);
      const sorted = sortCats(data);
      const box = document.getElementById('cats-list');
      box.innerHTML = sorted.map(itemHtml).join("");
    }


    // --- Ã‰VÃˆNEMENTS ---
    document.getElementById('q')
      .addEventListener('input', (e)=> render(e.target.value.trim()));

    document.addEventListener('DOMContentLoaded', ()=> render(""));


    // --- Ã‰vÃ¨nements TRI ---
    document.querySelectorAll(".sort-option").forEach(el => {
        el.addEventListener("click", e => {
            e.preventDefault();

            // Nouveau mode de tri
            currentSort = el.dataset.sort;

            // Mise Ã  jour du label bouton
            const label = el.textContent.replace("âœ”", "").trim();
            document.getElementById("current-sort-label").textContent = label;

            // Mise Ã  jour coche
            document.querySelectorAll(".sort-option").forEach(opt => {
                opt.classList.remove("active");
                opt.textContent = opt.textContent.replace("âœ”", "");
            });
            el.classList.add("active");
            el.textContent = label + " âœ”";

            // RÃ©afficher
            render(document.getElementById('q').value.trim());
        });
    });

    </script>

  </div>




  <!-- ============================
       ONGLET 2 : AJOUT CHAT
      ============================ -->
  <div class="tab-pane fade" id="pane-add" role="tabpanel">

    <div class="card p-4">

      <form action="{{ url_for('api_cats') }}" method="POST" enctype="multipart/form-data">
        
        <div class="mb-3">
          <label class="form-label fw-semibold">Nom du chat</label>
          <input type="text" name="name" class="form-control" required>
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold">Date de naissance</label>
          <input type="date" name="birthdate">
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold">Genre</label>
          <select name="gender" class="form-select">
            <option value="M">MÃ¢le</option>
            <option value="F">Femelle</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold">Statut</label>
          <select name="status" class="form-select">
            <option value="normal">Normal</option>
            <option value="Ã  adopter">Ã€ adopter</option>
            <option value="quarantaine">Quarantaine</option>
            <option value="soins">Soins</option>
          </select>
        </div>

        <!-- ðŸ”µ AJOUT â€” NumÃ©ro d'identification -->
        <div class="mb-3">
          <label class="form-label fw-semibold">NumÃ©ro d'identification</label>
          <input type="text" name="identification_number" class="form-control">
        </div>

        <!-- ðŸ”µ AJOUT â€” Date dâ€™entrÃ©e au refuge -->
        <div class="mb-3">
          <label class="form-label fw-semibold">Date d'entrÃ©e au refuge</label>
          <input type="date" name="entry_date" class="form-control">
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold">Photo</label>
          <input type="file" name="photo" class="form-control">
        </div>

        <button class="btn btn-primary px-4">Ajouter</button>

      </form>

    </div>

  </div>

</div>

{% endblock %}
