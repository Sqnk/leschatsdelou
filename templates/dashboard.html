{% extends "base.html" %}
{% block content %}

<div class="container my-4">

    <h1 class="mb-4">Tableau de bord</h1>

    <!-- CARTES STATISTIQUES -->
    <div class="row mb-4 g-3">

        <div class="col-6 col-md-2">
            <div class="card shadow-sm text-center p-3">
                <h5>Chats</h5>
                <p class="display-6">{{ total_cats }}</p>
            </div>
        </div>

        <div class="col-6 col-md-2">
            <div class="card shadow-sm text-center p-3">
                <h5>Rendez-vous</h5>
                <p class="display-6">{{ total_appointments }}</p>
            </div>
        </div>

        <div class="col-6 col-md-2">
            <div class="card shadow-sm text-center p-3 border-danger">
                <h5>Vaccins en retard</h5>
                <p class="display-6 text-danger">{{ vaccines_late_count }}</p>
            </div>
        </div>

        <div class="col-6 col-md-2">
            <div class="card shadow-sm text-center p-3 border-warning">
                <h5>Vaccins à prévoir</h5>
                <p class="display-6 text-warning">{{ vaccines_due_count }}</p>
            </div>
        </div>

        <!-- ⭐ 5e CARTE AVEC VARIABLE CORRECTE -->
        <div class="col-6 col-md-2">
            <div class="card shadow-sm text-center p-3 border-primary">
                <h5>Tâches à faire</h5>
                <p class="display-6 text-primary">{{ tasks_pending_count }}</p>
            </div>
        </div>

    </div>

    <!-- LISTE DES VACCINS -->
    <h3 class="mt-4">Vaccins à prévoir / en retard</h3>

    <div class="card mb-4 shadow-sm">
        <div class="card-body">

            {% if vaccines_due %}
                <ul class="list-group list-group-flush">

                    {% for v in vaccines_due %}
                        <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap">

                            <div class="mb-2">
                                <strong>{{ v.cat.name }}</strong><br>
                                <small class="text-muted">{{ v.vaccine.name }}</small>
                            </div>

                            <div class="text-end">
                                <small>Dernier : <strong>{{ v.last_date.strftime("%d/%m/%Y") }}</strong></small><br>
                                <small>Prochain : <strong>{{ v.next_due.strftime("%d/%m/%Y") }}</strong></small><br>

                                {% if v.status == "late" %}
                                    <span class="badge bg-danger mt-1">En retard ({{ v.days_left }})</span>
                                {% else %}
                                    <span class="badge bg-warning text-dark mt-1">Dans {{ v.days_left }} jours</span>
                                {% endif %}
                            </div>

                        </li>
                    {% endfor %}

                </ul>
            {% else %}
                <p class="text-muted">Aucun vaccin à gérer.</p>
            {% endif %}

        </div>
    </div>

    <!-- CALENDRIER -->
    <h3 class="mt-4">Calendrier des rendez-vous</h3>
    <div id="calendar" class="mt-3"></div>

</div>

<!-- FullCalendar -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    let calendarEl = document.getElementById("calendar");

    let tooltip = null;

    let calendar = new FullCalendar.Calendar(calendarEl, {

        initialView: window.innerWidth < 768 ? "listWeek" : "dayGridMonth",
        locale: "fr",
        height: "auto",
        events: "/api/appointments",

        eventClick(info) {
            window.location.href = "/appointments";
        },

        eventMouseEnter(info) {
            let data = info.event.extendedProps;

            let cats = data.cats ? data.cats : "—";
            let employees = data.employees ? data.employees : "—";
            let location = data.location ? data.location : "—";

            tooltip = document.createElement("div");
            tooltip.className = "fc-tooltip";
            tooltip.innerHTML = `
                <strong>${info.event.start.toLocaleString("fr-FR")}</strong><br>
                <strong>Lieu :</strong> ${location}<br>
                <strong>Chats :</strong> ${cats}<br>
                <strong>Employés :</strong> ${employees}
            `;

            document.body.appendChild(tooltip);

            tooltip.style.position = "absolute";
            tooltip.style.background = "#333";
            tooltip.style.color = "white";
            tooltip.style.padding = "8px 12px";
            tooltip.style.borderRadius = "6px";
            tooltip.style.fontSize = "0.85rem";
            tooltip.style.pointerEvents = "none";
            tooltip.style.zIndex = "9999";

            function moveTooltip(e) {
                tooltip.style.top = (e.pageY + 15) + "px";
                tooltip.style.left = (e.pageX + 15) + "px";
            }

            document.addEventListener("mousemove", moveTooltip);

            info.event._tooltipMove = moveTooltip;
        },

        eventMouseLeave(info) {
            if (tooltip) {
                tooltip.remove();
                tooltip = null;
            }

            if (info.event._tooltipMove) {
                document.removeEventListener("mousemove", info.event._tooltipMove);
                delete info.event._tooltipMove;
            }
        },

        windowResize() {
            if (window.innerWidth < 768) {
                calendar.changeView("listWeek");
            } else {
                calendar.changeView("dayGridMonth");
            }
        }
    });

    calendar.render();
});
</script>

<style>
#calendar {
    border-radius: 16px;
    background: #fff;
    box-shadow: 0 3px 10px rgba(0,0,0,0.07);
    padding: 20px;
}

.fc-tooltip {
    background: rgba(30, 30, 30, 0.95);
    color: white;
    font-size: 0.8rem;
    padding: 8px 12px;
    border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

.fc .fc-toolbar {
    flex-wrap: wrap;
    gap: 10px;
}
.fc .fc-toolbar-title {
    font-weight: 600;
}
.fc-event {
    background: #6a8bff !important;
    color: white !important;
    border-radius: 8px;
}
.fc-day-today {
    background: #eef3ff !important;
    border: 1px solid #c8d5ff !important;
}

@media (max-width: 768px) {
    #calendar { padding: 10px; }
    .fc .fc-toolbar-title { font-size: 1.1rem; }
}
</style>

{% endblock %}
