{% extends "base.html" %}
{% block content %}

<div class="container mt-4">

    <h1 class="mb-4">Tableau de bord</h1>

    <!-- Cartes du haut -->
    <div class="row g-3 mb-4">

        <!-- Chats -->
        <div class="col-6 col-md-3">
            <div class="dashboard-card border-primary">
                <div class="title">Chats</div>
                <div class="value">{{ total_cats }}</div>
            </div>
        </div>

        <!-- Rendez-vous -->
        <div class="col-6 col-md-3">
            <div class="dashboard-card border-secondary">
                <div class="title">Rendez-vous</div>
                <div class="value">{{ total_appointments }}</div>
            </div>
        </div>

        <!-- Vaccins en retard -->
        <div class="col-6 col-md-3">
            <div class="dashboard-card border-danger">
                <div class="title">Vaccins en retard</div>
                <div class="value text-danger">{{ vaccines_late_count }}</div>
            </div>
        </div>

        <!-- Vaccins à prévoir -->
        <div class="col-6 col-md-3">
            <div class="dashboard-card border-warning">
                <div class="title">Vaccins à prévoir</div>
                <div class="value text-warning">{{ vaccines_due_count }}</div>
            </div>
        </div>

        <!-- Tâches à faire -->
        <div class="col-6 col-md-3">
            <div class="dashboard-card border-info">
                <div class="title">Tâches à faire</div>
                <div class="value text-info">{{ tasks_pending_count }}</div>
            </div>
        </div>

    </div>

    <!-- === SECTIONS EN 2 COLONNES 50% / 50% === -->
    <div class="row mt-4">

        <!-- ========================= -->
        <!-- COLONNE GAUCHE : VACCINS -->
        <!-- ========================= -->
        <div class="col-md-6">
            <h4 class="mb-3">Vaccins à prévoir / en retard</h4>

            {% if vaccines_due %}
                {% for v in vaccines_due %}
                <div class="vaccin-item p-3 mb-3">
                    <strong>{{ v.cat.name }}</strong><br>
                    <span class="text-muted">{{ v.vaccine.name }}</span>

                    <div class="small mt-2">
                        Dernier : <strong>{{ v.last_date.strftime("%d/%m/%Y") }}</strong><br>
                        Prochain : <strong>{{ v.next_due.strftime("%d/%m/%Y") }}</strong>
                    </div>

                    {% if v.status == "late" %}
                        <span class="badge bg-danger mt-2">En retard</span>
                    {% else %}
                        <span class="badge bg-warning text-dark mt-2">
                            Dans {{ v.days_left }} jours
                        </span>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <p class="text-muted">Aucun vaccin imminent.</p>
            {% endif %}
        </div>
       <!-- ======================== -->
<!-- COLONNE DROITE : TÂCHES -->
<!-- ======================== -->
<div class="col-md-6">
    <h4 class="mb-3">Tâches à faire</h4>

    {% with all_tasks = namespace(list=[]) %}
        {% for cat in cats %}
            {% for t in cat.tasks %}
                {% if not t.is_done %}
                    {% set _ = all_tasks.list.append(t) %}
                {% endif %}
            {% endfor %}
        {% endfor %}

        {% if all_tasks.list %}
            {% for t in all_tasks.list %}
            <div class="task-item p-3 mb-3">

                <strong>{{ t.cat.name }}</strong><br>
                <span class="text-muted">{{ t.task_type.name }}</span>

                {% if t.note %}
                <div class="small text-muted mt-1">
                    {{ t.note|safe }}
                </div>
                {% endif %}

                {% if t.due_date %}
                <div class="badge bg-warning text-dark mt-2">
                    À faire avant le {{ t.due_date.strftime("%d/%m/%Y") }}
                </div>
                {% endif %}

            </div>
            {% endfor %}
        {% else %}
            <p class="text-muted">Aucune tâche en attente.</p>
        {% endif %}
    {% endwith %}
</div>

    </div> <!-- fin row -->

</div> <!-- fin container -->

<style>
.dashboard-card {
    border-radius: 15px;
    padding: 15px;
    text-align: center;
    background: #fff;
    border: 2px solid;
}
.dashboard-card .title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 8px;
}
.dashboard-card .value {
    font-size: 2rem;
    font-weight: bold;
}

.vaccin-item, .task-item {
    border-radius: 12px;
    background: #fff;
    border: 1px solid #ddd;
}
</style>
<script>
document.addEventListener("DOMContentLoaded", function () {

    // ----------- FULLCALENDAR (inchangé) ------------

    var calendarEl = document.getElementById('calendar-dashboard');
    if (calendarEl) {

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'fr',
            height: 650,
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            eventSources: [
                {
                    url: '/api/appointments',
                    method: 'GET',
                    failure: function () {
                        alert("Erreur de chargement du calendrier.");
                    }
                }
            ],
            eventDidMount: function (info) {
                if (info.event.extendedProps.tooltip) {
                    info.el.setAttribute("title", info.event.extendedProps.tooltip);
                }
            }
        });

        calendar.render();
    }
});
</script>

{% endblock %}
