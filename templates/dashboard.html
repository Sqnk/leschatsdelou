{% extends "base.html" %}
{% block content %}

<div class="container my-4">

    <h1 class="mb-4">Tableau de bord</h1>

    <!-- CARTES STATISTIQUES -->
    <div class="row mb-4 g-3">

        <div class="col-6 col-md-3">
            <div class="card shadow-sm text-center p-3">
                <h5>Chats</h5>
                <p class="display-6">{{ total_cats }}</p>
            </div>
        </div>

        <div class="col-6 col-md-3">
            <div class="card shadow-sm text-center p-3">
                <h5>Rendez-vous</h5>
                <p class="display-6">{{ total_appointments }}</p>
            </div>
        </div>

        <div class="col-6 col-md-3">
            <div class="card shadow-sm text-center p-3 border-danger">
                <h5>Vaccins en retard</h5>
                <p class="display-6 text-danger">{{ vaccines_late_count }}</p>
            </div>
        </div>

        <div class="col-6 col-md-3">
            <div class="card shadow-sm text-center p-3 border-warning">
                <h5>Vaccins à prévoir</h5>
                <p class="display-6 text-warning">{{ vaccines_due_count }}</p>
            </div>
        </div>

    </div>

    <!-- LISTE DES VACCINS -->
    <h3 class="mt-4">Vaccins à prévoir / en retard</h3>

    <div class="card mb-4 shadow-sm">
        <div class="card-body">

            {% if vaccines_due %}
                <ul class="list-group list-group-flush">

                    {% for v in vaccines_due %}
                        <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap">

                            <div class="mb-2">
                                <strong>{{ v.cat.name }}</strong><br>
                                <small class="text-muted">{{ v.vaccine.name }}</small>
                            </div>

                            <div class="text-end">
                                <small>Dernier : <strong>{{ v.last_date.strftime("%d/%m/%Y") }}</strong></small><br>
                                <small>Prochain : <strong>{{ v.next_due.strftime("%d/%m/%Y") }}</strong></small><br>

                                {% if v.status == "late" %}
                                    <span class="badge bg-danger mt-1">En retard ({{ v.days_left }})</span>
                                {% else %}
                                    <span class="badge bg-warning text-dark mt-1">Dans {{ v.days_left }} jours</span>
                                {% endif %}
                            </div>

                        </li>
                    {% endfor %}

                </ul>
            {% else %}
                <p class="text-muted">Aucun vaccin à gérer.</p>
            {% endif %}

        </div>
    </div>

    <!-- CALENDRIER -->
    <h3 class="mt-4">Calendrier des rendez-vous</h3>
    <div id="calendar" class="mt-3"></div>

</div>

<!-- FullCalendar -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    let calendarEl = document.getElementById("calendar");

    let calendar = new FullCalendar.Calendar(calendarEl, {

        initialView: window.innerWidth < 768 ? "listWeek" : "dayGridMonth",
        locale: "fr",
        height: "auto",
        events: "/api/appointments",

        eventClick(info) {
            window.location.href = "/appointments";
        },

        windowResize() {
            if (window.innerWidth < 768) {
                calendar.changeView("listWeek");
            } else {
                calendar.changeView("dayGridMonth");
            }
        }
    });

    calendar.render();
});
</script>

<style>
#calendar {
    border-radius: 16px;
    background: #fff;
    box-shadow: 0 3px 10px rgba(0,0,0,0.07);
    padding: 20px;
}

/* MATCH calendrier.html */
.fc .fc-toolbar {
    flex-wrap: wrap;
    gap: 10px;
}
.fc .fc-toolbar-title {
    font-weight: 600;
}
.fc-event {
    background: #6a8bff !important;
    color: white !important;
    border-radius: 8px;
}
.fc-day-today {
    background: #eef3ff !important;
    border: 1px solid #c8d5ff !important;
}

@media (max-width: 768px) {
    #calendar { padding: 10px; }
    .fc .fc-toolbar-title { font-size: 1.1rem; }
}
</style>

{% endblock %}
