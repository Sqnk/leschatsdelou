{% extends "base.html" %}
{% block content %}

<div class="container mt-4">

    <a href="{{ url_for('recherche') }}" class="btn btn-secondary mb-3">Retour</a>

    <div class="d-flex justify-content-between align-items-center">
        <h1>{{ cat.name }}</h1>

        <!-- BOUTON SUPPRESSION DU CHAT -->
        <form action="{{ url_for('delete_cat', cat_id=cat.id) }}" method="POST"
              onsubmit="return confirm('Supprimer dÃ©finitivement ce chat ?');">
            <button class="btn btn-danger">ðŸ—‘ Supprimer</button>
        </form>
    </div>

    <!-- Photo -->
    {% if cat.photo_filename %}
        <img src="{{ url_for('uploads', filename=cat.photo_filename) }}"
             class="img-fluid mb-3"
             style="max-width:250px; border-radius:8px;">
    {% endif %}

    <!-- Infos -->
    <p><strong>Statut :</strong> {{ cat.status or "â€”" }} </p>
    <p><strong>Date de naissance :</strong>
        {% if cat.birthdate %}
            {{ cat.birthdate.strftime('%d/%m/%Y') }} ({{ age_text(cat.birthdate) }})
        {% else %}
            â€” 
        {% endif %}
    </p>

    <!-- Modifier statut -->
    <h4 class="mt-4">Modifier le statut</h4>
    <form action="{{ url_for('update_cat_status', cat_id=cat.id) }}" method="POST" class="row g-2 mb-4">
        <div class="col-auto">
            <select name="status" class="form-select">
                {% set statuses = ["normal", "Ã  adopter", "adoptÃ©", "quarantaine", "soins", "dÃ©cÃ©dÃ©"] %}
                {% for s in statuses %}
                    <option value="{{ s }}" {% if cat.status == s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary">Enregistrer</button>
        </div>
    </form>

    <hr>

    <!-- VACCINATIONS -->
    <h3 class="mt-4">Vaccinations</h3>

    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Vaccin</th>
                <th>Date</th>
                <th>Lot</th>
                <th>VÃ©tÃ©rinaire</th>
                <th>RÃ©action</th>
            </tr>
        </thead>
        <tbody>
            {% for v in vaccs %}
            <tr>
                <td>{{ v.vaccine_type.name }}</td>
                <td>{{ v.date.strftime('%d/%m/%Y') }}</td>
                <td>{{ v.lot or "â€”" }}</td>
                <td>{{ v.veterinarian or "â€”" }}</td>
                <td>{{ v.reaction or "â€”" }}</td>
            </tr>
            {% endfor %}
            {% if vaccs|length == 0 %}
            <tr><td colspan="5" class="text-center text-muted">Aucun vaccin enregistrÃ©</td></tr>
            {% endif %}
        </tbody>
    </table>

    <!-- Ajouter vaccin -->
    <h5>Ajouter une vaccination</h5>
    <form action="{{ url_for('add_vaccination', cat_id=cat.id) }}" method="POST" class="row g-2 mb-4">
        <div class="col-md-3">
            <select name="vaccine_type_id" class="form-select" required>
                <option value="">Choisir un vaccin</option>
                {% for v in vaccines %}
                    <option value="{{ v.id }}">{{ v.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <input type="date" name="date" class="form-control">
        </div>
        <div class="col-md-2">
            <input type="text" name="lot" class="form-control" placeholder="Lot">
        </div>
        <div class="col-md-2">
            <input type="text" name="veterinarian" class="form-control" placeholder="VÃ©tÃ©rinaire">
        </div>
        <div class="col-md-2">
            <input type="text" name="reaction" class="form-control" placeholder="RÃ©action">
        </div>
        <div class="col-md-1">
            <button class="btn btn-success">Ajouter</button>
        </div>
    </form>

    <hr>

    <!-- NOTES -->
    <h3 class="mt-4">Notes</h3>

    {% for n in notes %}
    <div class="border rounded p-3 mb-3">

        <div class="d-flex justify-content-between">
            <p>{{ n.content or "â€”" }}</p>

            <!-- Bouton supprimer note -->
            <form action="{{ url_for('delete_note', note_id=n.id) }}" method="POST"
                  onsubmit="return confirm('Supprimer cette note ?');">
                <button class="btn btn-sm btn-outline-danger">ðŸ—‘</button>
            </form>
        </div>

        {% if n.file_name %}
            <p>
                <a href="{{ url_for('uploads', filename=n.file_name) }}" target="_blank">
                    ðŸ“Ž Voir fichier
                </a>
            </p>
        {% endif %}

        <p class="text-muted">
            <strong>Auteur :</strong> {{ n.author or "â€”" }}<br>
            <strong>Date :</strong> {{ n.created_at.strftime('%d/%m/%Y %H:%M') }}
        </p>
    </div>
    {% endfor %}

    {% if notes|length == 0 %}
        <p class="text-muted">Aucune note.</p>
    {% endif %}

    <!-- Ajouter note -->
    <h5>Ajouter une note</h5>
    <form action="{{ url_for('add_note', cat_id=cat.id) }}" method="POST" enctype="multipart/form-data" class="mb-5">

        <div class="mb-2">
            <textarea name="content" class="form-control" rows="2" placeholder="Contenu de la note..."></textarea>
        </div>

        <div class="mb-2">
            <label class="form-label">Auteur :</label>
            <select name="author" class="form-select">
                <option value="">â€”</option>
                {% for e in employees %}
                    <option value="{{ e.name }}">{{ e.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label">Fichier :</label>
            <input type="file" name="file" class="form-control">
        </div>

        <button class="btn btn-primary">Ajouter la note</button>
    </form>

</div>

{% endblock %}
