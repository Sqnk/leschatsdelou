{% extends "base.html" %}
{% block content %}

<div class="container mt-4">

    <a href="{{ url_for('recherche') }}" class="btn btn-secondary mb-3">Retour</a>

    <div class="d-flex justify-content-between align-items-center">
        <h1>
            {{ cat.name }}
            {% if cat.sex == 'male' %}
                <span style="color:#2196F3; font-size:1.8rem; margin-left:8px;">â™‚</span>
            {% elif cat.sex == 'female' %}
                <span style="color:#E91E63; font-size:1.8rem; margin-left:8px;">â™€</span>
            {% endif %}

            <!-- â­ TAG FIV -->
            {% if cat.fiv %}
                <span class="badge bg-danger ms-2" style="font-size:1rem;">FIV+</span>
            {% endif %}
        </h1>

        <!-- BOUTON SUPPRESSION DU CHAT -->
        <form action="{{ url_for('delete_cat', cat_id=cat.id) }}" method="POST"
              onsubmit="return confirm('Supprimer dÃ©finitivement ce chat ?');">
            <button class="btn btn-danger">ðŸ—‘ Supprimer</button>
        </form>
    </div>

    <!-- TABS NAVIGATION -->
    <ul class="nav nav-tabs mt-4" id="catTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="infos-tab" data-bs-toggle="tab" data-bs-target="#infos"
                    type="button" role="tab">Infos</button>
        </li>

        <li class="nav-item" role="presentation">
            <button class="nav-link" id="vaccins-tab" data-bs-toggle="tab" data-bs-target="#vaccins"
                    type="button" role="tab">Vaccinations</button>
        </li>

        <li class="nav-item" role="presentation">
            <button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes"
                    type="button" role="tab">Notes</button>
        </li>
    </ul>

    <!-- TAB CONTENT -->
    <div class="tab-content mt-4" id="catTabsContent">

        <!-- â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  ONGLET INFOS  â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ -->
        <div class="tab-pane fade show active" id="infos" role="tabpanel">

            <!-- Photo -->
            {% if cat.photo_filename %}
                <img src="{{ url_for('uploads', filename=cat.photo_filename) }}"
                     class="img-fluid mb-3"
                     style="max-width:250px; border-radius:8px;">
            {% endif %}

            <!-- Infos -->
            <p><strong>Statut :</strong> {{ cat.status or "â€”" }} </p>

            <p><strong>Date de naissance :</strong>
                {% if cat.birthdate %}
                    {{ cat.birthdate.strftime('%d/%m/%Y') }} ({{ age_text(cat.birthdate) }})
                {% else %}
                    â€”
                {% endif %}
            </p>

            <!-- ðŸ§¬ FIV -->
            <p><strong>FIV :</strong> {% if cat.fiv %}Oui{% else %}Non{% endif %}</p>

            <!-- Modifier statut + FIV -->
            <h4 class="mt-4">Modifier les informations</h4>
            <form action="{{ url_for('update_cat_status', cat_id=cat.id) }}" method="POST" class="row g-2 mb-4">

                <div class="col-auto">
                    <select name="status" class="form-select">
                        {% set statuses = ["normal", "Ã  adopter", "adoptÃ©", "quarantaine", "soins", "dÃ©cÃ©dÃ©"] %}
                        {% for s in statuses %}
                            <option value="{{ s }}" {% if cat.status == s %} selected {% endif %}>{{ s }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Case Ã  cocher FIV -->
                <div class="col-auto d-flex align-items-center">
                    <label class="form-check-label me-2"><strong>FIV :</strong></label>
                    <input type="checkbox" name="fiv" class="form-check-input"
                           {% if cat.fiv %}checked{% endif %}>
                </div>

                <div class="col-auto">
                    <button class="btn btn-primary">Enregistrer</button>
                </div>
            </form>

            <hr>

            <!-- â–‘â–‘â–‘â–‘â–‘ 5 DERNIERES NOTES  â–‘â–‘â–‘â–‘â–‘ -->
            <h3 class="mt-4">DerniÃ¨res notes</h3>

            {% set last_notes = notes[:5] %}
            {% if last_notes %}
                {% for n in last_notes %}
                <div class="border rounded p-3 mb-3">
                    <div class="d-flex justify-content-between">
                        <p>{{ n.content or "â€”" }}</p>

                        <form action="{{ url_for('delete_note', note_id=n.id) }}" method="POST"
                              onsubmit="return confirm('Supprimer cette note ?');">
                            <button class="btn btn-sm btn-outline-danger">ðŸ—‘</button>
                        </form>
                    </div>

                    {% if n.file_name %}
                        <p>
                            <a href="{{ url_for('uploads', filename=n.file_name) }}" target="_blank">
                                ðŸ“Ž Voir fichier
                            </a>
                        </p>
                    {% endif %}

                    <p class="text-muted">
                        <strong>Auteur :</strong> {{ n.author or "â€”" }}<br>
                        <strong>Date :</strong> {{ n.created_at.strftime('%d/%m/%Y %H:%M') }}
                    </p>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-muted">Aucune note.</p>
            {% endif %}

            <!-- Ajouter note -->
            <h5 class="mt-4">Ajouter une note</h5>
            <form action="{{ url_for('add_note', cat_id=cat.id) }}" method="POST" enctype="multipart/form-data" class="mb-5">

                <div class="mb-2">
                    <textarea name="content" class="form-control" rows="2" placeholder="Contenu de la note..."></textarea>
                </div>

                <div class="mb-2">
                    <label class="form-label">Auteur :</label>
                    <select name="author" class="form-select">
                        <option value="">â€”</option>
                        {% for e in employees %}
                            <option value="{{ e.name }}">{{ e.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Fichier :</label>
                    <input type="file" name="file" class="form-control">
                </div>

                <button class="btn btn-primary">Ajouter la note</button>
            </form>

        </div>

        <!-- â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  ONGLET VACCINS  â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ -->
        <div class="tab-pane fade" id="vaccins" role="tabpanel">

            <h3 class="mt-3">Vaccinations</h3>

            <table class="table table-bordered mt-3">
                <thead>
                    <tr>
                        <th>Vaccin</th>
                        <th>Date</th>
                        <th>Lot</th>
                        <th>VÃ©tÃ©rinaire</th>
                        <th>RÃ©action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for v in vaccs %}
                    <tr>
                        <td>{{ v.vaccine_type.name }}</td>
                        <td>{{ v.date.strftime('%d/%m/%Y') }}</td>
                        <td>{{ v.lot or "â€”" }}</td>
                        <td>{{ v.veterinarian or "â€”" }}</td>
                        <td>{{ v.reaction or "â€”" }}</td>
                    </tr>
                    {% endfor %}
                    {% if vaccs|length == 0 %}
                    <tr><td colspan="5" class="text-center text-muted">Aucun vaccin enregistrÃ©</td></tr>
                    {% endif %}
                </tbody>
            </table>

            <!-- Ajouter vaccin -->
            <h5 class="mt-4">Ajouter une vaccination</h5>
            <form action="{{ url_for('add_vaccination', cat_id=cat.id) }}" method="POST" class="row g-2 mb-5">

                <div class="col-md-3">
                    <select name="vaccine_type_id" class="form-select" required>
                        <option value="">Choisir un vaccin</option>
                        {% for v in vaccines %}
                            <option value="{{ v.id }}">{{ v.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-2">
                    <input type="date" name="date" class="form-control">
                </div>

                <div class="col-md-2">
                    <input type="text" name="lot" class="form-control" placeholder="Lot">
                </div>

                <div class="col-md-2">
                    <select name="veterinarian" class="form-select">
                        <option value="">VÃ©tÃ©rinaire</option>
                        {% for vet in veterinarians %}
                            <option value="{{ vet.name }}">{{ vet.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-2">
                    <input type="text" name="reaction" class="form-control" placeholder="RÃ©action">
                </div>

                <div class="col-md-1">
                    <button class="btn btn-success">Ajouter</button>
                </div>

            </form>

        </div>

        <!-- â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  ONGLET NOTES COMPLETES  â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ -->
        <div class="tab-pane fade" id="notes" role="tabpanel">

            <h3 class="mt-3">Toutes les notes</h3>

            {% for n in notes %}
            <div class="border rounded p-3 mb-3">

                <div class="d-flex justify-content-between">
                    <p>{{ n.content or "â€”" }}</p>

                    <form action="{{ url_for('delete_note', note_id=n.id) }}" method="POST"
                          onsubmit="return confirm('Supprimer cette note ?');">
                        <button class="btn btn-sm btn-outline-danger">ðŸ—‘</button>
                    </form>
                </div>

                {% if n.file_name %}
                    <p>
                        <a href="{{ url_for('uploads', filename=n.file_name) }}" target="_blank">
                            ðŸ“Ž Voir fichier
                        </a>
                    </p>
                {% endif %}

                <p class="text-muted">
                    <strong>Auteur :</strong> {{ n.author or "â€”" }}<br>
                    <strong>Date :</strong> {{ n.created_at.strftime('%d/%m/%Y %H:%M') }}
                </p>

            </div>
            {% endfor %}

            {% if notes|length == 0 %}
                <p class="text-muted">Aucune note.</p>
            {% endif %}

            <!-- Ajouter note (onglet Notes) -->
            <h5 class="mt-4">Ajouter une note</h5>
            <form action="{{ url_for('add_note', cat_id=cat.id) }}" method="POST" enctype="multipart/form-data" class="mb-5">

                <div class="mb-2">
                    <textarea name="content" class="form-control" rows="2" placeholder="Contenu de la note..."></textarea>
                </div>

                <div class="mb-2">
                    <label class="form-label">Auteur :</label>
                    <select name="author" class="form-select">
                        <option value="">â€”</option>
                        {% for e in employees %}
                            <option value="{{ e.name }}">{{ e.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Fichier :</label>
                    <input type="file" name="file" class="form-control">
                </div>

                <button class="btn btn-primary">Ajouter la note</button>
            </form>

        </div>

    </div><!-- / tab content -->

</div>

{% endblock %}
