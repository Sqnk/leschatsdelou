{% extends "base.html" %}
{% block content %}

<style>
.cat-photo {
    width: 180px;
    height: auto;
    border-radius: 8px;
    object-fit: cover;
}
@media (max-width: 768px) {
    .cat-photo {
        width: 140px;
    }
}
.content-wrapper {
  width: 100%;
  padding-right: 20px;
}
</style>

<div class="mt-3" style="max-width: 100% !important;">
  <div class="row">
    <!-- Colonne gauche : fiche du chat -->
    <div class="col-md-3 mb-4">
      <div class="d-flex flex-column align-items-center align-items-md-start">
        {% if cat.photo_filename %}
        <img src="{{ url_for('uploads', filename=cat.photo_filename) }}" class="cat-photo mb-3">
        {% endif %}

        <h2 class="mb-2 text-center text-md-start">
          {{ cat.name }}
          {% if cat.sex == 'male' %}
            <span style="color:#2196F3; font-size:1.6rem; margin-left:4px;">â™‚</span>
          {% elif cat.sex == 'female' %}
            <span style="color:#E91E63; font-size:1.6rem; margin-left:4px;">â™€</span>
          {% endif %}
        </h2>

        <p class="mb-1"><strong>Statut :</strong> {{ cat.status or "â€”" }}</p>

        <p class="mb-1"><strong>Date de naissance :</strong>
          {% if cat.birthdate %}
            {{ cat.birthdate.strftime('%d/%m/%Y') }} ({{ age_text(cat.birthdate) }})
          {% else %}
            â€”
          {% endif %}
        </p>

        <p class="mb-1"><strong>NumÃ©ro d'identification :</strong> {{ cat.identification_number or "â€”" }}</p>

        <p class="mb-3"><strong>Date d'entrÃ©e au refuge :</strong>
          {% if cat.entry_date %}
            {{ cat.entry_date.strftime('%d/%m/%Y') }}
          {% else %}
            â€”
          {% endif %}
        </p>

        <div class="mb-3">
          {% if cat.fiv %}
          <span class="btn btn-danger btn-sm me-2">FIV+</span>
          {% endif %}
          {% if cat.need_vet %}
          <span class="btn btn-warning btn-sm">Besoin vÃ©to</span>
          {% endif %}
        </div>

        <div class="d-grid gap-2 w-100">
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editCatModal">Modifier</button>
          <a href="{{ url_for('recherche') }}" class="btn btn-secondary">Retour</a>
          <button class="btn btn-danger"
                  data-bs-toggle="modal" data-bs-target="#deleteConfirmModal">
            ðŸ—‘ Supprimer
          </button>
        </div>
      </div>
    </div>

    <!-- Colonne droite : onglets et contenu -->
    <div class="col-md-9">
    <!-- ONGLET BAR -->
    <ul class="nav nav-tabs" id="catTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="infos-tab" data-bs-toggle="tab"
                    data-bs-target="#infos" type="button" role="tab">Infos</button>
        </li>

        <li class="nav-item" role="presentation">
            <button class="nav-link" id="vaccins-tab" data-bs-toggle="tab"
                    data-bs-target="#vaccins" type="button" role="tab">Vaccinations</button>
        </li>

        <li class="nav-item" role="presentation">
            <button class="nav-link" id="notes-tab" data-bs-toggle="tab"
                    data-bs-target="#notes" type="button" role="tab">Notes</button>
        </li>

        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tasks-tab" data-bs-toggle="tab"
                    data-bs-target="#tasks" type="button" role="tab">TÃ¢ches</button>
        </li>
    </ul>


    <!-- â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ INFOS â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ -->
    <div class="tab-content mt-4">

        <div class="tab-pane fade show active" id="infos" role="tabpanel">

            <!-- DerniÃ¨res notes -->
            <h3>DerniÃ¨res notes</h3>

            {% set last_notes = notes[:5] %}
            {% if last_notes %}
                {% for n in last_notes %}
                <div class="border rounded p-3 mb-3">
                    <div class="d-flex justify-content-between">
                        <p>{{ n.content or "â€”" }}</p>

                        <form action="{{ url_for('delete_note', note_id=n.id) }}"
                              method="POST"
                              onsubmit="return confirm('Supprimer cette note ?');">
                            <button class="btn btn-sm btn-outline-danger">ðŸ—‘</button>
                        </form>
                    </div>

                    {% if n.file_name %}
                        {% set ext = n.file_name.split('.')[-1].lower() %}
                        {% if ext in ['jpg','jpeg','png','gif','webp'] %}
                            <p><img src="{{ url_for('uploads', filename=n.file_name) }}"
                                    style="max-width:140px; border-radius:6px;"></p>
                        {% else %}
                            <p><a href="{{ url_for('uploads', filename=n.file_name) }}"
                                  target="_blank">ðŸ“Ž Voir fichier</a></p>
                        {% endif %}
                    {% endif %}

                    <p class="text-muted">
                        <strong>Auteur :</strong> {{ n.author or "â€”" }}<br>
                        <strong>Date :</strong> {{ n.created_at.strftime('%d/%m/%Y %H:%M') }}
                    </p>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-muted">Aucune note.</p>
            {% endif %}


            <!-- TÃ¢ches Ã  effectuer -->
            <h3 class="mt-4">TÃ¢ches Ã  effectuer</h3>

            {% set todo = tasks|selectattr("is_done", "equalto", False)|list %}
            {% if todo %}
                <table class="table table-bordered mt-3">
                    <thead>
                        <tr>
                            <th>TÃ¢che</th>
                            <th>Note</th>
                            <th>AjoutÃ©e le</th>
                            <th>Ã‰chÃ©ance</th>
                            <th>Statut</th>
                            <th>Fait par</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for t in todo %}
                        <tr>
                            <td>{{ t.task_type.name }}</td>
                            <td>{{ t.note or "â€”" }}</td>
                            <td>{{ t.created_at.strftime('%d/%m/%Y') }}</td>
                            <td>
                                {% if t.due_date %}
                                    {{ t.due_date.strftime('%d/%m/%Y') }}
                                {% else %}â€”{% endif %}
                            </td>

                            <td><span class="badge bg-warning text-dark">Ã€ faire</span></td>

                            <td>
                                <select class="form-select form-select-sm done-by-select">
                                    <option value="">â€”</option>
                                    {% for e in employees %}
                                        <option value="{{ e.name }}">{{ e.name }}</option>
                                    {% endfor %}
                                </select>
                            </td>

                            <td>
                                <form action="{{ url_for('toggle_cat_task',
                                           cat_id=cat.id, task_id=t.id) }}"
                                      method="POST" class="toggle-form d-inline">
                                    <input type="hidden" name="done_by" value="">
                                    <button class="btn btn-sm btn-outline-primary validate-btn" disabled>
                                        âœ“ Fait
                                    </button>
                                </form>

                                <form action="{{ url_for('delete_cat_task',
                                           cat_id=cat.id, task_id=t.id) }}"
                                      method="POST" class="d-inline"
                                      onsubmit="return confirm('Supprimer cette tÃ¢che ?');">
                                    <button class="btn btn-sm btn-outline-danger">ðŸ—‘</button>
                                </form>
                            </td>

                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p class="text-muted">Aucune tÃ¢che Ã  effectuer.</p>
            {% endif %}

            <hr class="my-4">

        </div>

        <!-- â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ VACCINS â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ -->
        <div class="tab-pane fade" id="vaccins" role="tabpanel">

            <h3 class="mt-3">Vaccinations</h3>
            <table class="table table-bordered mt-3">
                <thead>
                    <tr>
                        <th>Vaccin</th>
                        <th>Date</th>
                        <th>Lot</th>
                        <th>VÃ©tÃ©rinaire</th>
                        <th>RÃ©action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for v in vaccs %}
                    <tr>
                        <td>{{ v.vaccine_type.name }}</td>
                        <td>{{ v.date.strftime('%d/%m/%Y') }}</td>
                        <td>{{ v.lot or "â€”" }}</td>
                        <td>{{ v.veterinarian or "â€”" }}</td>
                        <td>{{ v.reaction or "â€”" }}</td>
                    </tr>
                    {% endfor %}
                    {% if vaccs|length == 0 %}
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            Aucun vaccin enregistrÃ©
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>

            <h5 class="mt-4">Ajouter une vaccination</h5>
            <form action="{{ url_for('add_vaccination', cat_id=cat.id) }}"
                  method="POST" class="row g-2 mb-5">

                <div class="col-md-3">
                    <select name="vaccine_type_id" class="form-select" required>
                        <option value="">Choisir un vaccin</option>
                        {% for v in vaccines %}
                            <option value="{{ v.id }}">{{ v.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-2">
                    <input type="date" name="date" class="form-control">
                </div>

                <div class="col-md-2">
                    <input type="text" name="lot" class="form-control" placeholder="Lot">
                </div>

                <div class="col-md-2">
                    <select name="veterinarian" class="form-select">
                        <option value="">VÃ©tÃ©rinaire</option>
                        {% for vet in veterinarians %}
                            <option value="{{ vet.name }}">{{ vet.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-2">
                    <input type="text" name="reaction" class="form-control" placeholder="RÃ©action">
                </div>

                <div class="col-md-1">
                    <button class="btn btn-success">Ajouter</button>
                </div>

            </form>

        </div>

        <!-- â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ NOTES â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ -->
        <div class="tab-pane fade" id="notes" role="tabpanel">

            <h3 class="mt-3">Toutes les notes</h3>

            {% for n in notes %}
            <div class="border rounded p-3 mb-3">
                <div class="d-flex justify-content-between">
                    <p>{{ n.content or "â€”" }}</p>

                    <form action="{{ url_for('delete_note', note_id=n.id) }}"
                          method="POST"
                          onsubmit="return confirm('Supprimer cette note ?');">
                        <button class="btn btn-sm btn-outline-danger">ðŸ—‘</button>
                    </form>
                </div>

                {% if n.file_name %}
                    {% set ext = n.file_name.split('.')[-1].lower() %}
                    {% if ext in ['jpg','jpeg','png','gif','webp'] %}
                        <p><img src="{{ url_for('uploads', filename=n.file_name) }}"
                                style="max-width:140px; border-radius:6px;"></p>
                    {% else %}
                        <p><a href="{{ url_for('uploads', filename=n.file_name) }}"
                              target="_blank">ðŸ“Ž Voir fichier</a></p>
                    {% endif %}
                {% endif %}

                <p class="text-muted">
                    <strong>Auteur :</strong> {{ n.author or "â€”" }}<br>
                    <strong>Date :</strong> {{ n.created_at.strftime('%d/%m/%Y %H:%M') }}
                </p>
            </div>
            {% endfor %}
            {% if notes|length == 0 %}
                <p class="text-muted">Aucune note.</p>
            {% endif %}

            <h5 class="mt-4">Ajouter une note</h5>

            <form action="{{ url_for('add_note', cat_id=cat.id) }}" method="POST"
                  enctype="multipart/form-data" class="mb-5">

                <div class="mb-2">
                    <textarea name="content" class="form-control" rows="2"
                              placeholder="Contenu de la note..."></textarea>
                </div>

                <div class="mb-2">
                    <label class="form-label">Auteur :</label>
                    <select name="author" class="form-select">
                        <option value="">â€”</option>
                        {% for e in employees %}
                            <option value="{{ e.name }}">{{ e.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Fichier :</label>
                    <input type="file" name="file" class="form-control">
                </div>

                <button class="btn btn-primary">Ajouter la note</button>

            </form>

        </div>

        <!-- â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ TÃ‚CHES â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ -->
        <div class="tab-pane fade" id="tasks" role="tabpanel">

            <h3 class="mt-3">Ajouter une tÃ¢che</h3>

            <form action="{{ url_for('create_cat_task', cat_id=cat.id) }}"
                  method="POST" class="row g-3 mt-2 mb-4">

                <div class="col-md-4">
                    <label class="form-label">Type de tÃ¢che</label>
                    <select name="task_type_id" class="form-select" required>
                        <option value="">â€” Choisir une tÃ¢che â€”</option>
                        {% for tt in task_types %}
                            <option value="{{ tt.id }}">{{ tt.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Note</label>
                    <input type="text" name="note" class="form-control"
                           placeholder="DÃ©tails, consigne...">
                </div>

                <div class="col-md-3">
                    <label class="form-label">Date d'Ã©chÃ©ance</label>
                    <input type="date" name="due_date" class="form-control">
                </div>

                <div class="col-md-1 d-flex align-items-end">
                    <button class="btn btn-success w-100">Ajouter</button>
                </div>
            </form>

            <hr>

            <h3 class="mt-4">TÃ¢ches Ã  effectuer</h3>

            {% if todo %}
                <table class="table table-bordered mt-3">
                    <thead>
                        <tr>
                            <th>TÃ¢che</th>
                            <th>Note</th>
                            <th>AjoutÃ©e le</th>
                            <th>Ã‰chÃ©ance</th>
                            <th>Statut</th>
                            <th>Fait par</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>

                        {% for t in todo %}
                        <tr>
                            <td>{{ t.task_type.name }}</td>
                            <td>{{ t.note or "â€”" }}</td>
                            <td>{{ t.created_at.strftime('%d/%m/%Y') }}</td>

                            <td>
                                {% if t.due_date %}
                                    {{ t.due_date.strftime('%d/%m/%Y') }}
                                {% else %}
                                    â€”{% endif %}
                            </td>

                            <td><span class="badge bg-warning text-dark">Ã€ faire</span></td>

                            <td>
                                <select class="form-select form-select-sm done-by-select">
                                    <option value="">â€”</option>
                                    {% for e in employees %}
                                        <option value="{{ e.name }}">{{ e.name }}</option>
                                    {% endfor %}
                                </select>
                            </td>

                            <td>

                                <form action="{{ url_for('toggle_cat_task', cat_id=cat.id, task_id=t.id) }}"
                                      method="POST" class="toggle-form d-inline">

                                    <input type="hidden" name="done_by" value="">
                                    <button type="submit" class="btn btn-sm btn-outline-primary validate-btn" disabled>
                                        âœ“ Fait
                                    </button>
                                </form>

                                <form action="{{ url_for('delete_cat_task', cat_id=cat.id, task_id=t.id) }}"
                                      method="POST" class="d-inline"
                                      onsubmit="return confirm('Supprimer cette tÃ¢che ?');">
                                    <button class="btn btn-sm btn-outline-danger">ðŸ—‘</button>
                                </form>

                            </td>
                        </tr>
                        {% endfor %}

                    </tbody>
                </table>
            {% else %}
                <p class="text-muted mt-3">Aucune tÃ¢che Ã  effectuer.</p>
            {% endif %}

            <hr>

            <h3 class="mt-4">TÃ¢ches effectuÃ©es</h3>

            {% set done_with_date = tasks|selectattr("is_done", "equalto", True)
                                      |rejectattr("done_at", "equalto", None)
                                      |sort(attribute="done_at", reverse=True)
                                      |list %}
            {% set done_without_date = tasks|selectattr("is_done", "equalto", True)
                                        |selectattr("done_at", "equalto", None)
                                        |list %}
            {% set done = done_with_date + done_without_date %}

            {% if done %}
                <table class="table table-bordered mt-3">
                    <thead>
                        <tr>
                            <th>TÃ¢che</th>
                            <th>Note</th>
                            <th>Fait par</th>
                            <th>Fait le</th>
                        </tr>
                    </thead>

                    <tbody>
                        {% for t in done %}
                        <tr class="table-success">
                            <td>{{ t.task_type.name }}</td>
                            <td>{{ t.note or "â€”" }}</td>
                            <td>{{ t.done_by or "â€”" }}</td>
                            <td>
                                {% if t.done_at %}
                                    {{ t.done_at.strftime('%d/%m/%Y %H:%M') }}
                                {% else %}â€”{% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>

                </table>
            {% else %}
                <p class="text-muted mt-3">Aucune tÃ¢che effectuÃ©e.</p>
            {% endif %}

        </div> <!-- fin tÃ¢ches -->

    </div> <!-- fin tab-content -->



    </div> <!-- fin col-md-9 -->
  </div> <!-- fin row -->
</div> <!-- fin container principal -->

<!-- MODAL Mot de passe admin -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

            <form action="{{ url_for('delete_cat', cat_id=cat.id) }}" method="POST">

                <div class="modal-header">
                    <h5 class="modal-title">Confirmation de suppression</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <p>Cette action est <strong>dÃ©finitive</strong>.<br>
                    Veuillez entrer le <strong>mot de passe administrateur</strong> :</p>

                    <input type="password" name="admin_password"
                           class="form-control" placeholder="Mot de passe admin" required>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                            data-bs-dismiss="modal">Annuler</button>

                    <button type="submit" class="btn btn-danger">Supprimer dÃ©finitivement</button>
                </div>

            </form>

        </div>
    </div>
</div>


<!-- MODAL EDIT CAT -->
<div class="modal fade" id="editCatModal" tabindex="-1">
 <div class="modal-dialog">
  <form class="modal-content" method="POST" enctype="multipart/form-data" action="{{ url_for('update_cat_full', cat_id=cat.id) }}">
   <div class="modal-header">
    <h5 class="modal-title">Modifier les informations</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
   </div>
   <div class="modal-body">
    <label class="form-label">Statut</label>
    <select name="status" class="form-select mb-2">
     {% set statuses = ["normal","Ã  adopter","adoptÃ©","quarantaine","soins","dÃ©cÃ©dÃ©"] %}
     {% for s in statuses %}
      <option value="{{s}}" {% if cat.status==s %}selected{% endif %}>{{s}}</option>
     {% endfor %}
    </select>

    <label class="form-label">NumÃ©ro d'identification</label>
    <input name="identification_number" class="form-control mb-2" value="{{ cat.identification_number }}">

    <label class="form-label">Date d'entrÃ©e</label>
    <input type="date" name="entry_date" class="form-control mb-2"
           value="{% if cat.entry_date %}{{ cat.entry_date.strftime('%Y-%m-%d') }}{% endif %}">

    <div class="row mb-2">
		<div class="col-6 d-flex align-items-center">
			<label class="me-2 mb-0">FIV</label>
			<input type="checkbox" name="fiv"
               class="form-check-input"
               {% if cat.fiv %}checked{% endif %}>
		</div>

		<div class="col-6 d-flex align-items-center">
			<label class="me-2 mb-0">Besoin vÃ©to</label>
			<input type="checkbox" name="need_vet"
               class="form-check-input"
               {% if cat.need_vet %}checked{% endif %}>
    </div>
</div>

<div class="mt-3">
    <label class="form-label">Changer Photo</label>
    <input type="file" name="photo" accept="image/*" class="form-control">
</div>

   </div>
   <div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
    <button class="btn btn-primary">Enregistrer</button>
   </div>
  </form>
 </div>
</div>


<!-- Scripts -->
<script>
document.addEventListener("DOMContentLoaded", () => {

    // Activation onglet via ?tab=tasks
    const urlParams = new URLSearchParams(window.location.search);
    const tab = urlParams.get("tab");
    if (tab) {
        const trigger = document.querySelector(`[data-bs-target="#${tab}"]`);
        if (trigger) new bootstrap.Tab(trigger).show();
    }

    // Gestion du choix "Fait par" â†’ active le bouton quand un employÃ© est choisi
    document.querySelectorAll("tr").forEach(row => {
        const select = row.querySelector(".done-by-select");
        const form = row.querySelector(".toggle-form");
        const hidden = form?.querySelector('input[name="done_by"]');
        const btn = form?.querySelector(".validate-btn");

        if (!select || !form) return;

        select.addEventListener("change", () => {
            hidden.value = select.value;
            btn.disabled = !select.value;
        });
    });

});
</script>

{% endblock %}
