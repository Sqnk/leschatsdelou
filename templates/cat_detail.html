{% extends "base.html" %}
{% block content %}

<style>
#cat-content {
    margin-top: 20px;
}

/* Carte fiche chat √† gauche */
.cat-card {
    background: #ffffff;
    border-radius: 8px;
    padding: 16px;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);

    /* üî• AJOUT POUR √âTENDRE LA CARTE ET PLACER LE BOUTON EN BAS */
    min-height: 100vh;            /* √âtend la carte sur la hauteur visible */
    display: flex;                /* Active le mode flex vertical */
    flex-direction: column;       /* Empile les √©l√©ments verticalement */
}

.cat-card .delete-button-zone {
    margin-top: auto;             /* üî• Pousse le bouton Supprimer tout en bas */
}

.cat-photo {
    width: 100%;
    max-width: 220px;
    height: auto;
    border-radius: 8px;
    object-fit: cover;
}

/* Correction : fond opaque des modals */
.modal-backdrop.show {
    opacity: 0.4 !important;
}

.modal-content {
    background: #fff !important;
    backdrop-filter: none !important;
    background-color: #ffffff !important; /* fond blanc opaque */
}

.modal-dialog {
    backdrop-filter: none !important;
}

.modal {
    background-color: rgba(0, 0, 0, 0.4) !important; /* fond sombre normal */
}
</style>


<!-- MODAL SUPPRESSION -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

            <form action="{{ url_for('delete_cat', cat_id=cat.id) }}" method="POST">

                <div class="modal-header">
                    <h5 class="modal-title">Confirmation de suppression</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <p>Cette action est <strong>d√©finitive</strong>.<br>
                    Veuillez entrer le <strong>mot de passe administrateur</strong> :</p>

                    <input type="password" name="admin_password"
                           class="form-control" placeholder="Mot de passe admin" required>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                            data-bs-dismiss="modal">Annuler</button>

                    <button type="submit" class="btn btn-danger">Supprimer d√©finitivement</button>
                </div>

            </form>

        </div>
    </div>
</div>

<!-- MODAL MODIFICATION GLOBALE DU CHAT -->
<div class="modal fade" id="editCatModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="{{ url_for('update_cat_full', cat_id=cat.id) }}" method="POST" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title">Modifier le chat</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">

          <div class="mb-3">
            <label class="form-label">Photo</label>
            <input type="file" name="photo" class="form-control" accept="image/*">
          </div>

          <div class="mb-3">
            <label class="form-label">Num√©ro d'identification</label>
            <input type="text" name="identification_number" class="form-control"
                   value="{{ cat.identification_number or '' }}">
          </div>
		  <div class="mb-3">
				<label class="form-label">Date de naissance</label>
				<input type="date" name="birthdate" class="form-control"
           value="{% if cat.birthdate %}{{ cat.birthdate.strftime('%Y-%m-%d') }}{% endif %}">
			</div>

          <div class="mb-3">
            <label class="form-label">Date d'entr√©e au refuge</label>
            <input type="date" name="entry_date" class="form-control"
                   value="{% if cat.entry_date %}{{ cat.entry_date.strftime('%Y-%m-%d') }}{% endif %}">
          </div>

          <div class="mb-3">
            <label class="form-label">Statut</label>
            <select name="status" class="form-select">
              {% set statuses = ["normal", "√† adopter", "adopt√©", "famille d'accueil", "quarantaine", "soins", "d√©c√©d√©"] %}
              {% for s in statuses %}
                <option value="{{ s }}" {% if cat.status == s %}selected{% endif %}>{{ s }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-2 form-check">
            <input type="checkbox" class="form-check-input" id="editFiv" name="fiv" {% if cat.fiv %}checked{% endif %}>
            <label class="form-check-label" for="editFiv">FIV+</label>
          </div>

          <div class="mb-2 form-check">
            <input type="checkbox" class="form-check-input" id="editNeedVet" name="need_vet" {% if cat.need_vet %}checked{% endif %}>
            <label class="form-check-label" for="editNeedVet">Besoin v√©to</label>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-primary">Enregistrer</button>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- MODAL SORTIE -->
<div class="modal fade" id="exitCatModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="{{ url_for('cat_exit', cat_id=cat.id) }}" method="POST">

        <div class="modal-header">
          <h5 class="modal-title">Sortie du refuge</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">

          <label class="form-label">Date de sortie</label>
          <input type="date" name="exit_date" class="form-control mb-3" required>

          <label class="form-label">Raison</label>
          <select name="exit_reason" id="exit_reason_select" class="form-select" required>
              <option value="">‚Äî S√©lectionner ‚Äî</option>
              <option value="Plac√©">Plac&eacute;</option>
              <option value="Rendu √† son propri√©taire">Rendu √† son propri√©taire</option>
              <option value="D√©c√©d√©">D√©c√©d√©</option>
              <option value="√âchapp√©">√âchapp√©</option>
              <option value="Transf√©r√© vers un autre √©tablissement">
                Transf√©r√© vers un autre √©tablissement
              </option>
          </select>
		<!-- üîΩ Champs adoptant (affich√©s seulement pour une adoption) -->
          <div id="adopter-fields" class="mt-3" style="display:none;">
            <hr>
            <h6>Informations adoptant</h6>

            <div class="mb-2">
              <label class="form-label">Nom de l'adoptant</label>
              <input type="text" name="adopter_name" class="form-control">
            </div>

            <div class="mb-2">
              <label class="form-label">Adresse</label>
              <textarea name="adopter_address" class="form-control" rows="2"></textarea>
            </div>

            <div class="mb-2">
              <label class="form-label">T√©l√©phone</label>
              <input type="text" name="adopter_phone" class="form-control">
            </div>

            <div class="mb-2">
              <label class="form-label">Email</label>
              <input type="email" name="adopter_email" class="form-control">
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button class="btn btn-warning" style="background-color:#ff8c3a; border-color:#ff8c3a;">
            Enregistrer la sortie
          </button>
        </div>

      </form>
    </div>
  </div>
</div>

<div id="cat-content" class="container-fluid">
  <div class="row mt-3">

    <!-- COLONNE GAUCHE : FICHE CHAT -->
    <div class="col-md-3 mb-3">
      <div class="cat-card">

        {% if cat.photo_filename %}
        <div class="text-center mb-3">
          <img src="{{ url_for('uploads', filename=cat.photo_filename) }}" class="cat-photo" alt="Photo du chat">
        </div>
        {% endif %}

        <h3 class="mb-2">{{ cat.name }}</h3>

        <p class="mb-1"><strong>Statut :</strong> {{ cat.status or "‚Äî" }}</p>

        <p class="mb-1">
          <strong>Date de naissance :</strong>
          {% if cat.birthdate %}
              {{ cat.birthdate.strftime('%d/%m/%Y') }} ({{ age_text(cat.birthdate) }})
          {% else %}
              ‚Äî
          {% endif %}
        </p>

        <p class="mb-1">
          <strong>Num√©ro d'identification :</strong>
          {{ cat.identification_number or "‚Äî" }}
        </p>

        <p class="mb-3">
          <strong>Date d'entr√©e au refuge :</strong>
          {% if cat.entry_date %}
              {{ cat.entry_date.strftime('%d/%m/%Y') }}
          {% else %}
              ‚Äî
          {% endif %}
        </p>
		<p><strong>Raison de l'entr√©e :</strong> {{ cat.entry_reason or "‚Äî" }}</p>
		        {% if cat.exit_date %}
        <p class="mt-2"><strong>Date de sortie :</strong> {{ cat.exit_date.strftime('%d/%m/%Y') }}</p>
        <p><strong>Raison de la sortie :</strong> {{ cat.exit_reason }}</p>

        {% if cat.adopter_name or cat.adopter_address or cat.adopter_phone or cat.adopter_email %}
        <div class="mt-2 p-2 border rounded bg-light">
          <strong>Adoptant :</strong><br>
          {% if cat.adopter_name %}
            {{ cat.adopter_name }}<br>
          {% endif %}
          {% if cat.adopter_address %}
            {{ cat.adopter_address }}<br>
          {% endif %}
          {% if cat.adopter_phone %}
            üìû {{ cat.adopter_phone }}<br>
          {% endif %}
          {% if cat.adopter_email %}
            ‚úâÔ∏è {{ cat.adopter_email }}
          {% endif %}
        </div>
        {% endif %}
        {% endif %}

                <div class="mb-3">
			{% if cat.fiv %}
			<span class="badge bg-danger me-2">FIV+</span>
			{% endif %}
			{% if cat.need_vet %}
			<span class="badge bg-warning text-dark me-2">Besoin v√©to</span>
			{% endif %}
			{% if cat.exit_date %}
			<span class="badge text-dark" style="background-color:#ff8c3a;">SORTIE</span>
			{% endif %}
		</div>


        <div class="d-grid gap-2">

			<!-- Modifier -->
			<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editCatModal">
				Modifier
			</button>

            {% if not cat.exit_date %}
                <!-- üî• BOUTON SORTIE (orange) -->
                <button type="button" class="btn btn-warning"
                        style="background-color:#ff8c3a; border-color:#ff8c3a;"
                        data-bs-toggle="modal" data-bs-target="#exitCatModal">
                    Sortie
                </button>
            {% else %}
				<!-- üîÅ ANNULER SORTIE -->
				<form action="{{ url_for('cat_cancel_exit', cat_id=cat.id) }}"
					  method="POST"
					  class="d-grid"
					  onsubmit="return confirm('Confirmer l‚Äôannulation de la sortie ? Le chat sera de nouveau marqu√© comme pr√©sent.');">
					<button type="submit"
							class="btn btn-warning w-100"
							style="background-color:#ff8c3a; border-color:#ff8c3a;">
						Annuler sortie
					</button>
				</form>
			{% endif %}

			<!-- Retour -->
			<a href="{{ url_for('cats') }}" class="btn btn-secondary">
				Retour
			</a>

		</div>


					<!-- üî• BOUTON SUPPRIMER ISOL√â EN BAS -->
			<div class="d-grid mt-4">
				<button class="btn btn-danger" type="button"
					data-bs-toggle="modal" data-bs-target="#deleteConfirmModal">
					Supprimer
				</button>
			</div>


      </div>
    </div>

    <!-- COLONNE DROITE : ONGLET INFOS / VACCINS / NOTES / T√ÇCHES -->
    <div class="col-md-9">

        <!-- ONGLET BAR -->
        <ul class="nav nav-tabs" id="catTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="infos-tab" data-bs-toggle="tab"
                        data-bs-target="#infos" type="button" role="tab">‚ÑπÔ∏è Infos</button>
            </li>
			<li class="nav-item" role="presentation">
				<button class="nav-link" id="weights-tab" data-bs-toggle="tab"
					data-bs-target="#weights" type="button" role="tab">
				‚öñÔ∏è Poids
			</button>
		</li>

            <li class="nav-item" role="presentation">
                <button class="nav-link" id="vaccins-tab" data-bs-toggle="tab"
                        data-bs-target="#vaccins" type="button" role="tab">üíâ Vaccinations</button>
            </li>
			<li class="nav-item" role="presentation">
				<button class="nav-link" id="vermifuges-tab" data-bs-toggle="tab"
					data-bs-target="#vermifuges" type="button" role="tab">ü™± Vermifuges</button>
			</li>

            <li class="nav-item" role="presentation">
                <button class="nav-link" id="notes-tab" data-bs-toggle="tab"
                        data-bs-target="#notes" type="button" role="tab">üìù Notes</button>
            </li>

            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tasks-tab" data-bs-toggle="tab"
                        data-bs-target="#tasks" type="button" role="tab">‚úîÔ∏è T√¢ches</button>
            </li>
        </ul>

        <!-- ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà INFOS ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà -->
        <div class="tab-content mt-4">

            <div class="tab-pane fade show active" id="infos" role="tabpanel">

                <!-- Derni√®res notes -->
                <h3>Derni√®res notes</h3>

                {% set last_notes = notes[:5] %}
                {% if last_notes %}
                    {% for n in last_notes %}
                    <div class="border rounded p-3 mb-3">
                        <div class="d-flex justify-content-between">
                            <p>{{ n.content or "‚Äî" }}</p>

                            <form action="{{ url_for('delete_note', note_id=n.id) }}?tab=notes"
                                  method="POST"
                                  onsubmit="return confirm('Supprimer cette note ?');">
                                <button class="btn btn-sm btn-outline-danger">üóë</button>
                            </form>
                        </div>

                        {% if n.file_name %}
                            {% set ext = n.file_name.split('.')[-1].lower() %}
                            {% if ext in ['jpg','jpeg','png','gif','webp'] %}
                                <p><img src="{{ url_for('uploads', filename=n.file_name) }}"
                                        style="max-width:140px; border-radius:6px;"></p>
                            {% else %}
                                <p><a href="{{ url_for('uploads', filename=n.file_name) }}"
                                      target="_blank">üìé Voir fichier</a></p>
                            {% endif %}
                        {% endif %}

                        <p class="text-muted small mb-1">
                            <strong>Auteur :</strong> {{ n.author or "‚Äî" }}<br>
                            {% if n.veterinarian %}
                                <strong>V√©t√©rinaire :</strong> {{ n.veterinarian }}<br>
                            {% endif %}
                            <strong>Cr√©√©e le :</strong> 
							{% if n.created_at %}
    {{ n.created_at.astimezone(TZ_PARIS).strftime('%d/%m/%Y %H:%M') }}
{% else %}
    ‚Äî
{% endif %}
							<br>
                            {% if n.updated_at %}
                                <strong>Modifi√©e le :</strong> {{ n.updated_at.astimezone(TZ_PARIS).strftime('%d/%m/%Y %H:%M') }}
                            {% endif %}
                        </p>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">Aucune note.</p>
                {% endif %}

                <!-- T√¢ches √† effectuer -->
                <h3 class="mt-4">T√¢ches √† effectuer</h3>

                {% set todo = tasks|selectattr("is_done", "equalto", False)|list %}
                {% if todo %}
                    <table class="table table-bordered mt-3">
                        <thead>
                            <tr>
                                <th>T√¢che</th>
                                <th>Note</th>
                                <th>Ajout√©e le</th>
                                <th>√âch√©ance</th>
                                <th>Statut</th>
                                <th>V√©t√©rinaire</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for t in todo %}
                            <tr>
                                <td>{{ t.task_type.name }}</td>
                                <td>{{ t.note or "‚Äî" }}</td>
                                <td>{{ t.created_at.astimezone(TZ_PARIS).strftime('%d/%m/%Y') }}</td>
                                <td>
                                    {% if t.due_date %}
                                        {{ t.due_date.strftime('%d/%m/%Y') }}
                                    {% else %}‚Äî{% endif %}
                                </td>

                                <td><span class="badge bg-warning text-dark">√Ä faire</span></td>

                                <td>
                                    <select class="form-select form-select-sm done-by-select">
                                        <option value="">‚Äî</option>
                                        {% for v in veterinarians %}
                                            <option value="{{ v.name }}">{{ v.name }}</option>
                                        {% endfor %}
                                    </select>
                                </td>

                                <td>
                                    <form action="{{ url_for('toggle_cat_task',
                                               cat_id=cat.id, task_id=t.id) }}"
                                          method="POST" class="toggle-form d-inline">
                                        <input type="hidden" name="done_by" value="">
                                        <button class="btn btn-sm btn-outline-primary validate-btn" disabled>
                                            ‚úì Fait
                                        </button>
                                    </form>

                                    <form action="{{ url_for('delete_cat_task',
                                               cat_id=cat.id, task_id=t.id) }}"
                                          method="POST" class="d-inline"
                                          onsubmit="return confirm('Supprimer cette t√¢che ?');">
                                        <button class="btn btn-sm btn-outline-danger">üóë</button>
                                    </form>
                                </td>

                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="text-muted">Aucune t√¢che √† effectuer.</p>
                {% endif %}

<!-- Historique RDV v√©to -->
            <div class="mt-4">
                <h3>Historique rendez-vous v√©t√©rinaires</h3>

                {% if vet_appointments %}
                    <!-- max ~5 lignes visibles, ensuite scroll -->
                    <div class="border rounded p-3"
                         style="max-height: 260px; overflow-y: auto;">
                        <ul class="list-group list-group-flush mb-0">
                            {% for appt in vet_appointments %}
                                <li class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="badge bg-success me-2">Valid√©</span>
                                            {{ appt.date.astimezone(TZ_PARIS).strftime("%d/%m/%Y %H:%M") }}
                                            ‚Äî {{ appt.location or "Rendez-vous" }}
                                        </div>
                                        <small class="text-muted">
                                            RDV n¬∞{{ appt.id }}
                                        </small>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% else %}
                    <p class="text-muted">
                        Aucun rendez-vous v√©t√©rinaire valid√© pour ce chat pour le moment.
                    </p>
                {% endif %}
            </div>
            </div>
			<!-- ‚ñà‚ñà‚ñà‚ñà‚ñà VERMIFUGES ‚ñà‚ñà‚ñà‚ñà‚ñà -->
<div class="tab-pane fade" id="vermifuges" role="tabpanel">

    <h3 class="mt-3">Vermifuges</h3>

    <table class="table table-bordered mt-3">
        <thead>
        <tr>
            <th>Date</th>
            <th>Type</th>
            <th>R√©action</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>

        {% for f in dewormings %}
        <tr>
            <td>{{ f.date.strftime('%d/%m/%Y') }}</td>
            <td>
                {% if f.deworming_type %}
                    {{ f.deworming_type.name }}
                {% else %}
                    ‚Äî
                {% endif %}
            </td>
            <td>{{ f.reaction or "‚Äî" }}</td>

            <td class="text-center">
                <button class="btn btn-sm btn-outline-secondary"
                        data-bs-toggle="modal"
                        data-bs-target="#editFermiModal-{{ f.id }}">
                    ‚úèÔ∏è
                </button>

                <form action="{{ url_for('delete_deworming', cat_id=cat.id, dw_id=f.id) }}?tab=vermifuges"
                      method="POST" class="d-inline"
                      onsubmit="return confirm('Supprimer ce vermifuge ?');">
                    <button class="btn btn-sm btn-outline-danger">üóë</button>
                </form>
            </td>
        </tr>

        <!-- MODAL EDITION DU deworming -->
        <div class="modal fade" id="editFermiModal-{{ f.id }}" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">

                    <form method="POST"
                          action="{{ url_for('edit_deworming', cat_id=cat.id, dw_id=f.id) }}?tab=vermifuges">

                        <div class="modal-header">
                            <h5 class="modal-title">Modifier vermifuge</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>

                        <div class="modal-body">

                            <label class="form-label">Date</label>
                            <input type="date" name="date" class="form-control mb-2"
                                   value="{{ f.date.strftime('%Y-%m-%d') }}">

                            <label class="form-label">Type de vermifuge</label>
                            <select name="deworming_type_id" class="form-select mb-2">
                                <option value="">‚Äî</option>
                                {% for dt in deworming_types %}
                                    <option value="{{ dt.id }}"
                                        {% if f.deworming_type_id == dt.id %}selected{% endif %}>
                                        {{ dt.name }}
                                    </option>
                                {% endfor %}
                            </select>

                            <label class="form-label">R√©action</label>
                            <input type="text" name="reaction"
                                   value="{{ f.reaction or '' }}"
                                   class="form-control">

                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                            <button class="btn btn-primary">Enregistrer</button>
                        </div>

                    </form>

                </div>
            </div>
        </div>

        {% endfor %}

        {% if dewormings|length == 0 %}
        <tr>
            <td colspan="4" class="text-center text-muted">
                Aucun vermifuge enregistr√©
            </td>
        </tr>
        {% endif %}

        </tbody>
    </table>

    <h5 class="mt-4">Ajouter un vermifuge</h5>

    <form action="{{ url_for('add_deworming', cat_id=cat.id) }}?tab=vermifuges"
          method="POST" class="row g-3">

        <div class="col-md-3">
            <input type="date" class="form-control" name="date">
        </div>

        <div class="col-md-4">
            <select name="deworming_type_id" class="form-select">
                <option value="">Type de vermifuge</option>
                {% for dt in deworming_types %}
                    <option value="{{ dt.id }}">{{ dt.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3">
            <input type="text" class="form-control" name="reaction" placeholder="R√©action">
        </div>

        <div class="col-md-2">
            <button class="btn btn-success w-100">Ajouter</button>
        </div>
    </form>

</div>


            <!-- ‚ñà‚ñà‚ñà‚ñà‚ñà VACCINS ‚ñà‚ñà‚ñà‚ñà‚ñà -->
            <div class="tab-pane fade" id="vaccins" role="tabpanel">

                <h3 class="mt-3">Vaccinations</h3>
                <table class="table table-bordered mt-3">
                    <thead>
    <tr>
        <th>Vaccin</th>
        <th>Date</th>
        <th>Primo</th>
        <th>V√©t√©rinaire</th>
        <th>R√©action</th>
        <th>Actions</th>
    </tr>
</thead>
<tbody>
    {% for v in vaccs %}
    <tr>
        <td>{{ v.vaccine_type.name }}</td>
        <td>{{ v.date.strftime('%d/%m/%Y') }}</td>
        <td>
            {% if v.primo %}
                <span class="badge bg-info text-dark">Oui</span>
            {% else %}
                ‚Äî
            {% endif %}
        </td>
        <td>{{ v.veterinarian or "‚Äî" }}</td>
        <td>{{ v.reaction or "‚Äî" }}</td>

        <td class="text-center">

            <!-- Bouton modifier -->
            <button class="btn btn-sm btn-outline-secondary"
                    data-bs-toggle="modal"
                    data-bs-target="#editVaccModal-{{ v.id }}">
                ‚úèÔ∏è
            </button>

            <!-- Bouton supprimer -->
            <form action="{{ url_for('delete_vaccination', cat_id=cat.id, vacc_id=v.id) }}?tab=vaccins"
                  method="POST" class="d-inline"
                  onsubmit="return confirm('Supprimer cette vaccination ?');">
                <button class="btn btn-sm btn-outline-danger">üóë</button>
            </form>

        </td>
    </tr>

    <!-- MODAL EDITION DE CETTE VACCINATION -->
    <div class="modal fade" id="editVaccModal-{{ v.id }}" tabindex="-1">
		<div class="modal-dialog">
			<div class="modal-content">

				<form method="POST"
						action="{{ url_for('edit_vaccination', cat_id=cat.id, vacc_id=v.id) }}?tab=vaccins">


                <div class="modal-header">
                    <h5 class="modal-title">Modifier vaccination</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <label class="form-label">Vaccin</label>
                    <select name="vaccine_type_id" class="form-select mb-2">
                        {% for t in vaccines %}
                            <option value="{{ t.id }}" {% if t.id == v.vaccine_type_id %}selected{% endif %}>
                                {{ t.name }}
                            </option>
                        {% endfor %}
                    </select>

                    <label class="form-label">Date</label>
                    <input type="date" name="date"
                           value="{{ v.date.strftime('%Y-%m-%d') }}"
                           class="form-control mb-2">

                    <div class="form-check mb-2">
                        <input type="checkbox" name="primo" id="primoEdit-{{ v.id }}"
                               class="form-check-input"
                               {% if v.primo %}checked{% endif %}>
                        <label for="primoEdit-{{ v.id }}" class="form-check-label">Primo</label>
                    </div>

                    <label class="form-label">V√©t√©rinaire</label>
                    <select name="veterinarian" class="form-select mb-2">
                        <option value="">‚Äî</option>
                        {% for vet in veterinarians %}
                            <option value="{{ vet.name }}"
                                {% if v.veterinarian == vet.name %}selected{% endif %}>
                                {{ vet.name }}
                            </option>
                        {% endfor %}
                    </select>

                    <label class="form-label">R√©action</label>
                    <input type="text" name="reaction"
                           value="{{ v.reaction or '' }}"
                           class="form-control">

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button class="btn btn-primary">Enregistrer</button>
                </div>

            </form>

        </div>
    </div>
</div>


    {% endfor %}
                        {% if vaccs|length == 0 %}
                        <tr>
                            <td colspan="5" class="text-center text-muted">
                                Aucun vaccin enregistr√©
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>

                <h5 class="mt-4">Ajouter une vaccination</h5>
                <form action="{{ url_for('add_vaccination', cat_id=cat.id) }}?tab=vaccins"
                      method="POST" class="row g-2 mb-5">

                    <div class="col-md-3">
                        <select name="vaccine_type_id" class="form-select" required>
                            <option value="">Choisir un vaccin</option>
                            {% for v in vaccines %}
                                <option value="{{ v.id }}">{{ v.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-2">
                        <input type="date" name="date" class="form-control">
                    </div>

                    <div class="col-md-2">
						<div class="border rounded px-3 py-2 d-flex align-items-center" style="height: 38px;">
							<input type="checkbox" name="primo" id="primoCheck" class="form-check-input me-2">
							<label for="primoCheck" class="form-check-label mb-0">Primo</label>
						</div>
					</div>

                    <div class="col-md-2">
                        <select name="veterinarian" class="form-select">
                            <option value="">V√©t√©rinaire</option>
                            {% for vet in veterinarians %}
                                <option value="{{ vet.name }}">{{ vet.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-2">
                        <input type="text" name="reaction" class="form-control" placeholder="R√©action">
                    </div>

                    <div class="col-md-1">
                        <button class="btn btn-success">Ajouter</button>
                    </div>

                </form>

            </div>

            <!-- ‚ñà‚ñà‚ñà‚ñà‚ñà NOTES ‚ñà‚ñà‚ñà‚ñà‚ñà -->
            <div class="tab-pane fade" id="notes" role="tabpanel">

                <h3 class="mt-3">Ajouter une note</h3>

                <form action="{{ url_for('add_note', cat_id=cat.id) }}?tab=notes" method="POST"
                      enctype="multipart/form-data" class="mb-4">

                    <div class="mb-2">
                        <textarea name="content" class="form-control" rows="2"
                                  placeholder="Contenu de la note..."></textarea>
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Auteur :</label>
                        <select name="author" class="form-select">
                            <option value="">‚Äî</option>
                            {% for e in employees %}
                                <option value="{{ e.name }}">{{ e.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-2">
                        <label class="form-label">V√©t√©rinaire :</label>
                        <select name="veterinarian" class="form-select">
                            <option value="">‚Äî</option>
                            {% for v in veterinarians %}
                                <option value="{{ v.name }}">{{ v.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Fichier :</label>
                        <input type="file" name="file" class="form-control">
                    </div>

                    <button class="btn btn-primary">Ajouter la note</button>

                </form>

                <h3 class="mt-4">Toutes les notes</h3>

                {% for n in notes %}
                <div class="border rounded p-3 mb-3">
                    <div class="d-flex justify-content-between">
                        <p>{{ n.content or "‚Äî" }}</p>

                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary"
                                    data-bs-toggle="modal" data-bs-target="#editNoteModal-{{ n.id }}">
                                ‚úèÔ∏è
                            </button>

                            <form action="{{ url_for('delete_note', note_id=n.id) }}?tab=notes"
								method="POST"
								onsubmit="return confirm('Supprimer cette note ?');">
                                <button class="btn btn-sm btn-outline-danger">üóë</button>
                            </form>
                        </div>
                    </div>

                    {% if n.file_name %}
                        {% set ext = n.file_name.split('.')[-1].lower() %}
                        {% if ext in ['jpg','jpeg','png','gif','webp'] %}
                            <p><img src="{{ url_for('uploads', filename=n.file_name) }}"
                                    style="max-width:140px; border-radius:6px;"></p>
                        {% else %}
                            <p><a href="{{ url_for('uploads', filename=n.file_name) }}"
                                  target="_blank">üìé Voir fichier</a></p>
                        {% endif %}
                    {% endif %}

                    <p class="text-muted small mb-1">
                        <strong>Auteur :</strong> {{ n.author or "‚Äî" }}<br>
                        {% if n.veterinarian %}
                            <strong>V√©t√©rinaire :</strong> {{ n.veterinarian }}<br>
                        {% endif %}
                        <strong>Cr√©√©e le :</strong> 
						{% if n.created_at %}
    {{ n.created_at.astimezone(TZ_PARIS).strftime('%d/%m/%Y %H:%M') }}
{% else %}
    ‚Äî
{% endif %}
						<br>
                        {% if n.updated_at %}
                            <strong>Modifi√©e le :</strong> {{ n.updated_at.astimezone(TZ_PARIS).strftime('%d/%m/%Y %H:%M') }}
                        {% endif %}
                    </p>
                </div>

                <!-- Modal √©dition note -->
                <div class="modal fade" id="editNoteModal-{{ n.id }}" tabindex="-1" aria-hidden="true">
                  <div class="modal-dialog">
                    <form class="modal-content" method="POST"
							action="{{ url_for('edit_note', note_id=n.id) }}?tab=notes">
                      <div class="modal-header">
                        <h5 class="modal-title">Modifier la note</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                      </div>
                      <div class="modal-body">

                        <div class="mb-2">
                            <label class="form-label">Contenu</label>
                            <textarea name="content" class="form-control" rows="3">{{ n.content }}</textarea>
                        </div>

                        <div class="mb-2">
                            <label class="form-label">Auteur</label>
                            <select name="author" class="form-select">
                                <option value="">‚Äî</option>
                                {% for e in employees %}
                                    <option value="{{ e.name }}" {% if n.author == e.name %}selected{% endif %}>
                                        {{ e.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-2">
                            <label class="form-label">V√©t√©rinaire</label>
                            <select name="veterinarian" class="form-select">
                                <option value="">‚Äî</option>
                                {% for v in veterinarians %}
                                    <option value="{{ v.name }}" {% if n.veterinarian == v.name %}selected{% endif %}>
                                        {{ v.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <p class="text-muted small mb-0">
                            <strong>Cr√©√©e le :</strong> 
							{% if n.created_at %}
    {{ n.created_at.astimezone(TZ_PARIS).strftime('%d/%m/%Y %H:%M') }}
{% else %}
    ‚Äî
{% endif %}
							<br>
                            {% if n.updated_at %}
                                <strong>Derni√®re modif :</strong> {{ n.updated_at.astimezone(TZ_PARIS).strftime('%d/%m/%Y %H:%M') }}
                            {% endif %}
                        </p>

                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        <button class="btn btn-primary">Enregistrer</button>
                      </div>
                    </form>
                  </div>
                </div>

                {% endfor %}
                {% if notes|length == 0 %}
                    <p class="text-muted">Aucune note.</p>
                {% endif %}

            </div>

            <!-- ‚ñà‚ñà‚ñà‚ñà‚ñà T√ÇCHES ‚ñà‚ñà‚ñà‚ñà‚ñà -->
            <div class="tab-pane fade" id="tasks" role="tabpanel">

                <h3 class="mt-3">Ajouter une t√¢che</h3>

                <form action="{{ url_for('create_cat_task', cat_id=cat.id) }}?tab=tasks"
                      method="POST" class="row g-3 mt-2 mb-4">

                    <div class="col-md-4">
                        <label class="form-label">Type de t√¢che</label>
                        <select name="task_type_id" class="form-select" required>
                            <option value="">‚Äî Choisir une t√¢che ‚Äî</option>
                            {% for tt in task_types %}
                                <option value="{{ tt.id }}">{{ tt.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Note</label>
                        <input type="text" name="note" class="form-control"
                               placeholder="D√©tails, consigne...">
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Date d'√©ch√©ance</label>
                        <input type="date" name="due_date" class="form-control">
                    </div>

                    <div class="col-md-1 d-flex align-items-end">
                        <button class="btn btn-success w-100">Ajouter</button>
                    </div>
                </form>

                <hr>

                <h3 class="mt-4">T√¢ches √† effectuer</h3>

                {% if todo %}
                    <table class="table table-bordered mt-3">
                        <thead>
                            <tr>
                                <th>T√¢che</th>
                                <th>Note</th>
                                <th>Ajout√©e le</th>
                                <th>√âch√©ance</th>
                                <th>Statut</th>
                                <th>V√©t√©rinaire</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>

                            {% for t in todo %}
                            <tr>
                                <td>{{ t.task_type.name }}</td>
                                <td>{{ t.note or "‚Äî" }}</td>
                                <td>{{ t.created_at.astimezone(TZ_PARIS).strftime('%d/%m/%Y') }}</td>

                                <td>
                                    {% if t.due_date %}
                                        {{ t.due_date.strftime('%d/%m/%Y') }}
                                    {% else %}
                                        ‚Äî{% endif %}
                                </td>

                                <td><span class="badge bg-warning text-dark">√Ä faire</span></td>

                                <td>
                                    <select class="form-select form-select-sm done-by-select">
                                        <option value="">‚Äî</option>
                                        {% for v in veterinarians %}
                                            <option value="{{ v.name }}">{{ v.name }}</option>
                                        {% endfor %}
                                    </select>
                                </td>

                                <td>

                                    <form action="{{ url_for('toggle_cat_task', cat_id=cat.id, task_id=t.id) }}?tab=tasks"
                                          method="POST" class="toggle-form d-inline">

                                        <input type="hidden" name="done_by" value="">
                                        <button type="submit" class="btn btn-sm btn-outline-primary validate-btn" disabled>
                                            ‚úì Fait
                                        </button>
                                    </form>

                                    <form action="{{ url_for('delete_cat_task', cat_id=cat.id, task_id=t.id) }}?tab=tasks"
                                          method="POST" class="d-inline"
                                          onsubmit="return confirm('Supprimer cette t√¢che ?');">
                                        <button class="btn btn-sm btn-outline-danger">üóë</button>
                                    </form>

                                </td>
                            </tr>
                            {% endfor %}

                        </tbody>
                    </table>
                {% else %}
                    <p class="text-muted mt-3">Aucune t√¢che √† effectuer.</p>
                {% endif %}

                <hr>

                <h3 class="mt-4">T√¢ches effectu√©es</h3>

                {% set done_with_date = tasks|selectattr("is_done", "equalto", True)
                                          |rejectattr("done_at", "equalto", None)
                                          |sort(attribute="done_at", reverse=True)
                                          |list %}
                {% set done_without_date = tasks|selectattr("is_done", "equalto", True)
                                            |selectattr("done_at", "equalto", None)
                                            |list %}
                {% set done = done_with_date + done_without_date %}

                {% if done %}
                    <table class="table table-bordered mt-3">
                        <thead>
                            <tr>
                                <th>T√¢che</th>
                                <th>Note</th>
                                <th>V√©t√©rinaire</th>
                                <th>Fait le</th>
                            </tr>
                        </thead>

                        <tbody>
                            {% for t in done %}
                            <tr class="table-success">
                                <td>{{ t.task_type.name }}</td>
                                <td>{{ t.note or "‚Äî" }}</td>
                                <td>{{ t.done_by or "‚Äî" }}</td>
                                <td>
                                    {% if t.done_at %}
                                        {{ t.done_at.astimezone(TZ_PARIS).strftime('%d/%m/%Y %H:%M') }}
                                    {% else %}‚Äî{% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>

                    </table>
                {% else %}
                    <p class="text-muted mt-3">Aucune t√¢che effectu√©e.</p>
                {% endif %}

            </div> <!-- fin t√¢ches -->
<!-- ‚ñà‚ñà‚ñà‚ñà‚ñà POIDS ‚ñà‚ñà‚ñà‚ñà‚ñà -->
<div class="tab-pane fade" id="weights" role="tabpanel">

    <h3 class="mt-3">Poids du chat</h3>

    <!-- Formulaire ajout d'une pes√©e -->
    <form action="{{ url_for('add_weight', cat_id=cat.id) }}"
          method="POST" class="row g-3 mt-2 mb-4">

        <div class="col-md-3">
            <label class="form-label">Date</label>
            <input type="date" name="date" class="form-control">
        </div>

        <div class="col-md-3">
            <label class="form-label">Poids (kg)</label>
            <input type="number" step="0.01" name="weight"
                   class="form-control" placeholder="ex: 4.25" required>
        </div>

        <div class="col-md-2 d-flex align-items-end">
            <button class="btn btn-success w-100">Ajouter</button>
        </div>
    </form>

    <!-- Tableau historique -->
    <h5 class="mt-4">Historique des pes√©es</h5>

    <table class="table table-bordered mt-3">
        <thead>
    <tr>
        <th>Date</th>
        <th>Poids (kg)</th>
        <th>Actions</th>
    </tr>
</thead>
<tbody>
    {% for w in weights|sort(attribute='date') %}
    <tr>
        <td>{{ w.date.strftime('%d/%m/%Y') }}</td>
        <td>{{ "%.2f"|format(w.weight) }}</td>
        <td class="text-center">

            <form action="{{ url_for('delete_weight', cat_id=cat.id, weight_id=w.id) }}?tab=weights"
                  method="POST"
                  onsubmit="return confirm('Supprimer cette pes√©e ?');">
                <button class="btn btn-sm btn-outline-danger">üóë</button>
            </form>

        </td>
    </tr>
    {% endfor %}

    {% if weights|length == 0 %}
    <tr>
        <td colspan="3" class="text-muted text-center">
            Aucune pes√©e enregistr√©e
        </td>
    </tr>
    {% endif %}
</tbody>


            {% if weights|length == 0 %}
            <tr>
                <td colspan="2" class="text-muted text-center">
                    Aucune pes√©e enregistr√©e
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>

    <!-- Graphique -->
    <h5 class="mt-4">√âvolution du poids</h5>
    <canvas id="weightChart" height="120"></canvas>

</div>
        </div> <!-- fin tab-content -->

    </div> <!-- fin col droite -->

  </div> <!-- fin row -->
</div> <!-- fin container-fluid -->

<!-- Scripts -->
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

    /* ---------------------------------------------------------
       Activation onglet via ?tab=xxx (supporte maintenant "weights")
       --------------------------------------------------------- */
    const urlParams = new URLSearchParams(window.location.search);
    const tab = urlParams.get("tab");
    if (tab) {
        const trigger = document.querySelector(`[data-bs-target="#${tab}"]`);
        if (trigger) new bootstrap.Tab(trigger).show();
    }

    /* ---------------------------------------------------------
       Gestion du "Fait par" dans les t√¢ches
       --------------------------------------------------------- */
    document.querySelectorAll("tr").forEach(row => {
        const select = row.querySelector(".done-by-select");
        const form = row.querySelector(".toggle-form");
        const hidden = form?.querySelector('input[name="done_by"]');
        const btn = form?.querySelector(".validate-btn");

        if (!select || !form) return;

        select.addEventListener("change", () => {
            hidden.value = select.value;
            btn.disabled = !select.value;
        });
    });

    /* ---------------------------------------------------------
       Graphique Poids (Chart.js)
       --------------------------------------------------------- */
    const ctx = document.getElementById("weightChart");
    if (ctx) {
        const labels = [
            {% for w in weights|sort(attribute='date') %}
                "{{ w.date.strftime('%d/%m/%Y') }}",
            {% endfor %}
        ];

        const data = [
            {% for w in weights|sort(attribute='date') %}
                {{ "%.2f"|format(w.weight) }},
            {% endfor %}
        ];

        new Chart(ctx, {
            type: "line",
            data: {
                labels: labels,
                datasets: [{
                    label: "Poids (kg)",
                    data: data,
                    borderWidth: 2,
                    tension: 0.3
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true     // <--- d√©marre l'axe Y √† 0
                    }
                }
            }
        });
    }

    /* ---------------------------------------------------------
       Affichage conditionnel des champs adoptant
       dans le modal de sortie
       --------------------------------------------------------- */
    const reasonSelect = document.getElementById("exit_reason_select");
    const adopterBlock = document.getElementById("adopter-fields");

    if (reasonSelect && adopterBlock) {
        function refreshAdopterVisibility() {
            const value = reasonSelect.value;
            // Adoption = Plac√© ou rendu au propri√©taire
            if (value === "Plac√©" || value === "Rendu √† son propri√©taire") {
                adopterBlock.style.display = "block";
            } else {
                adopterBlock.style.display = "none";
            }
        }

        reasonSelect.addEventListener("change", refreshAdopterVisibility);
        // au cas o√π une valeur serait pr√©-remplie un jour
        refreshAdopterVisibility();
    }

});
</script>


{% endblock %}
