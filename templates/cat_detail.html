{% extends "base.html" %}
{% block content %}

<style>
/* Bandeau fixe en haut */
#cat-header {
    position: fixed;
    top: 0;
    left: 250px; /* correspond √† la sidebar du Refuge */
    right: 0;
    z-index: 20;
    background: white;
    border-bottom: 2px solid #ddd;
    padding: 15px 25px;
}

/* Correction si la sidebar est repli√©e (si applicable) */
@media (max-width: 992px) {
    #cat-header {
        left: 0 !important;
    }
}

/* Marge sous le bandeau pour que le contenu ne passe pas dessous */
#cat-content {
    margin-top: 190px; /* hauteur bandeau + padding */
}

/* Ajustement visuel photo */
.cat-photo {
    width: 180px;
    height: auto;
    border-radius: 8px;
}
</style>

<!-- ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà -->
<!-- BANDEAU FIXE DU CHAT          -->
<!-- ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà -->

<div id="cat-header" class="d-flex justify-content-between align-items-start">

    <!-- Colonne gauche : photo + upload -->
    <div class="d-flex align-items-start gap-3">

        {% if cat.photo_filename %}
        <img src="{{ url_for('uploads', filename=cat.photo_filename) }}" class="cat-photo">
        {% endif %}

        <!-- Upload photo -->
        <form action="{{ url_for('update_cat_photo', cat_id=cat.id) }}"
              method="POST" enctype="multipart/form-data"
              class="d-flex flex-column align-items-start">

            <input type="file" id="photoInput" name="photo"
                   class="d-none" accept="image/*" required>

            <button type="button" class="btn btn-outline-primary mb-2"
                    onclick="document.getElementById('photoInput').click();">
                üì∑ Choisir une photo
            </button>

            <button class="btn btn-primary btn-sm d-none" id="submitPhotoBtn">
                Mettre √† jour
            </button>
        </form>

        <div class="mt-3">
            <p><strong>Num√©ro d'identification :</strong> {{ cat.identification_number or "‚Äî" }}</p>
            <p><strong>Date d'entr√©e au refuge :</strong> {% if cat.entry_date %}{{ cat.entry_date.strftime('%d/%m/%Y') }}{% else %}‚Äî{% endif %}</p>
        </div>

    </div>

    <!-- Colonne centrale : infos + nom + badges -->
    <div style="flex-grow:1; max-width:600px; margin-left:40px;">

        <h1 class="mb-2">

            {{ cat.name }}

            {% if cat.sex == 'male' %}
                <span style="color:#2196F3; font-size:1.8rem; margin-left:8px;">‚ôÇ</span>
            {% elif cat.sex == 'female' %}
                <span style="color:#E91E63; font-size:1.8rem; margin-left:8px;">‚ôÄ</span>
            {% endif %}

            {% if cat.fiv %}
                <span class="badge bg-danger ms-2">FIV+</span>
            {% endif %}

            {% if cat.need_vet %}
                <span class="badge bg-warning text-dark ms-2">Besoin v√©to</span>
            {% endif %}
        </h1>

        <p class="mb-1"><strong>Statut :</strong> {{ cat.status or "‚Äî" }}</p>

        <p class="mb-1"><strong>Date de naissance :</strong>
            {% if cat.birthdate %}
                {{ cat.birthdate.strftime('%d/%m/%Y') }} ({{ age_text(cat.birthdate) }})
            {% else %}
                ‚Äî
            {% endif %}
        </p>

        <p class="mb-0"><strong>FIV :</strong> {% if cat.fiv %}Oui{% else %}Non{% endif %}</p>

    </div>

    <!-- Colonne droite : boutons retour + supprimer -->
    <div class="text-end">

        <a href="{{ url_for('recherche') }}" class="btn btn-secondary mb-2">
            Retour
        </a>

        <button class="btn btn-danger d-block w-100"
                data-bs-toggle="modal" data-bs-target="#deleteConfirmModal">
            üóë Supprimer
        </button>

    </div>
</div>

<!-- MODAL Mot de passe admin -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

            <form action="{{ url_for('delete_cat', cat_id=cat.id) }}" method="POST">

                <div class="modal-header">
                    <h5 class="modal-title">Confirmation de suppression</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <p>Cette action est <strong>d√©finitive</strong>.<br>
                    Veuillez entrer le <strong>mot de passe administrateur</strong> :</p>

                    <input type="password" name="admin_password"
                           class="form-control" placeholder="Mot de passe admin" required>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                            data-bs-dismiss="modal">Annuler</button>

                    <button type="submit" class="btn btn-danger">Supprimer d√©finitivement</button>
                </div>

            </form>

        </div>
    </div>
</div>

<!-- ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà -->
<!-- CONTENU BAS (avec marge pour le bandeau fixe) -->
<!-- ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà -->

<div id="cat-content" class="container">

    <!-- ONGLET BAR -->
    <ul class="nav nav-tabs" id="catTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="infos-tab" data-bs-toggle="tab"
                    data-bs-target="#infos" type="button" role="tab">Infos</button>
        </li>

        <li class="nav-item" role="presentation">
            <button class="nav-link" id="vaccins-tab" data-bs-toggle="tab"
                    data-bs-target="#vaccins" type="button" role="tab">Vaccinations</button>
        </li>

        <li class="nav-item" role="presentation">
            <button class="nav-link" id="notes-tab" data-bs-toggle="tab"
                    data-bs-target="#notes" type="button" role="tab">Notes</button>
        </li>

        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tasks-tab" data-bs-toggle="tab"
                    data-bs-target="#tasks" type="button" role="tab">T√¢ches</button>
        </li>
    </ul>


    <!-- ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà INFOS ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà -->
    <div class="tab-content mt-4">

        <div class="tab-pane fade show active" id="infos" role="tabpanel">

            <!-- Derni√®res notes -->
            <h3>Derni√®res notes</h3>

            {% set last_notes = notes[:5] %}
            {% if last_notes %}
                {% for n in last_notes %}
                <div class="border rounded p-3 mb-3">
                    <div class="d-flex justify-content-between">
                        <p>{{ n.content or "‚Äî" }}</p>

                        <form action="{{ url_for('delete_note', note_id=n.id) }}"
                              method="POST"
                              onsubmit="return confirm('Supprimer cette note ?');">
                            <button class="btn btn-sm btn-outline-danger">üóë</button>
                        </form>
                    </div>

                    {% if n.file_name %}
                        {% set ext = n.file_name.split('.')[-1].lower() %}
                        {% if ext in ['jpg','jpeg','png','gif','webp'] %}
                            <p><img src="{{ url_for('uploads', filename=n.file_name) }}"
                                    style="max-width:140px; border-radius:6px;"></p>
                        {% else %}
                            <p><a href="{{ url_for('uploads', filename=n.file_name) }}"
                                  target="_blank">üìé Voir fichier</a></p>
                        {% endif %}
                    {% endif %}

                    <p class="text-muted small mb-1">
                        <strong>Auteur :</strong> {{ n.author or "‚Äî" }}<br>
                        {% if n.veterinarian %}
                            <strong>V√©t√©rinaire :</strong> {{ n.veterinarian }}<br>
                        {% endif %}
                        <strong>Cr√©√©e le :</strong> {{ n.created_at.strftime('%d/%m/%Y %H:%M') }}<br>
                        {% if n.updated_at %}
                            <strong>Modifi√©e le :</strong> {{ n.updated_at.strftime('%d/%m/%Y %H:%M') }}
                        {% endif %}
                    </p>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-muted">Aucune note.</p>
            {% endif %}


            <!-- T√¢ches √† effectuer -->
            <h3 class="mt-4">T√¢ches √† effectuer</h3>

            {% set todo = tasks|selectattr("is_done", "equalto", False)|list %}
            {% if todo %}
                <table class="table table-bordered mt-3">
                    <thead>
                        <tr>
                            <th>T√¢che</th>
                            <th>Note</th>
                            <th>Ajout√©e le</th>
                            <th>√âch√©ance</th>
                            <th>Statut</th>
                            <th>Fait par</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for t in todo %}
                        <tr>
                            <td>{{ t.task_type.name }}</td>
                            <td>{{ t.note or "‚Äî" }}</td>
                            <td>{{ t.created_at.strftime('%d/%m/%Y') }}</td>
                            <td>
                                {% if t.due_date %}
                                    {{ t.due_date.strftime('%d/%m/%Y') }}
                                {% else %}‚Äî{% endif %}
                            </td>

                            <td><span class="badge bg-warning text-dark">√Ä faire</span></td>

                            <td>
                                <select class="form-select form-select-sm done-by-select">
                                    <option value="">‚Äî</option>
                                    {% for e in employees %}
                                        <option value="{{ e.name }}">{{ e.name }}</option>
                                    {% endfor %}
                                </select>
                            </td>

                            <td>
                                <form action="{{ url_for('toggle_cat_task',
                                           cat_id=cat.id, task_id=t.id) }}"
                                      method="POST" class="toggle-form d-inline">
                                    <input type="hidden" name="done_by" value="">
                                    <button class="btn btn-sm btn-outline-primary validate-btn" disabled>
                                        ‚úì Fait
                                    </button>
                                </form>

                                <form action="{{ url_for('delete_cat_task',
                                           cat_id=cat.id, task_id=t.id) }}"
                                      method="POST" class="d-inline"
                                      onsubmit="return confirm('Supprimer cette t√¢che ?');">
                                    <button class="btn btn-sm btn-outline-danger">üóë</button>
                                </form>
                            </td>

                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p class="text-muted">Aucune t√¢che √† effectuer.</p>
            {% endif %}

            <hr class="my-4">

            <!-- Modifier les informations -->
            <h3>Modifier les informations</h3>

            <form action="{{ url_for('update_cat_status', cat_id=cat.id) }}"
                  method="POST" class="row g-2 mb-4 mt-2">

                <div class="col-auto">
                    <select name="status" class="form-select">
                        {% set statuses = ["normal", "√† adopter", "adopt√©", "quarantaine", "soins", "d√©c√©d√©"] %}
                        {% for s in statuses %}
                            <option value="{{ s }}" {% if cat.status == s %}selected{% endif %}>{{ s }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-auto d-flex align-items-center">
                    <label class="form-check-label me-2"><strong>FIV :</strong></label>
                    <input type="checkbox" name="fiv" class="form-check-input"
                           {% if cat.fiv %}checked{% endif %}>
                </div>

                <div class="col-auto d-flex align-items-center">
                    <label class="form-check-label me-2"><strong>Besoin v√©to :</strong></label>
                    <input type="checkbox" name="need_vet" class="form-check-input"
                           {% if cat.need_vet %}checked{% endif %}>
                </div>

                <div class="col-auto">
                    <button class="btn btn-primary">Enregistrer</button>
                </div>

            </form>

        </div>

        <!-- ‚ñà‚ñà‚ñà‚ñà‚ñà VACCINS ‚ñà‚ñà‚ñà‚ñà‚ñà -->
        <div class="tab-pane fade" id="vaccins" role="tabpanel">

            <h3 class="mt-3">Vaccinations</h3>
            <table class="table table-bordered mt-3">
                <thead>
                    <tr>
                        <th>Vaccin</th>
                        <th>Date</th>
                        <th>Lot</th>
                        <th>V√©t√©rinaire</th>
                        <th>R√©action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for v in vaccs %}
                    <tr>
                        <td>{{ v.vaccine_type.name }}</td>
                        <td>{{ v.date.strftime('%d/%m/%Y') }}</td>
                        <td>{{ v.lot or "‚Äî" }}</td>
                        <td>{{ v.veterinarian or "‚Äî" }}</td>
                        <td>{{ v.reaction or "‚Äî" }}</td>
                    </tr>
                    {% endfor %}
                    {% if vaccs|length == 0 %}
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            Aucun vaccin enregistr√©
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>

            <h5 class="mt-4">Ajouter une vaccination</h5>
            <form action="{{ url_for('add_vaccination', cat_id=cat.id) }}"
                  method="POST" class="row g-2 mb-5">

                <div class="col-md-3">
                    <select name="vaccine_type_id" class="form-select" required>
                        <option value="">Choisir un vaccin</option>
                        {% for v in vaccines %}
                            <option value="{{ v.id }}">{{ v.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-2">
                    <input type="date" name="date" class="form-control">
                </div>

                <div class="col-md-2">
                    <input type="text" name="lot" class="form-control" placeholder="Lot">
                </div>

                <div class="col-md-2">
                    <select name="veterinarian" class="form-select">
                        <option value="">V√©t√©rinaire</option>
                        {% for vet in veterinarians %}
                            <option value="{{ vet.name }}">{{ vet.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-2">
                    <input type="text" name="reaction" class="form-control" placeholder="R√©action">
                </div>

                <div class="col-md-1">
                    <button class="btn btn-success">Ajouter</button>
                </div>

            </form>

        </div>

        <!-- ‚ñà‚ñà‚ñà‚ñà‚ñà NOTES ‚ñà‚ñà‚ñà‚ñà‚ñà -->
        <div class="tab-pane fade" id="notes" role="tabpanel">

            <h3 class="mt-3">Ajouter une note</h3>

            <form action="{{ url_for('add_note', cat_id=cat.id) }}" method="POST"
                  enctype="multipart/form-data" class="mb-4">

                <div class="mb-2">
                    <textarea name="content" class="form-control" rows="2"
                              placeholder="Contenu de la note..."></textarea>
                </div>

                <div class="mb-2">
                    <label class="form-label">Auteur :</label>
                    <select name="author" class="form-select">
                        <option value="">‚Äî</option>
                        {% for e in employees %}
                            <option value="{{ e.name }}">{{ e.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-2">
                    <label class="form-label">V√©t√©rinaire :</label>
                    <select name="veterinarian" class="form-select">
                        <option value="">‚Äî</option>
                        {% for v in veterinarians %}
                            <option value="{{ v.name }}">{{ v.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Fichier :</label>
                    <input type="file" name="file" class="form-control">
                </div>

                <button class="btn btn-primary">Ajouter la note</button>

            </form>

            <h3 class="mt-4">Toutes les notes</h3>

            {% for n in notes %}
            <div class="border rounded p-3 mb-3">
                <div class="d-flex justify-content-between">
                    <p>{{ n.content or "‚Äî" }}</p>

                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-sm btn-outline-secondary"
                                data-bs-toggle="modal" data-bs-target="#editNoteModal-{{ n.id }}">
                            ‚úèÔ∏è
                        </button>

                        <form action="{{ url_for('delete_note', note_id=n.id) }}"
                              method="POST"
                              onsubmit="return confirm('Supprimer cette note ?');">
                            <button class="btn btn-sm btn-outline-danger">üóë</button>
                        </form>
                    </div>
                </div>

                {% if n.file_name %}
                    {% set ext = n.file_name.split('.')[-1].lower() %}
                    {% if ext in ['jpg','jpeg','png','gif','webp'] %}
                        <p><img src="{{ url_for('uploads', filename=n.file_name) }}"
                                style="max-width:140px; border-radius:6px;"></p>
                    {% else %}
                        <p><a href="{{ url_for('uploads', filename=n.file_name) }}"
                              target="_blank">üìé Voir fichier</a></p>
                    {% endif %}
                {% endif %}

                <p class="text-muted small mb-1">
                    <strong>Auteur :</strong> {{ n.author or "‚Äî" }}<br>
                    {% if n.veterinarian %}
                        <strong>V√©t√©rinaire :</strong> {{ n.veterinarian }}<br>
                    {% endif %}
                    <strong>Cr√©√©e le :</strong> {{ n.created_at.strftime('%d/%m/%Y %H:%M') }}<br>
                    {% if n.updated_at %}
                        <strong>Modifi√©e le :</strong> {{ n.updated_at.strftime('%d/%m/%Y %H:%M') }}
                    {% endif %}
                </p>
            </div>

            <!-- Modal √©dition note -->
            <div class="modal fade" id="editNoteModal-{{ n.id }}" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog">
                <form class="modal-content" method="POST"
                      action="{{ url_for('edit_note', note_id=n.id) }}">
                  <div class="modal-header">
                    <h5 class="modal-title">Modifier la note</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                  </div>
                  <div class="modal-body">

                    <div class="mb-2">
                        <label class="form-label">Contenu</label>
                        <textarea name="content" class="form-control" rows="3">{{ n.content }}</textarea>
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Auteur</label>
                        <select name="author" class="form-select">
                            <option value="">‚Äî</option>
                            {% for e in employees %}
                                <option value="{{ e.name }}" {% if n.author == e.name %}selected{% endif %}>
                                    {{ e.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-2">
                        <label class="form-label">V√©t√©rinaire</label>
                        <select name="veterinarian" class="form-select">
                            <option value="">‚Äî</option>
                            {% for v in veterinarians %}
                                <option value="{{ v.name }}" {% if n.veterinarian == v.name %}selected{% endif %}>
                                    {{ v.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <p class="text-muted small mb-0">
                        <strong>Cr√©√©e le :</strong> {{ n.created_at.strftime('%d/%m/%Y %H:%M') }}<br>
                        {% if n.updated_at %}
                            <strong>Derni√®re modif :</strong> {{ n.updated_at.strftime('%d/%m/%Y %H:%M') }}
                        {% endif %}
                    </p>

                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button class="btn btn-primary">Enregistrer</button>
                  </div>
                </form>
              </div>
            </div>

            {% endfor %}
            {% if notes|length == 0 %}
                <p class="text-muted">Aucune note.</p>
            {% endif %}

        </div>
<!-- ‚ñà‚ñà‚ñà‚ñà‚ñà T√ÇCHES ‚ñà‚ñà‚ñà‚ñà‚ñà -->
        <div class="tab-pane fade" id="tasks" role="tabpanel">

            <h3 class="mt-3">Ajouter une t√¢che</h3>

            <form action="{{ url_for('create_cat_task', cat_id=cat.id) }}"
                  method="POST" class="row g-3 mt-2 mb-4">

                <div class="col-md-4">
                    <label class="form-label">Type de t√¢che</label>
                    <select name="task_type_id" class="form-select" required>
                        <option value="">‚Äî Choisir une t√¢che ‚Äî</option>
                        {% for tt in task_types %}
                            <option value="{{ tt.id }}">{{ tt.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Note</label>
                    <input type="text" name="note" class="form-control"
                           placeholder="D√©tails, consigne...">
                </div>

                <div class="col-md-3">
                    <label class="form-label">Date d'√©ch√©ance</label>
                    <input type="date" name="due_date" class="form-control">
                </div>

                <div class="col-md-1 d-flex align-items-end">
                    <button class="btn btn-success w-100">Ajouter</button>
                </div>
            </form>

            <hr>

            <h3 class="mt-4">T√¢ches √† effectuer</h3>

            {% if todo %}
                <table class="table table-bordered mt-3">
                    <thead>
                        <tr>
                            <th>T√¢che</th>
                            <th>Note</th>
                            <th>Ajout√©e le</th>
                            <th>√âch√©ance</th>
                            <th>Statut</th>
                            <th>Fait par</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>

                        {% for t in todo %}
                        <tr>
                            <td>{{ t.task_type.name }}</td>
                            <td>{{ t.note or "‚Äî" }}</td>
                            <td>{{ t.created_at.strftime('%d/%m/%Y') }}</td>

                            <td>
                                {% if t.due_date %}
                                    {{ t.due_date.strftime('%d/%m/%Y') }}
                                {% else %}
                                    ‚Äî{% endif %}
                            </td>

                            <td><span class="badge bg-warning text-dark">√Ä faire</span></td>

                            <td>
                                <select class="form-select form-select-sm done-by-select">
                                    <option value="">‚Äî</option>
                                    {% for e in employees %}
                                        <option value="{{ e.name }}">{{ e.name }}</option>
                                    {% endfor %}
                                </select>
                            </td>

                            <td>

                                <form action="{{ url_for('toggle_cat_task', cat_id=cat.id, task_id=t.id) }}"
                                      method="POST" class="toggle-form d-inline">

                                    <input type="hidden" name="done_by" value="">
                                    <button type="submit" class="btn btn-sm btn-outline-primary validate-btn" disabled>
                                        ‚úì Fait
                                    </button>
                                </form>

                                <form action="{{ url_for('delete_cat_task', cat_id=cat.id, task_id=t.id) }}"
                                      method="POST" class="d-inline"
                                      onsubmit="return confirm('Supprimer cette t√¢che ?');">
                                    <button class="btn btn-sm btn-outline-danger">üóë</button>
                                </form>

                            </td>
                        </tr>
                        {% endfor %}

                    </tbody>
                </table>
            {% else %}
                <p class="text-muted mt-3">Aucune t√¢che √† effectuer.</p>
            {% endif %}

            <hr>

            <h3 class="mt-4">T√¢ches effectu√©es</h3>

            {% set done_with_date = tasks|selectattr("is_done", "equalto", True)
                                      |rejectattr("done_at", "equalto", None)
                                      |sort(attribute="done_at", reverse=True)
                                      |list %}
            {% set done_without_date = tasks|selectattr("is_done", "equalto", True)
                                        |selectattr("done_at", "equalto", None)
                                        |list %}
            {% set done = done_with_date + done_without_date %}

            {% if done %}
                <table class="table table-bordered mt-3">
                    <thead>
                        <tr>
                            <th>T√¢che</th>
                            <th>Note</th>
                            <th>Fait par</th>
                            <th>Fait le</th>
                        </tr>
                    </thead>

                    <tbody>
                        {% for t in done %}
                        <tr class="table-success">
                            <td>{{ t.task_type.name }}</td>
                            <td>{{ t.note or "‚Äî" }}</td>
                            <td>{{ t.done_by or "‚Äî" }}</td>
                            <td>
                                {% if t.done_at %}
                                    {{ t.done_at.strftime('%d/%m/%Y %H:%M') }}
                                {% else %}‚Äî{% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>

                </table>
            {% else %}
                <p class="text-muted mt-3">Aucune t√¢che effectu√©e.</p>
            {% endif %}

        </div> <!-- fin t√¢ches -->

    </div> <!-- fin tab-content -->
</div> <!-- fin container -->

<!-- Scripts -->
<script>
document.addEventListener("DOMContentLoaded", () => {

    // Upload photo
    const fileInput = document.getElementById("photoInput");
    const submitBtn = document.getElementById("submitPhotoBtn");

    fileInput.addEventListener("change", () => {
        if (fileInput.files.length > 0) {
            submitBtn.classList.remove("d-none");
        }
    });

    // Activation onglet via ?tab=tasks
    const urlParams = new URLSearchParams(window.location.search);
    const tab = urlParams.get("tab");
    if (tab) {
        const trigger = document.querySelector(`[data-bs-target="#${tab}"]`);
        if (trigger) new bootstrap.Tab(trigger).show();
    }

    // Gestion du choix "Fait par" ‚Üí active le bouton quand un employ√© est choisi
    document.querySelectorAll("tr").forEach(row => {
        const select = row.querySelector(".done-by-select");
        const form = row.querySelector(".toggle-form");
        const hidden = form?.querySelector('input[name="done_by"]');
        const btn = form?.querySelector(".validate-btn");

        if (!select || !form) return;

        select.addEventListener("change", () => {
            hidden.value = select.value;
            btn.disabled = !select.value;
        });
    });

});
</script>

{% endblock %}
