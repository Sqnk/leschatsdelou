{% extends "base.html" %}
{% block content %}

<div class="container mt-4">

    <h1>Prise de rendez-vous</h1>

    <!-- Formulaire création RDV -->
    <form action="{{ url_for('appointments_create') }}" method="POST" class="mt-4">

        <div class="row mb-3">
            <div class="col-md-4">
                <label class="form-label">Date & heure</label>
                <input type="datetime-local" name="date" class="form-control" required>
            </div>

            <div class="col-md-4">
                <label class="form-label">Lieu</label>
                <select name="location" class="form-select">
                    <option value="">Lieu du rendez-vous</option>
                    {% for v in veterinarians %}
                        <option value="{{ v.name }}">{{ v.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-4">
                <label class="form-label">Créé par</label>
                <select name="created_by" class="form-select">
                    <option value="">—</option>
                    {% for e in employees %}
                        <option value="{{ e.name }}">{{ e.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <hr>

        <!-- ======================== CHATS DISPONIBLES / SELECTED ======================== -->
        <div class="row">
            
            <!-- CHATS DISPONIBLES -->
            <div class="col-md-6">
                <label><strong>Chats disponibles</strong></label>
                <div class="p-2 border rounded" style="min-height:150px; max-height:250px; overflow-y:auto;">

                    <!-- Barre de recherche -->
                    <input type="text" id="searchCat" class="form-control mb-2"
                        placeholder="Rechercher un chat...">

                    <div id="catsContainer">
                        {% for c in cats %}
                            <div class="cat-pill" data-id="{{ c.id }}">{{ c.name }}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- CHATS SELECTIONNÉS -->
            <div class="col-md-6">
                <label><strong>Chats sélectionnés</strong></label>
                <div class="p-2 border rounded" style="min-height:150px; max-height:250px; overflow-y:auto;">
                    <div id="selectedCats"></div>
                </div>
            </div>
        </div>

        <!-- Champ caché pour Submission -->
        <div id="hiddenCatsContainer"></div>

        <hr>

        <!-- EMPLOYÉS -->
        <h4 class="mt-3">Employés assignés</h4>

        <div class="row">
            {% for e in employees %}
                <div class="col-md-3 mt-2">
                    <label class="border p-2 rounded w-100 d-block">
                        <input type="checkbox" name="employees[]" value="{{ e.id }}">
                        {{ e.name }}
                    </label>
                </div>
            {% endfor %}
        </div>

        <button class="btn btn-primary mt-4">Créer le rendez-vous</button>
    </form>


    <!-- ======================== RDV À VENIR ======================== -->
    <h2 class="mt-5">À venir</h2>

    {% for a in upcoming %}
    <div class="card p-3 mt-3">

        <div class="mb-2">
            <strong>{{ a.date.strftime("%d/%m/%Y %H:%M") }}</strong> — {{ a.location or "Rendez-vous" }}
        </div>

        <div>
            <strong>Créé par :</strong> {{ a.created_by or "—" }}
        </div>

        <div class="mt-2">
            <strong>Chats :</strong>
            {% for ac in a.cats %}
                {{ ac.cat.name }}{% if not loop.last %}, {% endif %}
            {% endfor %}
        </div>

        <div class="mt-2">
            <strong>Employés :</strong>
            {% for ae in a.employees %}
                {{ ae.employee.name }}{% if not loop.last %}, {% endif %}
            {% endfor %}
        </div>

        <div class="mt-3">
            <a href="{{ url_for('appointment_edit', appointment_id=a.id) }}" class="btn btn-outline-primary">Modifier</a>

            <form action="{{ url_for('appointment_delete', appointment_id=a.id) }}" method="POST"
                  class="d-inline" onsubmit="return confirm('Supprimer ce rendez-vous ?');">
                <button class="btn btn-outline-danger">Supprimer</button>
            </form>
        </div>

    </div>
    {% endfor %}


    <!-- ======================== RDV PASSES ======================== -->
    <h2 class="mt-5">Passés</h2>

    {% for a in past %}
    <div class="card p-3 mt-3">

        <div class="mb-2">
            <strong>{{ a.date.strftime("%d/%m/%Y %H:%M") }}</strong> — {{ a.location or "Rendez-vous" }}
        </div>

        <div>
            <strong>Créé par :</strong> {{ a.created_by or "—" }}
        </div>

        <div class="mt-2">
            <strong>Chats :</strong>
            {% for ac in a.cats %}
                {{ ac.cat.name }}{% if not loop.last %}, {% endif %}
            {% endfor %}
        </div>

        <div class="mt-2">
            <strong>Employés :</strong>
            {% for ae in a.employees %}
                {{ ae.employee.name }}{% if not loop.last %}, {% endif %}
            {% endfor %}
        </div>

    </div>
    {% endfor %}

</div>

<script>
let selected = [];

// Select chat
document.addEventListener("click", function(e){
    if(e.target.classList.contains("cat-pill")){
        let id = e.target.dataset.id;
        let name = e.target.innerText;

        if(!selected.includes(id)){
            selected.push(id);

            document.getElementById("selectedCats").innerHTML += `
                <div class="cat-pill cat-pill-selected" data-id="${id}">
                    ${name}
                    <button class="remove-btn" data-id="${id}">×</button>
                </div>`;

            updateHiddenField();
        }
    }

    if(e.target.classList.contains("remove-btn")){
        let id = e.target.dataset.id;
        selected = selected.filter(x => x !== id);
        document.querySelector('.cat-pill-selected[data-id="'+id+'"]').remove();
        updateHiddenField();
    }
});

// Update hidden field – FIXÉ
function updateHiddenField(){
    const container = document.getElementById("hiddenCatsContainer");
    container.innerHTML = "";

    selected.forEach(id => {
        container.innerHTML += `<input type="hidden" name="cats[]" value="${id}">`;
    });
}

// Search filter
document.getElementById("searchCat").addEventListener("input", function(){
    let q = this.value.toLowerCase();

    document.querySelectorAll("#catsContainer .cat-pill").forEach(el=>{
        el.style.display = el.innerText.toLowerCase().includes(q) ? "" : "none";
    });
});
</script>

{% endblock %}
