{% extends "base.html" %}
{% block content %}

<div class="container-fluid mt-4">

    <h1 class="mb-4">Rendez-vous</h1>

    <!-- ===================== ONGLET NAV ===================== -->
    <ul class="nav nav-tabs mb-4" id="apptTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-chats" data-bs-toggle="tab"
                data-bs-target="#content-chats" type="button" role="tab">
                Rendez-vous Chats
            </button>
        </li>

        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-general" data-bs-toggle="tab"
                data-bs-target="#content-general" type="button" role="tab">
                Autres rendez-vous
            </button>
        </li>
    </ul>

    <div class="tab-content">

        <!-- ===============================================================
            ONGLET 1 ‚Äî RDV CHATS
        ============================================================== -->
        <div class="tab-pane fade show active" id="content-chats" role="tabpanel">

            <div class="row">
                <div class="col-lg-7">

                    <div class="card mb-4">
                        <div class="card-header">
                            <strong>Nouveau rendez-vous (Chats)</strong>
                        </div>

                        <div class="card-body">
                            <form method="POST" action="{{ url_for('appointments_create') }}">

                                <!-- LIGNE COMPACT√âE : DATE + LIEU + EMPLOY√âS -->
                                <div class="row mb-3">
                                    
                                    <div class="col-md-4">
                                        <label class="form-label">Date et heure</label>
                                        <input type="datetime-local" name="date" class="form-control" required>
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">Lieu (V√©t√©rinaire)</label>
                                        <select name="location" class="form-select" required>
                                            <option value="">‚Äî Choisir un v√©t√©rinaire ‚Äî</option>
                                            {% for v in veterinarians %}
                                                <option value="{{ v.name }}">{{ v.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">Employ√©s pr√©sents</label>

                                        <div id="availableEmployees" class="list-group"
                                             style="min-height: 140px;">
                                            {% for e in employees %}
                                                <button type="button"
                                                        class="list-group-item list-group-item-action"
                                                        style="padding: 0.25rem 0.75rem;"
                                                        id="empbtn_{{ e.id }}"
                                                        onclick="selectEmployee({{ e.id }}, '{{ e.name }}')">
                                                    {{ e.name }}
                                                </button>
                                            {% endfor %}
                                        </div>
                                    </div>

                                </div>

                                <!-- CHATS : 2 COLONNES -->
                                <div class="row">

                                    <div class="col-md-8" style="min-height: 350px;">

                                        <label class="form-label">Rechercher un chat</label>
                                        <input type="text" id="catSearch" class="form-control" placeholder="Commencez √† taper un nom‚Ä¶">

                                        <div class="mt-3">
                                            <label class="form-label">Chats disponibles</label>

                                            <div id="availableCats" class="list-group"
                                                 style="height: 260px; max-height: 260px; overflow-y: auto;">

                                                {% for c in cats if c.need_vet %}
                                                    <button id="catbtn_{{c.id}}" type="button"
                                                        class="list-group-item list-group-item-action bg-warning"
                                                        style="padding: 0.25rem 0.75rem;"
                                                        onclick="selectCat({{ c.id }}, '{{ c.name }}')">
                                                        {{ c.name }} ‚Äî <strong>Besoin v√©to</strong>
                                                    </button>
                                                {% endfor %}

                                                {% for c in cats if not c.need_vet %}
                                                    <button id="catbtn_{{c.id}}" type="button"
                                                        class="list-group-item list-group-item-action"
                                                        style="padding: 0.25rem 0.75rem;"
                                                        onclick="selectCat({{ c.id }}, '{{ c.name }}')">
                                                        {{ c.name }}
                                                    </button>
                                                {% endfor %}

                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">Employ√©s s√©lectionn√©s</label>
                                        <div id="selectedEmployees" class="d-flex flex-wrap gap-2 mb-3"></div>

                                        <div style="margin-top: 20px;">
                                            <label class="form-label">Chats s√©lectionn√©s</label>
                                            <div id="selectedCats" class="d-flex flex-wrap gap-2"></div>
                                        </div>
                                    </div>
                                </div>

                                <div id="hiddenCatInputs"></div>
                                <div id="hiddenEmployeeInputs"></div>

                                <button class="btn btn-primary mt-3">Cr√©er</button>

                            </form>
                        </div>
                    </div>

                </div>

                <div class="col-lg-5">

                    <h3 class="mt-2">√Ä venir</h3>
                    {% if upcoming %}
                    <ul class="list-group mb-4">
                        {% for a in upcoming %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ a.date.strftime('%d/%m/%Y %H:%M') }}</strong>
                                ‚Äî {{ a.location }}

                                {% set cts = a.cats | map(attribute='cat.name') | join(', ') %}
                                {% if cts %}
                                <br><small><strong>Chats :</strong> {{ cts }}</small>
                                {% endif %}

                                {% set emps = a.employees | map(attribute='employee.name') | join(', ') %}
                                {% if emps %}
                                <br><small><strong>Employ√©s :</strong> {{ emps }}</small>
                                {% endif %}
                            </div>

                            <div class="d-flex gap-2">
                                <a href="{{ url_for('appointment_edit', appointment_id=a.id) }}" class="btn btn-sm btn-primary">Modifier</a>

                                <form method="POST" action="{{ url_for('appointment_delete', appointment_id=a.id) }}"
                                    onsubmit="return confirm('Supprimer ce rendez-vous ?');">
                                    <button class="btn btn-danger btn-sm">Supprimer</button>
                                </form>
                            </div>

                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted">Aucun rendez-vous √† venir.</p>
                    {% endif %}

                    <h3 class="mt-4">Pass√©s</h3>

{% if past %}

{% set grouped = {} %}

{# Regroupement ann√©e ‚Üí mois ‚Üí rdv #}
{% for appt in past %}
    {% set y = appt.date.year %}
    {% set m = appt.date.strftime("%B") %}
    {% if y not in grouped %}
        {% set _ = grouped.update({y:{}}) %}
    {% endif %}
    {% if m not in grouped[y] %}
        {% set _ = grouped[y].update({m:[]}) %}
    {% endif %}
    {% set _ = grouped[y][m].append(appt) %}
{% endfor %}

<div class="accordion" id="accordionYears">

{% for year, months in grouped.items()|sort(reverse=True) %}

    <div class="accordion-item">
        <h2 class="accordion-header" id="headingY{{ year }}">
            <button class="accordion-button collapsed" type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapseY{{ year }}">
                üìÖ {{ year }}
            </button>
        </h2>

        <div id="collapseY{{ year }}" class="accordion-collapse collapse"
             data-bs-parent="#accordionYears">
             
            <div class="accordion-body">

                <div class="accordion" id="accordionMonths{{ year }}">

                {% for month, rdvs in months.items()|sort(reverse=True) %}

                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingM{{ year }}{{ loop.index }}">
                            <button class="accordion-button collapsed" type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#collapseM{{ year }}{{ loop.index }}">
                                üìå {{ month|capitalize }}
                            </button>
                        </h2>

                        <div id="collapseM{{ year }}{{ loop.index }}" 
                             class="accordion-collapse collapse"
                             data-bs-parent="#accordionMonths{{ year }}">
                             
                            <div class="accordion-body p-2">

                                <ul class="list-group">
                                {% for appt in rdvs %}
                                    <li class="list-group-item">
                                        <strong>{{ appt.date.strftime("%d/%m/%Y %H:%M") }}</strong>
                                        ‚Äî {{ appt.veterinarian or appt.place }}

                                        {% if appt.cats %}
											<div>Chats :
												{{ appt.cats | map(attribute='name') | join(', ') }}
											</div>
										{% endif %}

                                        {% if appt.employees %}
                                            <div>Employ√©s :
                                                {{ ", ".join([e.name for e in appt.employees]) }}
                                            </div>
                                        {% endif %}
                                    </li>
                                {% endfor %}
                                </ul>

                            </div>
                        </div>
                    </div>

                {% endfor %}

                </div>
            </div>
        </div>
    </div>

				{% endfor %}
				</div>

				{% else %}
				<p>Aucun rendez-vous pass√©.</p>
				{% endif %}


                </div>

            </div>

        </div>

        <!-- ===============================================================
            ONGLET 2 ‚Äî AUTRES RDV (NOUVELLE VERSION)
        ============================================================== -->
        <div class="tab-pane fade" id="content-general" role="tabpanel">

            <div class="row">

                <!-- FORMULAIRE -->
                <div class="col-lg-7">

                    <div class="card mb-4">
                        <div class="card-header">
                            <strong>Nouvel autre rendez-vous</strong>
                        </div>

                        <div class="card-body">
                            <form method="POST" action="{{ url_for('appointments_create_general') }}">

                                <div class="row mb-3">

                                    <div class="col-md-4">
                                        <label class="form-label">Titre</label>
                                        <input type="text" name="title" class="form-control" required>
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">D√©but</label>
                                        <input type="datetime-local" name="start" class="form-control" required>
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">Fin</label>
                                        <input type="datetime-local" name="end" class="form-control">
                                    </div>

                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Note</label>
                                    <textarea name="note" class="form-control" rows="3"></textarea>
                                </div>

                                <button class="btn btn-primary mt-2">Cr√©er</button>
                            </form>
                        </div>
                    </div>

                </div>

                <!-- LISTE RDV -->
                <div class="col-lg-5">

                    <h3 class="mt-2">√Ä venir</h3>

                    {% set now = datetime.now(TZ_PARIS) %}
					{% set upcoming_general = general | selectattr('start', 'ge', now) | list %}


                    {% if upcoming_general %}
                    <ul class="list-group mb-4">
                        {% for g in upcoming_general %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">

                            <div>
                                <strong>{{ g.start.astimezone(TZ_PARIS).strftime('%d/%m/%Y %H:%M') }}</strong>
                                {% if g.end %}
                                    ‚Üí <strong>{{ g.end.astimezone(TZ_PARIS).strftime('%d/%m/%Y %H:%M') }}</strong>
                                {% endif %}
                                <br>
                                <span class="badge bg-secondary">{{ g.title }}</span>

                                {% if g.note %}
                                <br><small><strong>Note :</strong> {{ g.note }}</small>
                                {% endif %}
                            </div>

                            <div class="d-flex gap-2">
                                <a href="{{ url_for('general_appointment_edit', appointment_id=g.id) }}"
                                   class="btn btn-sm btn-primary">Modifier</a>

                                <form method="POST"
                                      action="{{ url_for('general_appointment_delete', appointment_id=g.id) }}"
                                      onsubmit="return confirm('Supprimer ce rendez-vous ?');">
                                    <button class="btn btn-sm btn-danger">Supprimer</button>
                                </form>
                            </div>

                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted">Aucun rendez-vous √† venir.</p>
                    {% endif %}

                    <h3 class="mt-4">Pass√©s</h3>

                    {% set past_general = general | selectattr('start', 'lt', now) | list %}

                    {% if past_general %}
                    <ul class="list-group">
                        {% for g in past_general %}
                        <li class="list-group-item">

                            <strong>{{ g.start.astimezone(TZ_PARIS).strftime('%d/%m/%Y %H:%M') }}</strong>
                            {% if g.end %}
                                ‚Üí <strong>{{ g.end.strftime('%d/%m/%Y %H:%M') }}</strong>
                            {% endif %}
                            <br>
                            <span class="badge bg-secondary">{{ g.title }}</span>

                            {% if g.note %}
                            <br><small><strong>Note :</strong> {{ g.note }}</small>
                            {% endif %}

                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted">Aucun rendez-vous pass√©.</p>
                    {% endif %}

                </div>

            </div>

        </div>

    </div>
</div>

<!-- ===============================================================
     SCRIPT : AJOUT / SUPPRESSION DES CHATS + EMPLOY√âS
=============================================================== -->
<script>
    const searchInput = document.getElementById("catSearch");
    const selectedList = document.getElementById("selectedCats");
    const hiddenInputs = document.getElementById("hiddenCatInputs");
    const availableDiv = document.getElementById("availableCats");

    const selectedEmployeesDiv = document.getElementById("selectedEmployees");
    const hiddenEmployeeInputs = document.getElementById("hiddenEmployeeInputs");
    const availableEmployeesDiv = document.getElementById("availableEmployees");

    let selectedCats = [];
    let selectedEmployees = [];

    function hideAvailable(id) {
        const btn = document.getElementById("catbtn_" + id);
        if (btn) btn.style.display = "none";
    }

    function showAvailable(id) {
        const btn = document.getElementById("catbtn_" + id);
        if (!btn) return;

        const q = searchInput.value.trim().toLowerCase();
        const text = btn.textContent.toLowerCase();
        btn.style.display = (q === "" || text.includes(q)) ? "" : "none";
    }

    function selectCat(id, name) {
        if (selectedCats.includes(id)) return;

        selectedCats.push(id);
        hideAvailable(id);

        const tag = document.createElement("div");
        tag.classList.add("border", "rounded-pill", "px-2", "py-1", "d-flex", "align-items-center");
        tag.style.fontSize = "0.8rem";
        tag.style.background = "#f8f9fa";
        tag.id = "tag_" + id;

        tag.innerHTML = `${name} <button type="button" class="btn-close ms-2"></button>`;

        tag.querySelector("button").onclick = () => {
            selectedCats = selectedCats.filter(x => x !== id);
            tag.remove();
            document.getElementById("cat_" + id)?.remove();
            showAvailable(id);
        };

        selectedList.appendChild(tag);

        const hidden = document.createElement("input");
        hidden.type = "hidden";
        hidden.name = "cats[]";
        hidden.id = "cat_" + id;
        hidden.value = id;
        hiddenInputs.appendChild(hidden);
    }

    function hideEmployee(id) {
        const btn = document.getElementById("empbtn_" + id);
        if (btn) btn.style.display = "none";
    }

    function showEmployee(id) {
        const btn = document.getElementById("empbtn_" + id);
        if (btn) btn.style.display = "";
    }

    function selectEmployee(id, name) {
        if (selectedEmployees.includes(id)) return;

        selectedEmployees.push(id);
        hideEmployee(id);

        const tag = document.createElement("div");
        tag.classList.add("border", "rounded-pill", "px-2", "py-1", "d-flex", "align-items-center");
        tag.style.fontSize = "0.8rem";
        tag.style.background = "#f8f9fa";
        tag.id = "emptag_" + id;

        tag.innerHTML = `${name} <button type="button" class="btn-close ms-2"></button>`;

        tag.querySelector("button").onclick = () => {
            selectedEmployees = selectedEmployees.filter(x => x !== id);
            tag.remove();
            document.getElementById("emp_" + id)?.remove();
            showEmployee(id);
        };

        selectedEmployeesDiv.appendChild(tag);

        const hidden = document.createElement("input");
        hidden.type = "hidden";
        hidden.name = "employees[]";
        hidden.id = "emp_" + id;
        hidden.value = id;
        hiddenEmployeeInputs.appendChild(hidden);
    }

    searchInput.addEventListener("input", () => {
        const q = searchInput.value.trim().toLowerCase();
        const buttons = availableDiv.querySelectorAll("button");

        buttons.forEach(btn => {
            const id = parseInt(btn.id.replace("catbtn_", ""));
            const text = btn.textContent.toLowerCase();
            const matches = (q === "" || text.includes(q));

            btn.style.display = (!selectedCats.includes(id) && matches) ? "" : "none";
        });
    });
</script>

{% endblock %}
