{% extends "base.html" %}
{% block content %}

<h2 class="mb-3">Vermifuge group√©</h2>

<div class="row g-4">
  <!-- FORMULAIRE (2/3) -->
  <div class="col-lg-8">
    <div class="card shadow-sm">
      <div class="card-body">

        <form method="POST">
          <!-- Date commune -->
          <div class="row mb-3 align-items-end">
            <div class="col-sm-4">
              <label class="form-label">Date du vermifuge</label>
              <input
                type="date"
                name="date"
                class="form-control"
                value="{{ today.strftime('%Y-%m-%d') }}"
              >
            </div>
            <div class="col-sm-8 text-muted small">
              S√©lectionnez les chats, puis renseignez type, r√©action et poids.
            </div>
          </div>

          <!-- Recherche chat -->
          <div class="row mb-3">
            <div class="col-sm-6">
              <label class="form-label mb-1">Rechercher un chat</label>
              <input
                type="text"
                id="batchCatSearch"
                class="form-control form-control-sm"
                placeholder="Tapez un nom ou un num√©ro d‚Äôidentification"
              >
            </div>
          </div>

          <!-- Tableau chats -->
          <div class="table-responsive">
            <table class="table table-sm align-middle" id="batchCatsTable">
              <thead>
                <tr>
                  <th style="width:40px;">
                    <input type="checkbox" id="batchSelectAll">
                  </th>
                  <th>Chat</th>
                  <th style="width:200px;">Type de vermifuge</th>
                  <th style="width:150px;">R√©action</th>
                  <th style="width:120px;">Poids (kg)</th>
                </tr>
              </thead>
              <tbody>
                {% for cat in cats %}
                <tr class="batch-cat-row">
                  <td>
                    <input
                      type="checkbox"
                      class="form-check-input batch-cat-select"
                      name="selected_{{ cat.id }}"
                    >
                    <input type="hidden" name="cat_ids" value="{{ cat.id }}">
                  </td>

                  <td class="batch-cat-name">
                    <div class="d-flex align-items-center">
                      <div class="me-2">
                        <img
                          src="{% if cat.photo_filename %}{{ url_for('uploads', filename=cat.photo_filename) }}{% else %}{{ url_for('static', filename='uploads/default.png') }}{% endif %}"
                          alt="{{ cat.name }}"
                          class="rounded"
                          style="width:32px;height:32px;object-fit:cover;"
                        >
                      </div>
                      <div class="small">
                        <strong>{{ cat.name }}</strong>
                        <br>
                        <span class="text-muted">
                          {% if cat.identification_number %}
                            <span class="batch-cat-ident">
                              {{ cat.identification_number }}
                            </span>
                          {% endif %}

                          {% set weights_sorted = cat.weights|sort(attribute='date') %}
                          {% if weights_sorted %}
                            {% set last_w = weights_sorted[-1] %}
                            {% if cat.identification_number %} ‚Äî {% endif %}
                            Derni√®re pes√©e :
                            {{ "%.1f"|format(last_w.weight) }} kg
                            le {{ last_w.date.strftime("%d/%m/%Y") }}
                          {% else %}
                            {% if cat.identification_number %} ‚Äî {% endif %}
                            Aucune derni√®re pes√©e pr√©sente
                          {% endif %}
                        </span>
                      </div>
                    </div>
                  </td>

                  <td>
                    <select
                      name="deworming_type_{{ cat.id }}"
                      class="form-select form-select-sm"
                    >
                      <option value="">‚Äî</option>
                      {% for t in deworming_types %}
                        <option value="{{ t.id }}">{{ t.name }}</option>
                      {% endfor %}
                    </select>
                  </td>
                  <td>
                    <input
                      type="text"
                      name="reaction_{{ cat.id }}"
                      class="form-control form-control-sm"
                    >
                  </td>
                  <td>
                    <input
                      type="text"
                      name="weight_{{ cat.id }}"
                      class="form-control form-control-sm"
                      placeholder="3.2"
                    >
                  </td>
                </tr>
                {% endfor %}

                {% if cats|length == 0 %}
                <tr>
                  <td colspan="5" class="text-center text-muted">
                    Aucun chat √©ligible pour le vermifuge group√©.
                  </td>
                </tr>
                {% endif %}
              </tbody>
            </table>
          </div>

          <div class="mt-3 text-end">
            <button class="btn btn-primary">
              üíä Enregistrer le vermifuge group√©
            </button>
          </div>
        </form>

      </div>
    </div>
  </div>

  <!-- HISTORIQUE (1/3) -->
  <div class="col-lg-4">
  <div class="card">
    <div class="card-header">
      Historique des vermifuges group√©s
    </div>
    <div class="card-body" style="max-height: 70vh; overflow-y: auto;">
      {% if batch_history %}
        <div class="accordion accordion-flush" id="batchHistoryAccordion">
          {% for batch in batch_history %}
            <div class="accordion-item">
              <h2 class="accordion-header" id="batchHeading{{ batch.id }}">
                <button class="accordion-button collapsed py-2"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#batchCollapse{{ batch.id }}"
                        aria-expanded="false"
                        aria-controls="batchCollapse{{ batch.id }}">
                  {{ batch.date.strftime("%d/%m/%Y") }} ‚Äî {{ batch.items|length }} chat(s)
                </button>
              </h2>
              <div id="batchCollapse{{ batch.id }}"
                   class="accordion-collapse collapse"
                   aria-labelledby="batchHeading{{ batch.id }}"
                   data-bs-parent="#batchHistoryAccordion">
                <div class="accordion-body p-2">

                  <div class="accordion accordion-flush" id="batchCats{{ batch.id }}">
                    {% for item in batch.items %}
                      <div class="accordion-item">
                        <h2 class="accordion-header" id="batchCatHeading{{ batch.id }}_{{ item.id }}">
                          <button class="accordion-button collapsed py-1"
                                  type="button"
                                  data-bs-toggle="collapse"
                                  data-bs-target="#batchCatCollapse{{ batch.id }}_{{ item.id }}"
                                  aria-expanded="false"
                                  aria-controls="batchCatCollapse{{ batch.id }}_{{ item.id }}">
                            {{ item.cat.name }}
                            {% if item.cat.identification_number %}
                              <span class="text-muted ms-1">
                                ‚Äî {{ item.cat.identification_number }}
                              </span>
                            {% endif %}
                          </button>
                        </h2>
                        <div id="batchCatCollapse{{ batch.id }}_{{ item.id }}"
                             class="accordion-collapse collapse"
                             aria-labelledby="batchCatHeading{{ batch.id }}_{{ item.id }}"
                             data-bs-parent="#batchCats{{ batch.id }}">
                          <div class="accordion-body py-2 small">
                            <ul class="mb-0">
                              <li>
                                Type de vermifuge :
                                {% if item.deworming and item.deworming.deworming_type %}
                                  {{ item.deworming.deworming_type.name }}
                                {% else %}‚Äî{% endif %}
                              </li>
                              <li>
                                Poids :
                                {% if item.weight %}
                                  {{ "%.1f"|format(item.weight.weight) }} kg
                                {% else %}‚Äî{% endif %}
                              </li>
                              <li>
                                R√©action :
                                {% if item.deworming and item.deworming.reaction %}
                                  {{ item.deworming.reaction }}
                                {% else %}‚Äî{% endif %}
                              </li>
                            </ul>
                          </div>
                        </div>
                      </div>
                    {% endfor %}
                  </div>

                  <div class="mt-2 text-end">
                    <button type="button"
                            class="btn btn-sm btn-outline-danger"
                            data-bs-toggle="modal"
                            data-bs-target="#deleteBatchModal"
                            data-batch-id="{{ batch.id }}"
                            data-batch-date="{{ batch.date.strftime('%d/%m/%Y') }}"
                            data-batch-count="{{ batch.items|length }}"
                            data-batch-cats="{% for item in batch.items %}{{ item.cat.name }}{% if not loop.last %}|||{% endif %}{% endfor %}">
                      Supprimer ce vermifuge group√©
                    </button>
                  </div>

                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-muted small mb-0">
          Aucun vermifuge group√© enregistr√© pour le moment.
        </p>
      {% endif %}
    </div>
  </div>
</div>
<!-- Modal de suppression d'un vermifuge group√© -->
<div class="modal fade" id="deleteBatchModal" tabindex="-1" aria-labelledby="deleteBatchModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" id="deleteBatchForm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteBatchModalLabel">Supprimer le vermifuge group√©</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <p id="deleteBatchMessage" class="mb-3"></p>
          <div id="deleteBatchCatsAccordion" class="accordion accordion-flush"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-danger">Supprimer</button>
        </div>
      </div>
    </form>
  </div>
</div>


<script>
document.addEventListener("DOMContentLoaded", function () {
  const dateInput = document.getElementById("dewormingDateInput");
  const hiddenDate = document.getElementById("hiddenDewormingDate");
  const searchInput = document.getElementById("searchCatInput");
  const rows = document.querySelectorAll("[data-cat-row]");
  const selectAll = document.getElementById("batchSelectAll");
  const checkboxes = document.querySelectorAll(".batch-cat-checkbox");

  // --- synchro date visible / hidden ---
  if (dateInput && hiddenDate) {
    const syncDate = () => {
      hiddenDate.value = dateInput.value || "";
    };
    dateInput.addEventListener("change", syncDate);
    syncDate();
  }

  // --- recherche dynamique ---
  if (searchInput && rows.length) {
    searchInput.addEventListener("input", function () {
      const q = this.value.trim().toLowerCase();
      rows.forEach(function (row) {
        const name = row.getAttribute("data-cat-name") || "";
        row.style.display = name.includes(q) ? "" : "none";
      });
    });
  }

  // --- select all ---
  if (selectAll && checkboxes.length) {
    selectAll.addEventListener("change", function () {
      const checked = this.checked;
      checkboxes.forEach(function (cb) {
        if (!cb.disabled && cb.closest("tr").style.display !== "none") {
          cb.checked = checked;
        }
      });
    });
  }

  // --- Modal suppression d'un batch ---
  const deleteModal = document.getElementById("deleteBatchModal");
  const deleteUrlBase = "{{ url_for('delete_deworming_batch', batch_id=0) }}";

  if (deleteModal) {
    deleteModal.addEventListener("show.bs.modal", function (event) {
      const button = event.relatedTarget;
      if (!button) return;

      const batchId = button.getAttribute("data-batch-id");
      const date = button.getAttribute("data-batch-date");
      const count = button.getAttribute("data-batch-count");
      const catsRaw = button.getAttribute("data-batch-cats") || "";
      const cats = catsRaw ? catsRaw.split("|||") : [];

      // Message
      const msgEl = deleteModal.querySelector("#deleteBatchMessage");
      if (msgEl) {
        msgEl.textContent =
          "Vous allez supprimer les entr√©es poids et vermifuge de " +
          count +
          " chat(s) pour la date du " +
          date +
          ". √ätes-vous s√ªr(e) de vouloir continuer ?";
      }

      // Accord√©on des chats
      const acc = deleteModal.querySelector("#deleteBatchCatsAccordion");
      if (acc) {
        acc.innerHTML = "";
        cats.forEach(function (name, idx) {
          if (!name) return;
          const item = document.createElement("div");
          item.className = "accordion-item";
          item.innerHTML =
            '<h2 class="accordion-header" id="delCatHeading' + idx + '">' +
            '<button class="accordion-button collapsed py-1" type="button" ' +
            'data-bs-toggle="collapse" data-bs-target="#delCatCollapse' + idx + '" ' +
            'aria-expanded="false" aria-controls="delCatCollapse' + idx + '">' +
            name +
            "</button></h2>" +
            '<div id="delCatCollapse' + idx + '" class="accordion-collapse collapse" ' +
            'aria-labelledby="delCatHeading' + idx + '">' +
            '<div class="accordion-body py-2 small">' +
            "Les entr√©es de poids et de vermifuge pour ce chat seront supprim√©es." +
            "</div></div>";
          acc.appendChild(item);
        });
      }

      // Action du formulaire
      const form = deleteModal.querySelector("#deleteBatchForm");
      if (form) {
        form.action = deleteUrlBase.replace("0", batchId);
      }
    });
  }
});
</script>

{% endblock %}
