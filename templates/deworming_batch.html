{% extends "base.html" %}
{% block content %}

<h2 class="mb-3">Vermifuge group√©</h2>

<div class="row g-4">
  <!-- FORMULAIRE (2/3) -->
  <div class="col-lg-8">
    <div class="card shadow-sm">
      <div class="card-body">

        <form method="POST">
          <!-- Date commune -->
          <div class="row mb-3 align-items-end">
            <div class="col-sm-4">
              <label class="form-label">Date du vermifuge</label>
              <input
                type="date"
                name="date"
                class="form-control"
                value="{{ today.strftime('%Y-%m-%d') }}"
              >
            </div>
            <div class="col-sm-8 text-muted small">
              S√©lectionnez les chats, puis renseignez type, r√©action et poids.
            </div>
          </div>

          <!-- Recherche chat -->
          <div class="row mb-3">
            <div class="col-sm-6">
              <label class="form-label mb-1">Rechercher un chat</label>
              <input
                type="text"
                id="batchCatSearch"
                class="form-control form-control-sm"
                placeholder="Tapez un nom ou un num√©ro d‚Äôidentification"
              >
            </div>
          </div>

          <!-- Tableau chats -->
          <div class="table-responsive">
            <table class="table table-sm align-middle" id="batchCatsTable">
              <thead>
                <tr>
                  <th style="width:40px;">
                    <input type="checkbox" id="batchSelectAll">
                  </th>
                  <th>Chat</th>
                  <th style="width:200px;">Type de vermifuge</th>
                  <th style="width:150px;">R√©action</th>
                  <th style="width:120px;">Poids (kg)</th>
                </tr>
              </thead>
              <tbody>
                {% for cat in cats %}
                <tr class="batch-cat-row">
                  <td>
                    <input
                      type="checkbox"
                      class="form-check-input batch-cat-select"
                      name="selected_{{ cat.id }}"
                    >
                    <input type="hidden" name="cat_ids" value="{{ cat.id }}">
                  </td>

                  <td class="batch-cat-name">
                    <div class="d-flex align-items-center">
                      <div class="me-2">
                        <img
                          src="{% if cat.photo_filename %}{{ url_for('uploads', filename=cat.photo_filename) }}{% else %}{{ url_for('static', filename='uploads/default.png') }}{% endif %}"
                          alt="{{ cat.name }}"
                          class="rounded"
                          style="width:32px;height:32px;object-fit:cover;"
                        >
                      </div>
                      <div class="small">
                        <strong>{{ cat.name }}</strong>
                        <br>
                        <span class="text-muted">
                          {% if cat.identification_number %}
                            <span class="batch-cat-ident">
                              {{ cat.identification_number }}
                            </span>
                          {% endif %}

                          {% set weights_sorted = cat.weights|sort(attribute='date') %}
                          {% if weights_sorted %}
                            {% set last_w = weights_sorted[-1] %}
                            {% if cat.identification_number %} ‚Äî {% endif %}
                            Derni√®re pes√©e :
                            {{ "%.1f"|format(last_w.weight) }} kg
                            le {{ last_w.date.strftime("%d/%m/%Y") }}
                          {% else %}
                            {% if cat.identification_number %} ‚Äî {% endif %}
                            Aucune derni√®re pes√©e pr√©sente
                          {% endif %}
                        </span>
                      </div>
                    </div>
                  </td>

                  <td>
                    <select
                      name="deworming_type_{{ cat.id }}"
                      class="form-select form-select-sm"
                    >
                      <option value="">‚Äî</option>
                      {% for t in deworming_types %}
                        <option value="{{ t.id }}">{{ t.name }}</option>
                      {% endfor %}
                    </select>
                  </td>
                  <td>
                    <input
                      type="text"
                      name="reaction_{{ cat.id }}"
                      class="form-control form-control-sm"
                    >
                  </td>
                  <td>
                    <input
                      type="text"
                      name="weight_{{ cat.id }}"
                      class="form-control form-control-sm"
                      placeholder="3.2"
                    >
                  </td>
                </tr>
                {% endfor %}

                {% if cats|length == 0 %}
                <tr>
                  <td colspan="5" class="text-center text-muted">
                    Aucun chat √©ligible pour le vermifuge group√©.
                  </td>
                </tr>
                {% endif %}
              </tbody>
            </table>
          </div>

          <div class="mt-3 text-end">
            <button class="btn btn-primary">
              üíä Enregistrer le vermifuge group√©
            </button>
          </div>
        </form>

      </div>
    </div>
  </div>

  <!-- HISTORIQUE (1/3) -->
  <div class="col-lg-4">
    <div class="card shadow-sm">
      <div class="card-header">
        Historique des vermifuges group√©s
      </div>
      <div class="card-body text-muted small">
        L'historique d√©taill√© des vermifuges group√©s sera affich√© ici plus tard.
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // --- Recherche dynamique ---
  const input = document.getElementById("batchCatSearch");
  const rows = document.querySelectorAll("#batchCatsTable tbody tr.batch-cat-row");

  if (input) {
    input.addEventListener("input", function () {
      const term = this.value.toLowerCase().trim();

      rows.forEach(function (row) {
        const nameCell = row.querySelector(".batch-cat-name");
        const identCell = row.querySelector(".batch-cat-ident");
        const text = (
          (nameCell ? nameCell.textContent : "") + " " +
          (identCell ? identCell.textContent : "")
        ).toLowerCase();

        if (!term || text.includes(term)) {
          row.style.display = "";
        } else {
          row.style.display = "none";
        }
      });
    });
  }

  // --- Checkbox "tout s√©lectionner" ---
  const selectAll = document.getElementById("batchSelectAll");
  if (selectAll) {
    selectAll.addEventListener("change", function () {
      const checkboxes = document.querySelectorAll(".batch-cat-select");
      checkboxes.forEach(function (cb) {
        cb.checked = selectAll.checked;
      });
    });
  }
});
</script>

{% endblock %}
