{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>üíä Vermifuge group√©</h2>
  </div>

  <form method="POST">
    <!-- Date commune -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-3">
            <label class="form-label">Date du vermifuge</label>
            <input type="date"
                   name="date"
                   class="form-control"
                   value="{{ today.strftime('%Y-%m-%d') }}">
          </div>
          <div class="col-md-9">
            <p class="text-muted mb-0">
              La date est commune pour tous les chats s√©lectionn√©s.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Tableau des chats -->
    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr>
                <th style="width:40px;">
                  <input type="checkbox" id="select-all">
                </th>
                <th>Chat</th>
                <th>Type de vermifuge</th>
                <th>Poids (kg)</th>
                <th>R√©action</th>
              </tr>
            </thead>
            <tbody>
              {% for cat in cats %}
              <tr>
                <td>
                  <input type="checkbox"
                         class="form-check-input cat-select"
                         name="selected_{{ cat.id }}">
                  <input type="hidden" name="cat_ids" value="{{ cat.id }}">
                </td>

                <!-- Chat : photo + infos + derni√®re pes√©e -->
                <td>
                  <div class="d-flex align-items-center">
                    <div class="me-2">
                      <img
                        src="{% if cat.photo_filename %}{{ url_for('uploads', filename=cat.photo_filename) }}{% else %}{{ url_for('static', filename='uploads/default.png') }}{% endif %}"
                        alt="{{ cat.name }}"
                        class="rounded"
                        style="width:36px;height:36px;object-fit:cover;">
                    </div>
                    <div class="small">
                      <a href="{{ url_for('cat_detail', cat_id=cat.id) }}"
                         target="_blank"
                         class="fw-semibold text-decoration-none">
                        {{ cat.name }}
                      </a>
                      {% if cat.status %}
                        <span class="badge bg-secondary ms-2">{{ cat.status }}</span>
                      {% endif %}

                      {% if cat.identification_number %}
                        <br>
                        <span class="text-muted">{{ cat.identification_number }}</span>
                      {% endif %}

                      {% set weights_sorted = cat.weights|sort(attribute='date') %}
                      {% if weights_sorted %}
                        {% set last_w = weights_sorted[-1] %}
                        <br>
                        <span class="text-muted">
                          Derni√®re pes√©e :
                          {{ "%.1f"|format(last_w.weight) }} kg
                          le {{ last_w.date.strftime("%d/%m/%Y") }}
                        </span>
                      {% else %}
                        <br>
                        <span class="text-muted">
                          Aucune derni√®re pes√©e pr√©sente
                        </span>
                      {% endif %}
                    </div>
                  </div>
                </td>

                <td style="min-width:220px;">
                  <select name="deworming_type_{{ cat.id }}"
                          class="form-select form-select-sm">
                    <option value="">‚Äî Choisir un type ‚Äî</option>
                    {% for t in deworming_types %}
                      <option value="{{ t.id }}">{{ t.name }}</option>
                    {% endfor %}
                  </select>
                </td>
                <td style="width:140px;">
                  <input type="text"
                         name="weight_{{ cat.id }}"
                         class="form-control form-control-sm"
                         placeholder="ex : 3,5">
                </td>
                <td>
                  <input type="text"
                         name="reaction_{{ cat.id }}"
                         class="form-control form-control-sm"
                         placeholder="R√©action √©ventuelle">
                </td>
              </tr>
              {% endfor %}
              {% if cats|length == 0 %}
              <tr>
                <td colspan="5" class="text-center text-muted">
                  Aucun chat pr√©sent dans le refuge.
                </td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>

        <div class="text-end mt-3">
          <button type="submit" class="btn btn-success">
            Enregistrer le vermifuge group√©
          </button>
        </div>
      </div>
    </div>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const selectAll = document.getElementById("select-all");
  if (!selectAll) return;

  selectAll.addEventListener("change", function () {
    document.querySelectorAll(".cat-select").forEach(cb => {
      cb.checked = selectAll.checked;
    });
  });
});
</script>
{% endblock %}
