{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
  <h2 class="mb-4">Vermifuge group√©</h2>

  <div class="row">
    <!-- ================== COLONNE FORMULAIRE (2/3) ================== -->
    <div class="col-lg-8">
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <form method="POST" action="{{ url_for('deworming_batch') }}">
            <!-- Date -->
            <div class="row mb-3">
              <div class="col-md-4">
                <label for="deworming_date" class="form-label">Date</label>
                <input type="date"
                       class="form-control"
                       id="deworming_date"
                       name="deworming_date"
                       value="{{ today.isoformat() }}">
              </div>
            </div>

            <!-- Recherche -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="batchCatSearch" class="form-label">
                  Rechercher un chat (nom ou n¬∞ d'identification)
                </label>
                <input type="text"
                       class="form-control"
                       id="batchCatSearch"
                       placeholder="Tapez un nom ou un num√©ro‚Ä¶">
              </div>
            </div>

            <!-- Tableau des chats -->
            <div class="table-responsive" style="max-height: 480px; overflow-y: auto;">
              <table class="table table-sm align-middle" id="batchCatsTable">
                <thead class="table-light">
                  <tr>
                    <th style="width: 40px;" class="text-center">
                      <input type="checkbox" id="batchSelectAll">
                    </th>
                    <th>Chat</th>
                    <th>Type de vermifuge</th>
                    <th style="width: 120px;">Poids (kg)</th>
                    <th>R√©action</th>
                  </tr>
                </thead>
                <tbody>
                {% for cat in cats %}
                  <tr class="batch-cat-row">
                    <!-- Checkbox + hidden id -->
                    <td class="text-center">
                      <input
                        type="checkbox"
                        class="form-check-input batch-cat-select"
                        name="selected_{{ cat.id }}"
                      >
                      <input type="hidden" name="cat_ids" value="{{ cat.id }}">
                    </td>

                    <!-- Chat (photo + infos) -->
                    <td>
                      <div class="d-flex align-items-center">
                        <img
						  src="{% if cat.photo_filename %}{{ url_for('uploads', filename=cat.photo_filename) }}{% else %}{{ url_for('static', filename='uploads/default.png') }}{% endif %}"
						  alt="{{ cat.name }}"
						  class="me-2"
						  style="width: 40px; height: 40px; object-fit: cover; border-radius: 50%;"
						/>
                        <div>
                          <div class="fw-semibold batch-cat-name">
                            {{ cat.name }}
                          </div>
                          <div class="text-muted small">
                            <span class="batch-cat-ident">
                              {% if cat.identification_number %}
                                {{ cat.identification_number }}
                              {% else %}
                                ‚Äî
                              {% endif %}
                            </span>
                            <span class="text-muted small ms-2">
                              ‚Ä¢ Dernier poids :
                              {% set lw = last_weights_map.get(cat.id) %}
                              {% if lw is not none %}
                                {{ "%.1f"|format(lw) }} kg
                              {% else %}
                                ‚Äî
                              {% endif %}
                            </span>
                          </div>
                        </div>
                      </div>
                    </td>

                    <!-- Type de vermifuge -->
                    <td>
                      <select class="form-select form-select-sm"
                              name="deworming_type_{{ cat.id }}">
                        <option value="">‚Äî</option>
                        {% for dt in deworming_types %}
                          <option value="{{ dt.id }}">{{ dt.name }}</option>
                        {% endfor %}
                      </select>
                    </td>

                    <!-- Poids -->
                    <td>
                      <input type="text"
                             class="form-control form-control-sm"
                             name="weight_{{ cat.id }}"
                             placeholder="Ex: 4.2">
                    </td>

                    <!-- R√©action -->
                    <td>
                      <input type="text"
                             class="form-control form-control-sm"
                             name="reaction_{{ cat.id }}"
                             placeholder="Optionnel">
                    </td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            </div>

            <div class="mt-3 text-end">
              <button type="submit" class="btn btn-primary">
                Enregistrer le vermifuge group√©
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- ================== COLONNE HISTORIQUE (1/3) ================== -->
    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-header">
          <strong>Historique des vermifuges group√©s</strong>
        </div>
        <div class="card-body small">
          {% if deworming_history %}
            <div class="accordion" id="dewormingHistoryAccordion">
              {% for date, items in deworming_history|dictsort(reverse=True) %}
                <div class="accordion-item">
                  <h2 class="accordion-header" id="historyHeading{{ loop.index }}">
                    <button class="accordion-button collapsed py-2"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#historyCollapse{{ loop.index }}"
                            aria-expanded="false"
                            aria-controls="historyCollapse{{ loop.index }}">
                      {{ date.strftime("%d/%m/%Y") }} ‚Äî {{ items|length }} chat(s)
                    </button>
                  </h2>
                  <div id="historyCollapse{{ loop.index }}"
                       class="accordion-collapse collapse"
                       aria-labelledby="historyHeading{{ loop.index }}"
                       data-bs-parent="#dewormingHistoryAccordion">
                    <div class="accordion-body p-2">
                      <ul class="list-group list-group-flush mb-2">
                        {% for row in items %}
                          <li class="list-group-item py-1 px-2">
                            <div class="fw-semibold">
                              {{ row.cat_name }}
                              {% if row.identification_number %}
                                <span class="text-muted ms-1">
                                  ({{ row.identification_number }})
                                </span>
                              {% endif %}
                            </div>
                            <div class="small text-muted">
                              Vermifuge :
                              {{ row.type_name or "‚Äî" }}<br>
                              Poids :
                              {% if row.weight is not none %}
                                {{ "%.1f"|format(row.weight) }} kg
                              {% else %}
                                ‚Äî
                              {% endif %}<br>
                              R√©action : {{ row.reaction or "‚Äî" }}
                            </div>
                          </li>
                        {% endfor %}
                      </ul>

                      <div class="text-end mt-2">
                        <button class="btn btn-sm btn-outline-danger"
                                data-bs-toggle="modal"
                                data-bs-target="#deleteBatchModal{{ loop.index }}">
                          üóëÔ∏è Supprimer ce lot
                        </button>
                      </div>

                      <!-- Modal de confirmation pour cette date -->
                      <div class="modal fade"
                           id="deleteBatchModal{{ loop.index }}"
                           tabindex="-1"
                           aria-labelledby="deleteBatchLabel{{ loop.index }}"
                           aria-hidden="true">
                        <div class="modal-dialog modal-lg modal-dialog-centered">
                          <div class="modal-content">
                            <form method="POST" action="{{ url_for('delete_deworming_batch') }}">
                              <div class="modal-header">
                                <h5 class="modal-title"
                                    id="deleteBatchLabel{{ loop.index }}">
                                  Confirmation de suppression ‚Äî {{ date.strftime("%d/%m/%Y") }}
                                </h5>
                                <button type="button"
                                        class="btn-close"
                                        data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                              </div>
                              <div class="modal-body">
                                <p>
                                  Vous allez supprimer les entr√©es
                                  <strong>poids</strong> et
                                  <strong>vermifuge</strong> de
                                  <strong>{{ items|length }}</strong> chats
                                  pour la date du
                                  <strong>{{ date.strftime("%d/%m/%Y") }}</strong>.
                                  √ätes-vous s√ªr de vouloir continuer ?
                                </p>

                                <div class="accordion" id="deleteCatsAcc{{ loop.index }}">
                                  <div class="accordion-item">
                                    <h2 class="accordion-header"
                                        id="deleteCatsHeading{{ loop.index }}">
                                      <button class="accordion-button collapsed py-2"
                                              type="button"
                                              data-bs-toggle="collapse"
                                              data-bs-target="#deleteCatsCollapse{{ loop.index }}">
                                        Voir le d√©tail des chats ({{ items|length }})
                                      </button>
                                    </h2>
                                    <div id="deleteCatsCollapse{{ loop.index }}"
                                         class="accordion-collapse collapse"
                                         data-bs-parent="#deleteCatsAcc{{ loop.index }}">
                                      <div class="accordion-body p-2">
                                        <ul class="list-group list-group-flush">
                                          {% for row in items %}
                                            <li class="list-group-item py-1 px-2">
                                              <div class="fw-semibold">
                                                {{ row.cat_name }}
                                                {% if row.identification_number %}
                                                  <span class="text-muted ms-1">
                                                    ({{ row.identification_number }})
                                                  </span>
                                                {% endif %}
                                              </div>
                                              <div class="small text-muted">
                                                Vermifuge :
                                                {{ row.type_name or "‚Äî" }},
                                                Poids :
                                                {% if row.weight is not none %}
                                                  {{ "%.1f"|format(row.weight) }} kg
                                                {% else %}
                                                  ‚Äî
                                                {% endif %},
                                                R√©action : {{ row.reaction or "‚Äî" }}
                                              </div>
                                            </li>
                                          {% endfor %}
                                        </ul>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                              <div class="modal-footer">
                                <input type="hidden"
                                       name="date"
                                       value="{{ date.strftime('%Y-%m-%d') }}">
                                <button type="button"
                                        class="btn btn-secondary"
                                        data-bs-dismiss="modal">
                                  Annuler
                                </button>
                                <button type="submit" class="btn btn-danger">
                                  Oui, supprimer
                                </button>
                              </div>
                            </form>
                          </div>
                        </div>
                      </div>
                      <!-- fin modal -->
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-muted">
              Aucun vermifuge group√© enregistr√© pour le moment.
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ================== JS : recherche + select all ================== -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("batchCatSearch");
    const rows = document.querySelectorAll(".batch-cat-row");

    if (searchInput) {
      searchInput.addEventListener("input", function () {
        const query = this.value.trim().toLowerCase();

        rows.forEach(row => {
          const nameEl = row.querySelector(".batch-cat-name");
          const identEl = row.querySelector(".batch-cat-ident");

          const nameText = nameEl ? nameEl.textContent.toLowerCase() : "";
          const identText = identEl ? identEl.textContent.toLowerCase() : "";

          if (!query || nameText.includes(query) || identText.includes(query)) {
            row.style.display = "";
          } else {
            row.style.display = "none";
          }
        });
      });
    }

    // Select all
    const selectAll = document.getElementById("batchSelectAll");
    const checkboxes = document.querySelectorAll(".batch-cat-select");

    if (selectAll) {
      selectAll.addEventListener("change", function () {
        checkboxes.forEach(cb => {
          cb.checked = selectAll.checked;
        });
      });
    }
  });
</script>
{% endblock %}
