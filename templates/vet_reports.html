{% extends "base.html" %}

{% block content %}
<div class="container mt-4">

    <h1 class="mb-3">Compte-rendu vétérinaire</h1>

    <p class="text-muted">
        Pour chaque rendez-vous, remplis ce qui a été fait (note, vaccin, tâche, poids) puis valide le compte-rendu.
    </p>

    {% if appointments|length == 0 %}
        <div class="alert alert-info mt-3">
            Aucun rendez-vous en attente de compte-rendu pour des chats marqués "Besoin véto".
        </div>
    {% endif %}

    <div class="accordion mt-3" id="accordionVetReports">
        {% for appt in appointments %}
            <div class="accordion-item mb-2">
                <h2 class="accordion-header" id="heading-{{ appt.id }}">
                    <button class="accordion-button {% if not loop.first %}collapsed{% endif %}"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapse-{{ appt.id }}"
                            aria-expanded="{{ 'true' if loop.first else 'false' }}"
                            aria-controls="collapse-{{ appt.id }}">

                        <div class="d-flex flex-column flex-grow-1">
                            <div>
                                <strong>
                                    {{ appt.date.astimezone(TZ_PARIS).strftime('%d/%m/%Y %H:%M') }}
                                </strong>
                                — {{ appt.location or "Rendez-vous" }}
                            </div>
                            <div class="small text-muted">
                                Chats :
                                {% for ac in appt.cats %}
                                    {{ ac.cat.name }}{% if not loop.last %}, {% endif %}
                                {% endfor %}
                                {% if appt.employees %}
                                    • Employés :
                                    {% for e in appt.employees %}
                                        {{ e.employee.name }}{% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>

                        {% if appt.vet_report_done %}
                            <span class="badge bg-success ms-3">
                                Compte-rendu validé
                            </span>
                        {% endif %}
                    </button>
                </h2>

                <div id="collapse-{{ appt.id }}"
                     class="accordion-collapse collapse {% if loop.first %}show{% endif %}"
                     aria-labelledby="heading-{{ appt.id }}"
                     data-bs-parent="#accordionVetReports">
                    <div class="accordion-body">

                        {% if appt.vet_report_done %}
    <div class="alert alert-success">
        Ce compte-rendu est déjà validé.
        Pour ajouter des informations, passe directement par la fiche du chat.
    </div>

    {% set appt_hist = vet_history.get(appt.id) %}
    {% if appt_hist %}
        <div class="mt-3">
            <h5>Historique de ce rendez-vous</h5>

            {% for ac in appt.cats %}
                {% set cat = ac.cat %}
                {% set collapse_id = "hist-" ~ appt.id ~ "-" ~ cat.id %}
                {% set cat_hist = appt_hist.get(cat.id) %}

                <div class="card mb-2 border-secondary">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <button class="btn btn-link p-0 text-start flex-grow-1 text-decoration-none"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#{{ collapse_id }}"
                                aria-expanded="false"
                                aria-controls="{{ collapse_id }}">
                            <h6 class="mb-0">
                                {{ cat.name }}
                                {% if cat.identification_number %}
                                    <span class="text-muted small">• {{ cat.identification_number }}</span>
                                {% endif %}
                            </h6>
                        </button>
                    </div>

                    <div id="{{ collapse_id }}" class="collapse">
                        <div class="card-body small">
                            {% if not cat_hist %}
                                <p class="text-muted mb-0">Aucune information enregistrée pour ce chat lors de ce rendez-vous.</p>
                            {% else %}

                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <h6 class="fw-bold">Notes</h6>
                                        {% if cat_hist.notes %}
                                            <ul class="mb-2">
                                                {% for n in cat_hist.notes %}
                                                    <li>
                                                        <strong>
                                                            {{ n.created_at.astimezone(TZ_PARIS).strftime('%d/%m/%Y %H:%M') }}
                                                        </strong>
                                                        — {{ n.content or "—" }}
                                                        <div class="text-muted">
                                                            {% if n.author %}Auteur : {{ n.author }}{% endif %}
                                                            {% if n.veterinarian %}
                                                                {% if n.author %} • {% endif %}
                                                                Vétérinaire : {{ n.veterinarian }}
                                                            {% endif %}
                                                        </div>
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        {% else %}
                                            <p class="text-muted mb-0">Aucune note.</p>
                                        {% endif %}
                                    </div>

                                    <div class="col-md-6">
                                        <h6 class="fw-bold">Vaccinations</h6>
                                        {% if cat_hist.vaccinations %}
                                            <ul class="mb-2">
                                                {% for v in cat_hist.vaccinations %}
                                                    <li>
                                                        <strong>{{ v.date.strftime('%d/%m/%Y') }}</strong>
                                                        — {{ v.vaccine_type.name if v.vaccine_type else "Vaccin" }}
                                                        {% if v.primo %}[Primo]{% endif %}
                                                        <div class="text-muted">
                                                            {% if v.veterinarian %}Vétérinaire : {{ v.veterinarian }}{% endif %}
                                                            {% if v.reaction %} • Réaction : {{ v.reaction }}{% endif %}
                                                        </div>
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        {% else %}
                                            <p class="text-muted mb-0">Aucun vaccin.</p>
                                        {% endif %}
                                    </div>
                                </div>

                                <hr>

                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <h6 class="fw-bold">Tâches créées</h6>
                                        {% if cat_hist.tasks %}
                                            <ul class="mb-2">
                                                {% for t in cat_hist.tasks %}
                                                    <li>
                                                        <strong>{{ t.task_type.name if t.task_type else "Tâche" }}</strong>
                                                        {% if t.due_date %} — échéance {{ t.due_date.strftime('%d/%m/%Y') }}{% endif %}
                                                        {% if t.note %}
                                                            <div>{{ t.note }}</div>
                                                        {% endif %}
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        {% else %}
                                            <p class="text-muted mb-0">Aucune tâche créée.</p>
                                        {% endif %}
                                    </div>

                                    <div class="col-md-6">
                                        <h6 class="fw-bold">Poids</h6>
                                        {% if cat_hist.weights %}
                                            <ul class="mb-2">
                                                {% for w in cat_hist.weights %}
                                                    <li>
                                                        <strong>{{ w.date.strftime('%d/%m/%Y') }}</strong>
                                                        — {{ "%.2f"|format(w.weight) }} kg
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        {% else %}
                                            <p class="text-muted mb-0">Aucune pesée.</p>
                                        {% endif %}
                                    </div>
                                </div>

                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="mt-3 text-muted">
            Aucune information enregistrée via ce compte-rendu (données plus anciennes que cette mise à jour).
        </p>
    {% endif %}

{% else %}

                            <form method="POST"
      action="{{ url_for('vet_report_validate', appointment_id=appt.id) }}">

    {% for ac in appt.cats %}
        {% set cat = ac.cat %}
        {% set collapse_id = "cat-" ~ appt.id ~ "-" ~ cat.id %}

        <div class="card mb-3 {% if cat.need_vet %}border-warning{% else %}border-secondary{% endif %}">
            <!-- HEADER : nom du chat + bouton pour ouvrir/fermer -->
            <div class="card-header d-flex justify-content-between align-items-center">

                <button class="btn btn-link p-0 text-start flex-grow-1 text-decoration-none"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#{{ collapse_id }}"
                        aria-expanded="false"
                        aria-controls="{{ collapse_id }}">
                    <h5 class="mb-1">
                        {{ cat.name }}
                        {% if cat.identification_number %}
                            <span class="text-muted small">• {{ cat.identification_number }}</span>
                        {% endif %}
                        {% if cat.need_vet %}
                            <span class="badge rounded-pill text-bg-warning ms-2">Besoin véto</span>
                        {% endif %}
                    </h5>
                </button>

                <div class="form-check ms-3">
                    <input class="form-check-input"
                           type="checkbox"
                           name="keep_need_vet_{{ cat.id }}"
                           id="keep_need_vet_{{ cat.id }}">
                    <label class="form-check-label small"
                           for="keep_need_vet_{{ cat.id }}">
                        Conserver le tag « Besoin véto »
                    </label>
                </div>
            </div>

            <!-- CONTENU REPLIABLE : note / vaccins / tâche / poids -->
            <div id="{{ collapse_id }}" class="collapse">
                <div class="card-body">
                    <div class="row g-3">

                        <!-- NOTE -->
                        <div class="col-md-6">
                            <h6>Note</h6>
                            <textarea name="note_content_{{ cat.id }}"
                                      class="form-control mb-2"
                                      rows="3"
                                      placeholder="Compte-rendu / observations..."></textarea>

                            <div class="row g-2">
                                <div class="col-6">
                                    <label class="form-label mb-1 small">Auteur</label>
                                    <select name="note_author_{{ cat.id }}"
                                            class="form-select form-select-sm">
                                        <option value="">—</option>
                                        {% for e in employees %}
                                            <option value="{{ e.name }}">{{ e.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="form-label mb-1 small">Vétérinaire</label>
                                    <select name="note_veterinarian_{{ cat.id }}"
                                            class="form-select form-select-sm">
                                        <option value="">—</option>
                                        {% for v in veterinarians %}
                                            <option value="{{ v.name }}">{{ v.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- VACCINATION -->
                        <div class="col-md-6">
                            <h6>Vaccination</h6>

                            <div class="row g-2 align-items-end">
                                <div class="col-md-5">
                                    <label class="form-label mb-1 small">Type de vaccin</label>
                                    <select name="vacc_vaccine_type_id_{{ cat.id }}"
                                            class="form-select form-select-sm">
                                        <option value="">—</option>
                                        {% for vtype in vaccines %}
                                            <option value="{{ vtype.id }}">
                                                {{ vtype.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="col-md-3">
                                    <label class="form-label mb-1 small">Date</label>
                                    <input type="date"
                                           name="vacc_date_{{ cat.id }}"
                                           class="form-control form-control-sm"
                                           value="{{ appt.date.astimezone(TZ_PARIS).strftime('%Y-%m-%d') }}">
                                </div>

                                <div class="col-md-4">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               name="vacc_primo_{{ cat.id }}"
                                               id="vacc_primo_{{ cat.id }}">
                                        <label class="form-check-label small"
                                               for="vacc_primo_{{ cat.id }}">
                                            Primo-vaccination
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="row g-2 mt-2">
                                <div class="col-md-6">
                                    <label class="form-label mb-1 small">Vétérinaire</label>
                                    <select name="vacc_veterinarian_{{ cat.id }}"
                                            class="form-select form-select-sm">
                                        <option value="">—</option>
                                        {% for v in veterinarians %}
                                            <option value="{{ v.name }}">{{ v.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label mb-1 small">Réaction</label>
                                    <input type="text"
                                           name="vacc_reaction_{{ cat.id }}"
                                           class="form-control form-control-sm"
                                           placeholder="Réaction éventuelle...">
                                </div>
                            </div>
                        </div>

                    </div>

                    <hr/>

                    <div class="row g-3">

                        <!-- TÂCHE -->
                        <div class="col-md-6">
                            <h6>Créer une tâche de suivi</h6>

                            <div class="row g-2">
                                <div class="col-md-6">
                                    <label class="form-label mb-1 small">Type de tâche</label>
                                    <select name="task_task_type_id_{{ cat.id }}"
                                            class="form-select form-select-sm">
                                        <option value="">—</option>
                                        {% for t in task_types %}
                                            <option value="{{ t.id }}">{{ t.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label mb-1 small">Échéance</label>
                                    <input type="date"
                                           name="task_due_date_{{ cat.id }}"
                                           class="form-control form-control-sm">
                                </div>
                            </div>

                            <div class="mt-2">
                                <textarea name="task_note_{{ cat.id }}"
                                          class="form-control"
                                          rows="2"
                                          placeholder="Détails de la tâche (optionnel)..."></textarea>
                            </div>
                        </div>

                        <!-- POIDS -->
                        <div class="col-md-6">
                            <h6>Poids</h6>
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <label class="form-label mb-1 small">Date</label>
                                    <input type="date"
                                           name="weight_date_{{ cat.id }}"
                                           class="form-control form-control-sm"
                                           value="{{ appt.date.astimezone(TZ_PARIS).strftime('%Y-%m-%d') }}">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label mb-1 small">Poids (kg)</label>
                                    <input type="text"
                                           name="weight_value_{{ cat.id }}"
                                           class="form-control form-control-sm"
                                           placeholder="ex : 4.2">
                                </div>
                            </div>
                        </div>
                    </div>

                </div>  {# /card-body #}
            </div>      {# /collapse #}
        </div>          {# /card #}

    {% endfor %}

    <div class="text-end">
        <button class="btn btn-primary">
            ✅ Valider ce compte-rendu
        </button>
    </div>

</form>


                        {% endif %}

                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

</div>
{% endblock %}
