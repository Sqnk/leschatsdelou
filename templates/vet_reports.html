{% extends "base.html" %}

{% block content %}
<div class="container mt-4">

    <h1 class="mb-3">Compte-rendu v√©t√©rinaire</h1>

    <p class="text-muted">
        Pour chaque rendez-vous, remplis ce qui a √©t√© fait (note, vaccin, t√¢che, poids) puis valide le compte-rendu.
    </p>

    {% if appointments|length == 0 %}
        <div class="alert alert-info mt-3">
            Aucun rendez-vous en attente de compte-rendu.
        </div>
    {% endif %}

    <div class="accordion mt-3" id="accordionVetReports">
        {% for appt in appointments %}
            <div class="accordion-item mb-2">
                <h2 class="accordion-header" id="heading-{{ appt.id }}">
                    <button class="accordion-button {% if not loop.first %}collapsed{% endif %}"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapse-{{ appt.id }}"
                            aria-expanded="{{ 'true' if loop.first else 'false' }}"
                            aria-controls="collapse-{{ appt.id }}">

                        <div class="d-flex flex-column flex-grow-1">
                            <div>
                                <strong>
                                    {{ appt.date.astimezone(TZ_PARIS).strftime('%d/%m/%Y %H:%M') }}
                                </strong>
                                ‚Äî {{ appt.location or "Rendez-vous" }}
                            </div>
                            <div class="small text-muted">
                                Chats :
                                {% for ac in appt.cats %}
                                    {{ ac.cat.name }}{% if not loop.last %}, {% endif %}
                                {% endfor %}
                                {% if appt.employees %}
                                    ‚Ä¢ Employ√©s :
                                    {% for e in appt.employees %}
                                        {{ e.employee.name }}{% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>

                        {% if appt.vet_report_done %}
                            <span class="badge bg-success ms-3">
                                Compte-rendu valid√©
                            </span>
                        {% endif %}
                    </button>
                </h2>

                <div id="collapse-{{ appt.id }}"
                     class="accordion-collapse collapse {% if loop.first %}show{% endif %}"
                     aria-labelledby="heading-{{ appt.id }}"
                     data-bs-parent="#accordionVetReports">
                    <div class="accordion-body">

                        {% if appt.vet_report_done %}
    <div class="alert alert-success">
        Ce compte-rendu est d√©j√† valid√©.
        Pour ajouter des informations, passe directement par la fiche du chat.
    </div>

    {% set appt_hist = vet_history.get(appt.id) %}
    {% if appt_hist %}
        <div class="mt-3">
            <h5>Historique de ce rendez-vous</h5>

            {% for ac in appt.cats %}
                {% set cat = ac.cat %}
                {% set collapse_id = "hist-" ~ appt.id ~ "-" ~ cat.id %}
                {% set cat_hist = appt_hist.get(cat.id) %}

                <div class="card mb-2 border-secondary">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <button class="btn btn-link p-0 text-start flex-grow-1 text-decoration-none"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#{{ collapse_id }}"
                                aria-expanded="false"
                                aria-controls="{{ collapse_id }}">
                            <h6 class="mb-0">
                                {{ cat.name }}
                                {% if cat.identification_number %}
                                    <span class="text-muted small">‚Ä¢ {{ cat.identification_number }}</span>
                                {% endif %}
                            </h6>
                        </button>
                    </div>

                    <div id="{{ collapse_id }}" class="collapse">
                        <div class="card-body small">
                            {% if not cat_hist %}
                                <p class="text-muted mb-0">Aucune information enregistr√©e pour ce chat lors de ce rendez-vous.</p>
                            {% else %}

                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <h6 class="fw-bold">Notes</h6>
                                        {% if cat_hist.notes %}
                                            <ul class="mb-2">
                                                {% for n in cat_hist.notes %}
                                                    <li>
                                                        <strong>
                                                            {{ n.created_at.astimezone(TZ_PARIS).strftime('%d/%m/%Y %H:%M') }}
                                                        </strong>
                                                        ‚Äî {{ n.content or "‚Äî" }}
                                                        <div class="text-muted">
                                                            {% if n.author %}Auteur : {{ n.author }}{% endif %}
                                                            {% if n.veterinarian %}
                                                                {% if n.author %} ‚Ä¢ {% endif %}
                                                                V√©t√©rinaire : {{ n.veterinarian }}
                                                            {% endif %}
                                                        </div>
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        {% else %}
                                            <p class="text-muted mb-0">Aucune note.</p>
                                        {% endif %}
                                    </div>

                                    <div class="col-md-6">
                                        <h6 class="fw-bold">Vaccinations</h6>
                                        {% if cat_hist.vaccinations %}
                                            <ul class="mb-2">
                                                {% for v in cat_hist.vaccinations %}
                                                    <li>
                                                        <strong>{{ v.date.strftime('%d/%m/%Y') }}</strong>
                                                        ‚Äî {{ v.vaccine_type.name if v.vaccine_type else "Vaccin" }}
                                                        {% if v.primo %}[Primo]{% endif %}
                                                        <div class="text-muted">
                                                            {% if v.veterinarian %}V√©t√©rinaire : {{ v.veterinarian }}{% endif %}
                                                            {% if v.reaction %} ‚Ä¢ R√©action : {{ v.reaction }}{% endif %}
                                                        </div>
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        {% else %}
                                            <p class="text-muted mb-0">Aucun vaccin.</p>
                                        {% endif %}
                                    </div>
                                </div>

                                <hr>

                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <h6 class="fw-bold">T√¢ches cr√©√©es</h6>
                                        {% if cat_hist.tasks %}
                                            <ul class="mb-2">
                                                {% for t in cat_hist.tasks %}
                                                    <li>
                                                        <strong>{{ t.task_type.name if t.task_type else "T√¢che" }}</strong>
                                                        {% if t.due_date %} ‚Äî √©ch√©ance {{ t.due_date.strftime('%d/%m/%Y') }}{% endif %}
                                                        {% if t.note %}
                                                            <div>{{ t.note }}</div>
                                                        {% endif %}
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        {% else %}
                                            <p class="text-muted mb-0">Aucune t√¢che cr√©√©e.</p>
                                        {% endif %}
                                    </div>

                                    <div class="col-md-6">
                                        <h6 class="fw-bold">Poids</h6>
                                        {% if cat_hist.weights %}
                                            <ul class="mb-2">
                                                {% for w in cat_hist.weights %}
                                                    <li>
                                                        <strong>{{ w.date.strftime('%d/%m/%Y') }}</strong>
                                                        ‚Äî {{ "%.2f"|format(w.weight) }} kg
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        {% else %}
                                            <p class="text-muted mb-0">Aucune pes√©e.</p>
                                        {% endif %}
                                    </div>
                                </div>

                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="mt-3 text-muted">
            Aucune information enregistr√©e via ce compte-rendu (donn√©es plus anciennes que cette mise √† jour).
        </p>
    {% endif %}

{% else %}

                            <form method="POST"
      action="{{ url_for('vet_report_validate', appointment_id=appt.id) }}">

    {% for ac in appt.cats %}
        {% set cat = ac.cat %}
        {% set collapse_id = "cat-" ~ appt.id ~ "-" ~ cat.id %}

        <div class="card mb-3 {% if cat.need_vet %}border-warning{% else %}border-secondary{% endif %}">
            <!-- HEADER : nom du chat + bouton pour ouvrir/fermer -->
            <div class="card-header d-flex justify-content-between align-items-center">

                <button class="btn btn-link p-0 text-start flex-grow-1 text-decoration-none"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#{{ collapse_id }}"
                        aria-expanded="false"
                        aria-controls="{{ collapse_id }}">
                    <h5 class="mb-1">
                        {{ cat.name }}
                        {% if cat.identification_number %}
                            <span class="text-muted small">‚Ä¢ {{ cat.identification_number }}</span>
                        {% endif %}
                        {% if cat.need_vet %}
                            <span class="badge rounded-pill text-bg-warning ms-2">Besoin v√©to</span>
                        {% endif %}
                    </h5>
                </button>

                <div class="form-check ms-3">
                    <input class="form-check-input"
                           type="checkbox"
                           name="keep_need_vet_{{ cat.id }}"
                           id="keep_need_vet_{{ cat.id }}">
                    <label class="form-check-label small"
                           for="keep_need_vet_{{ cat.id }}">
                        Conserver le tag ¬´ Besoin v√©to ¬ª
                    </label>
                </div>
            </div>

            <!-- CONTENU REPLIABLE : note / vaccins / t√¢che / poids -->
            <div id="{{ collapse_id }}" class="collapse">
                <div class="card-body">
                    <div class="row g-3">

                        <!-- NOTE -->
                        <div class="col-md-6">
                            <h6>Note</h6>
                            <textarea name="note_content_{{ cat.id }}"
                                      class="form-control mb-2"
                                      rows="3"
                                      placeholder="Compte-rendu / observations..."></textarea>

                            <div class="row g-2">
                                <div class="col-6">
                                    <label class="form-label mb-1 small">Auteur</label>
                                    <select name="note_author_{{ cat.id }}"
                                            class="form-select form-select-sm">
                                        <option value="">‚Äî</option>
                                        {% for e in employees %}
                                            <option value="{{ e.name }}">{{ e.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="form-label mb-1 small">V√©t√©rinaire</label>
                                    <select name="note_veterinarian_{{ cat.id }}"
                                            class="form-select form-select-sm">
                                        <option value="">‚Äî</option>
                                        {% for v in veterinarians %}
                                            <option value="{{ v.name }}">{{ v.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- VACCINATION -->
                        <div class="col-md-6">
                            <h6>Vaccination</h6>

                            <div class="row g-2 align-items-end">
                                <div class="col-md-5">
                                    <label class="form-label mb-1 small">Type de vaccin</label>
                                    <select name="vacc_vaccine_type_id_{{ cat.id }}"
                                            class="form-select form-select-sm">
                                        <option value="">‚Äî</option>
                                        {% for vtype in vaccines %}
                                            <option value="{{ vtype.id }}">
                                                {{ vtype.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="col-md-3">
                                    <label class="form-label mb-1 small">Date</label>
                                    <input type="date"
                                           name="vacc_date_{{ cat.id }}"
                                           class="form-control form-control-sm">
                                           
                                </div>

                                <div class="col-md-4">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               name="vacc_primo_{{ cat.id }}"
                                               id="vacc_primo_{{ cat.id }}">
                                        <label class="form-check-label small"
                                               for="vacc_primo_{{ cat.id }}">
                                            Primo-vaccination
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="row g-2 mt-2">
                                <div class="col-md-6">
                                    <label class="form-label mb-1 small">V√©t√©rinaire</label>
                                    <select name="vacc_veterinarian_{{ cat.id }}"
                                            class="form-select form-select-sm">
                                        <option value="">‚Äî</option>
                                        {% for v in veterinarians %}
                                            <option value="{{ v.name }}">{{ v.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label mb-1 small">R√©action</label>
                                    <input type="text"
                                           name="vacc_reaction_{{ cat.id }}"
                                           class="form-control form-control-sm"
                                           placeholder="R√©action √©ventuelle...">
                                </div>
                            </div>
                        </div>

                    </div>

                    <hr/>

                    <div class="row g-3">

                        <!-- T√ÇCHE -->
                        <div class="col-md-6">
                            <h6>Cr√©er une t√¢che de suivi</h6>

                            <div class="row g-2">
                                <div class="col-md-6">
                                    <label class="form-label mb-1 small">Type de t√¢che</label>
                                    <select name="task_task_type_id_{{ cat.id }}"
                                            class="form-select form-select-sm">
                                        <option value="">‚Äî</option>
                                        {% for t in task_types %}
                                            <option value="{{ t.id }}">{{ t.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label mb-1 small">√âch√©ance</label>
                                    <input type="date"
                                           name="task_due_date_{{ cat.id }}"
                                           class="form-control form-control-sm">
                                </div>
                            </div>

                            <div class="mt-2">
                                <textarea name="task_note_{{ cat.id }}"
                                          class="form-control"
                                          rows="2"
                                          placeholder="D√©tails de la t√¢che (optionnel)..."></textarea>
                            </div>
                        </div>

                        <!-- POIDS -->
                        <div class="col-md-6">
                            <h6>Poids</h6>
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <label class="form-label mb-1 small">Date</label>
                                    <input type="date"
                                           name="weight_date_{{ cat.id }}"
                                           class="form-control form-control-sm">
                                           
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label mb-1 small">Poids (kg)</label>
                                    <input type="text"
                                           name="weight_value_{{ cat.id }}"
                                           class="form-control form-control-sm"
                                           placeholder="ex : 4.2">
                                </div>
                            </div>
                        </div>
                    </div>

                </div>  {# /card-body #}
            </div>      {# /collapse #}
        </div>          {# /card #}

                                    {% endfor %}

                                <div class="text-end">
                                    <button type="button"
                                            class="btn btn-primary btn-vet-validate"
                                            data-appointment-id="{{ appt.id }}">
                                        ‚úÖ Valider ce compte-rendu
                                    </button>
                                </div>

                            </form>

                        {% endif %}

                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Modal de confirmation du compte-rendu v√©to -->
    <div class="modal fade" id="vetConfirmModal" tabindex="-1" aria-labelledby="vetConfirmTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="vetConfirmTitle">Confirmer la validation du compte-rendu</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>
                <div class="modal-body">
                    <p id="vetConfirmSubtitle" class="mb-3"></p>
                    <div id="vetConfirmBody"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="vetConfirmSubmit">Valider et enregistrer</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    let currentForm = null;

    const modalEl = document.getElementById('vetConfirmModal');
    const modalBody = document.getElementById('vetConfirmBody');
    const modalSubtitle = document.getElementById('vetConfirmSubtitle');
    const confirmBtn = document.getElementById('vetConfirmSubmit');

    // Si le modal n'existe pas (s√©curit√©), on ne fait rien
    if (!modalEl || !modalBody || !modalSubtitle || !confirmBtn) {
        return;
    }
	
    const bsModal = new bootstrap.Modal(modalEl);
	
	// üîπ Forcer les dates Vaccin / Poids √† √™tre vides + placeholder jj/mm/aaaa
    document.querySelectorAll(
        'input[type="date"][name^="vacc_date_"], ' +
        'input[type="date"][name^="weight_date_"]'
    ).forEach(function (input) {
        input.value = "";
        input.placeholder = "jj/mm/aaaa";
    });
	
    function escapeHtml(text) {
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // Boutons "‚úÖ Valider ce compte-rendu"
    document.querySelectorAll('.btn-vet-validate').forEach(function (btn) {
        btn.addEventListener('click', function (e) {
            e.preventDefault();

            const form = btn.closest('form');
            if (!form) return;
            currentForm = form;

            // Toutes les cartes "chat" de ce rendez-vous
            const cards = form.querySelectorAll('.card.mb-3');
            const totalChats = cards.length;

            modalSubtitle.textContent = "Vous allez valider le compte-rendu pour " +
                totalChats + (totalChats > 1 ? " chats." : " chat.");

            let html = "";

            cards.forEach(function (card, index) {
                const headerTitle = card.querySelector('.card-header h5, .card-header strong');
                const catTitle = headerTitle ? headerTitle.textContent.trim() : ("Chat " + (index + 1));

                // On essaye de retrouver l'id du chat √† partir du nom d'un champ
                let catId = null;
                const anyField = card.querySelector(
                    'textarea[name^="note_content_"],' +
                    'input[name^="weight_date_"],' +
                    'input[name^="weight_value_"],' +
                    'select[name^="vacc_vaccine_type_id_"],' +
                    'select[name^="task_task_type_id_"]'
                );
                if (anyField && anyField.name) {
                    const m = anyField.name.match(/_(\d+)$/);
                    if (m) catId = m[1];
                }

                function getValue(prefix) {
                    if (!catId) return "";
                    const el = form.querySelector('[name="' + prefix + '_' + catId + '"]');
                    return el ? el.value.trim() : "";
                }

                // NOTE
                const noteContent = getValue('note_content');
                const noteAuthor = getValue('note_author');
                const noteVet = getValue('note_veterinarian');

                // VACCIN
                let vaccTypeLabel = "";
                if (catId) {
                    const vaccSelect = form.querySelector('[name="vacc_vaccine_type_id_' + catId + '"]');
                    if (vaccSelect && vaccSelect.value) {
                        vaccTypeLabel = vaccSelect.options[vaccSelect.selectedIndex].text;
                    }
                }
                const vaccDate = getValue('vacc_date');
                const vaccVet = getValue('vacc_veterinarian');
                const vaccReaction = getValue('vacc_reaction');
                const vaccPrimo = catId
                    ? !!form.querySelector('[name="vacc_primo_' + catId + '"]:checked')
                    : false;

                // T√ÇCHE
                let taskTypeLabel = "";
                if (catId) {
                    const taskSelect = form.querySelector('[name="task_task_type_id_' + catId + '"]');
                    if (taskSelect && taskSelect.value) {
                        taskTypeLabel = taskSelect.options[taskSelect.selectedIndex].text;
                    }
                }
                const taskDue = getValue('task_due_date');
                const taskNote = getValue('task_note');

                // POIDS
                const weightDate = getValue('weight_date');
                const weightVal = getValue('weight_value');

                                const hasNote = noteContent || noteAuthor || noteVet;
                const hasVacc = vaccTypeLabel || vaccDate || vaccVet || vaccReaction || vaccPrimo;
                const hasTask = taskTypeLabel || taskDue || taskNote;
                const hasWeight = weightDate || weightVal;

                // üîπ R√©sum√© pour l'en-t√™te du chat dans le modal
                const summaryParts = [];
                if (hasNote)  summaryParts.push('Note : 1');
                if (hasTask)  summaryParts.push('T√¢che : 1');
                if (hasVacc)  summaryParts.push('Vaccin : 1');
                if (hasWeight) summaryParts.push('Poids : 1');

                const catKey = catId || ("idx" + index);

                html += '<div class="mb-2 border rounded">';
                html += '  <button class="btn btn-link text-start w-100 p-2 d-flex justify-content-between align-items-center" type="button" ' +
                        'data-bs-toggle="collapse" data-bs-target="#confirm-cat-' + catKey + '">';
                html += '    <span><strong>' + escapeHtml(catTitle) + '</strong></span>';

                if (summaryParts.length > 0) {
                    html += '    <span class="small text-muted">' + summaryParts.join(' ‚Äî ') + '</span>';
                } else {
                    html += '    <span class="small text-muted">Aucune information entr√©e</span>';
                }

                html += '  </button>';

                html += '  <div id="confirm-cat-' + catKey + '" class="collapse">';
                html += '    <div class="p-2">';

                if (!hasNote && !hasVacc && !hasTask && !hasWeight) {
                    html += '<p class="text-muted mb-0">Aucune information saisie pour ce chat.</p>';
                } else {
                    if (hasNote) {
                        html += '<h6 class="mb-1">Note</h6><ul class="small">';
                        if (noteContent) {
                            html += '<li>' + escapeHtml(noteContent) + '</li>';
                        }
                        const meta = [];
                        if (noteAuthor) meta.push('Auteur : ' + escapeHtml(noteAuthor));
                        if (noteVet) meta.push('V√©t√©rinaire : ' + escapeHtml(noteVet));
                        if (meta.length) {
                            html += '<li class="text-muted">' + meta.join(' ‚Ä¢ ') + '</li>';
                        }
                        html += '</ul>';
                    }

                    if (hasVacc) {
                        html += '<h6 class="mb-1 mt-2">Vaccination</h6><ul class="small">';
                        if (vaccTypeLabel) {
                            html += '<li>Vaccin : ' + escapeHtml(vaccTypeLabel) + '</li>';
                        }
                        if (vaccDate) {
                            html += '<li>Date : ' + escapeHtml(vaccDate) + '</li>';
                        }
                        if (vaccPrimo) {
                            html += '<li>Primo-vaccination</li>';
                        }
                        if (vaccVet) {
                            html += '<li>V√©t√©rinaire : ' + escapeHtml(vaccVet) + '</li>';
                        }
                        if (vaccReaction) {
                            html += '<li>R√©action : ' + escapeHtml(vaccReaction) + '</li>';
                        }
                        html += '</ul>';
                    }

                    if (hasTask) {
                        html += '<h6 class="mb-1 mt-2">T√¢che</h6><ul class="small">';
                        if (taskTypeLabel) {
                            html += '<li>Type : ' + escapeHtml(taskTypeLabel) + '</li>';
                        }
                        if (taskDue) {
                            html += '<li>√âch√©ance : ' + escapeHtml(taskDue) + '</li>';
                        }
                        if (taskNote) {
                            html += '<li>Note : ' + escapeHtml(taskNote) + '</li>';
                        }
                        html += '</ul>';
                    }

                    if (hasWeight) {
                        html += '<h6 class="mb-1 mt-2">Poids</h6><ul class="small">';
                        if (weightDate) {
                            html += '<li>Date : ' + escapeHtml(weightDate) + '</li>';
                        }
                        if (weightVal) {
                            html += '<li>Poids : ' + escapeHtml(weightVal) + ' kg</li>';
                        }
                        html += '</ul>';
                    }
                }

                html += '    </div>';
                html += '  </div>';
                html += '</div>';
            });

            if (!html) {
                html = '<p class="text-muted mb-0">Aucune information saisie.</p>';
            }

            modalBody.innerHTML = html;
            bsModal.show();
        });
    });

    // Clic sur "Valider et enregistrer" dans le modal ‚Üí submit du formulaire
    confirmBtn.addEventListener('click', function () {
        if (currentForm) {
            currentForm.submit();
        }
    });
});
</script>

{% endblock %}

