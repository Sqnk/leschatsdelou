{% extends "base.html" %}
{% block content %}

<h1 class="mb-4">Recherche dans les notes</h1>

<!-- ======================= FILTRES ======================= -->
<div class="card p-3 mb-4 shadow-sm">

    <div class="row g-3">

        <!-- Texte -->
        <div class="col-md-4">
            <label class="form-label">Recherche texte</label>
            <input id="searchText" type="text" class="form-control" placeholder="Contenu, auteur, chatâ€¦">
        </div>

        <!-- Chat -->
        <div class="col-md-4">
            <label class="form-label">Chat</label>
            <select id="filterCat" class="form-select">
                <option value="">Tous</option>
                {% set cats = notes | map(attribute='cat.name') | list | unique | sort %}
                {% for c in cats %}
                    <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Auteur -->
        <div class="col-md-4">
            <label class="form-label">Auteur</label>
            <select id="filterAuthor" class="form-select">
                <option value="">Tous</option>
                {% set authors = notes | map(attribute='author') | list | unique | sort %}
                {% for a in authors %}
                    {% if a %}
                        <option value="{{ a }}">{{ a }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>

    </div>
</div>

<!-- ======================= LISTE DES NOTES ======================= -->
<div id="notesList" class="row g-3">
    {% for n in notes %}
        <div class="col-md-6">
            <div class="card p-3 shadow-sm">

                <div class="d-flex justify-content-between">
                    <h5>
                        <a href="{{ url_for('cat_detail', cat_id=n.cat.id) }}" class="text-decoration-none">
                            {{ n.cat.name }}
                        </a>
                    </h5>
                    <span class="text-muted">{{ n.created_at.strftime('%d/%m/%Y %H:%M') }}</span>
                </div>

                {% if n.author %}
                    <p class="text-muted mb-1">Auteur : <strong>{{ n.author }}</strong></p>
                {% endif %}

                {% if n.content %}
                    <p>{{ n.content }}</p>
                {% endif %}

                {% if n.file_name %}
                    <a href="/uploads/{{ n.file_name }}" target="_blank">ðŸ“Ž PiÃ¨ce jointe</a>
                {% endif %}

            </div>
        </div>
    {% endfor %}
</div>


<script>
async function updateList() {
    const txt = document.getElementById("searchText").value;
    const cat = document.getElementById("filterCat").value;
    const author = document.getElementById("filterAuthor").value;

    const res = await fetch(`/api/search_notes?q=${encodeURIComponent(txt)}`);
    const data = await res.json();

    const list = document.getElementById("notesList");
    list.innerHTML = "";

    // filtrage client-side supplÃ©mentaire
    const filtered = data.filter(n =>
        (!cat || n.cat_name === cat) &&
        (!author || n.author === author)
    );

    if (filtered.length === 0) {
        list.innerHTML = '<p class="text-muted">Aucun rÃ©sultat.</p>';
        return;
    }

    filtered.forEach(n => {
        const div = document.createElement("div");
        div.className = "col-md-6";

        div.innerHTML = `
        <div class="card p-3 shadow-sm">
            <div class="d-flex justify-content-between">
                <h5>
                   <a href="/cats/${n.id_cat}" class="text-decoration-none">${n.cat_name}</a>
                </h5>
                <span class="text-muted">${n.created_at}</span>
            </div>

            ${n.author !== "â€”" ? `<p class="text-muted mb-1"><strong>${n.author}</strong></p>` : ""}
            ${n.content ? `<p>${n.content}</p>` : ""}
            ${n.file ? `<a href="/uploads/${n.file}" target="_blank">ðŸ“Ž PiÃ¨ce jointe</a>` : ""}
        </div>
        `;

        list.appendChild(div);
    });
}

document.getElementById("searchText").addEventListener("input", updateList);
document.getElementById("filterCat").addEventListener("change", updateList);
document.getElementById("filterAuthor").addEventListener("change", updateList);
</script>

{% endblock %}
