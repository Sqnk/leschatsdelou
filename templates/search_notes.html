{% extends "base.html" %}
{% block content %}

<h1 class="mb-4 fw-bold">Recherche dans les notes</h1>

<div class="row">

    <!-- ==========================
         COLONNE FILTRES (GAUCHE)
    =========================== -->
    <div class="col-12 col-lg-3">

        <div class="card p-3 shadow-sm">

            <!-- Recherche texte -->
            <label class="form-label fw-semibold">Recherche texte</label>
            <input id="searchText" type="text" class="form-control mb-3" placeholder="Contenu, auteur, chat...">

            <!-- Auteur -->
            <label class="form-label fw-semibold">Auteur</label>
            <select id="authorFilter" class="form-select mb-3">
                <option value="">Tous</option>
                {% for e in employees %}
                <option value="{{ e.name }}">{{ e.name }}</option>
                {% endfor %}
            </select>

            <!-- Date d√©but -->
            <label class="form-label fw-semibold">Date d√©but</label>
            <input id="dateStart" type="date" class="form-control mb-3">

            <!-- Date fin -->
            <label class="form-label fw-semibold">Date fin</label>
            <input id="dateEnd" type="date" class="form-control mb-3">

        </div>
    </div>

    <!-- ==========================
         COLONNE R√âSULTATS (DROITE)
    =========================== -->
    <div class="col-12 col-lg-9">

        <!-- PAGINATION (haut) -->
        <div id="paginationTop" class="mb-3"></div>

        <div id="notesList"></div>

        <!-- PAGINATION (bas) -->
        <div id="paginationBottom" class="mt-3"></div>

    </div>

</div>

<!-- ==========================
         JS
=========================== -->
<script>
// R√©f√©rences DOM
const searchText      = document.getElementById("searchText");
const authorFilter    = document.getElementById("authorFilter");
const dateStart       = document.getElementById("dateStart");
const dateEnd         = document.getElementById("dateEnd");
const notesList       = document.getElementById("notesList");
const paginationTop   = document.getElementById("paginationTop");
const paginationBottom= document.getElementById("paginationBottom");

// √âtat
let allNotes = [];
let currentPage = 1;
const perPage = 20;

// ----------------------------------------------------
// CHARGEMENT DES NOTES (avec filtres actifs)
// ----------------------------------------------------
async function loadNotes() {
    const params = new URLSearchParams();

    const q       = searchText.value.trim();
    const author  = authorFilter.value;
    const start   = dateStart.value;
    const end     = dateEnd.value;

    if (q) params.append("q", q);
    if (author) params.append("author", author);
    if (start) params.append("start", start);
    if (end) params.append("end", end);

    const res = await fetch(`/api/search_notes?${params.toString()}`);
    if (!res.ok) {
        console.error("Erreur API /api/search_notes");
        return;
    }

    allNotes = await res.json();
    currentPage = 1;
    paginateNotes();
}

// ----------------------------------------------------
// PAGINATION
// ----------------------------------------------------
function paginateNotes() {
    const total = allNotes.length;
    const totalPages = Math.max(1, Math.ceil(total / perPage));

    const startIndex = (currentPage - 1) * perPage;
    const slice = allNotes.slice(startIndex, startIndex + perPage);

    displayNotes(slice);
    renderPagination(totalPages);
}

function renderPagination(totalPages) {
    if (totalPages <= 1) {
        paginationTop.innerHTML = "";
        paginationBottom.innerHTML = "";
        return;
    }

    let html = `<nav><ul class="pagination">`;

    html += `
        <li class="page-item ${currentPage === 1 ? "disabled" : ""}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">Pr√©c√©dent</a>
        </li>
    `;

    for (let p = 1; p <= totalPages; p++) {
        html += `
            <li class="page-item ${p === currentPage ? "active" : ""}">
                <a class="page-link" href="#" onclick="changePage(${p}); return false;">${p}</a>
            </li>
        `;
    }

    html += `
        <li class="page-item ${currentPage === totalPages ? "disabled" : ""}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">Suivant</a>
        </li>
    `;

    html += `</ul></nav>`;

    paginationTop.innerHTML = html;
    paginationBottom.innerHTML = html;
}

function changePage(p) {
    const totalPages = Math.max(1, Math.ceil(allNotes.length / perPage));
    if (p < 1 || p > totalPages) return;
    currentPage = p;
    paginateNotes();
}

// ----------------------------------------------------
// AFFICHAGE DES NOTES
// ----------------------------------------------------
function displayNotes(data) {
    notesList.innerHTML = "";

    if (data.length === 0) {
        notesList.innerHTML = `<p class="text-muted mt-3">Aucun r√©sultat.</p>`;
        return;
    }

    data.forEach(n => {
        const div = document.createElement("div");
        div.className = "card p-3 mb-3 shadow-sm";

        div.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <a href="/cats/${n.cat_id}" class="fw-bold">${n.cat_name}</a>
                    <div class="text-muted small">Auteur : ${n.author}</div>
                    <div class="text-muted small">${n.created_at}</div>
                    ${n.content ? `<p class="mt-2">${n.content}</p>` : ""}
                    ${n.file ? `<a href="/uploads/${n.file}" target="_blank">üìé Pi√®ce jointe</a>` : ""}
                </div>
            </div>
        `;

        notesList.appendChild(div);
    });
}

// ----------------------------------------------------
// √âV√âNEMENTS DES FILTRES
// ----------------------------------------------------
searchText.addEventListener("input", loadNotes);
authorFilter.addEventListener("change", loadNotes);
dateStart.addEventListener("change", loadNotes);
dateEnd.addEventListener("change", loadNotes);

// Chargement initial
loadNotes();
</script>

{% endblock %}
