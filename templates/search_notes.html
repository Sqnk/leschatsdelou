{% extends "base.html" %}
{% block content %}

<h1 class="mb-4">Recherche dans les notes</h1>

<!-- FILTRES -->
<div class="card p-3 mb-4">

    <div class="row g-3">

        <!-- Recherche texte -->
        <div class="col-md-4">
            <label class="form-label">Recherche texte</label>
            <input id="searchText" type="text" class="form-control" placeholder="Contenu, auteur, chat...">
        </div>

        <!-- Filtre par chat (avec recherche live) -->
        <div class="col-md-4">
            <label class="form-label">Chat</label>
            <input id="catSearch" type="text" class="form-control" placeholder="Rechercher un chat...">
            <div id="catDropdown" class="list-group position-absolute w-50 d-none" style="z-index:1000;"></div>
        </div>

        <!-- Filtre auteur -->
        <div class="col-md-4">
            <label class="form-label">Auteur</label>
            <select id="authorFilter" class="form-select">
                <option value="">Tous</option>
                {% for e in employees %}
                <option value="{{ e.name }}">{{ e.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Date d√©but -->
        <div class="col-md-3">
            <label class="form-label">Date d√©but</label>
            <input id="dateStart" type="date" class="form-control">
        </div>

        <!-- Date fin -->
        <div class="col-md-3">
            <label class="form-label">Date fin</label>
            <input id="dateEnd" type="date" class="form-control">
        </div>
    </div>

</div>

<!-- LISTE DES NOTES -->
<div id="notesList" class="mt-3"></div>

<script>
// ----------------------------
// Chargement initial
// ----------------------------
async function loadNotes() {
    const params = new URLSearchParams();

    const q = document.getElementById("searchText").value;
    const author = document.getElementById("authorFilter").value;
    const start = document.getElementById("dateStart").value;
    const end = document.getElementById("dateEnd").value;
    const cat = selectedCat;

    if (q) params.append("q", q);
    if (author) params.append("author", author);
    if (start) params.append("start", start);
    if (end) params.append("end", end);
    if (cat) params.append("cat", cat);

    const res = await fetch(`/api/search_notes?${params.toString()}`);
    const data = await res.json();

    displayNotes(data);
}

// ----------------------------
// Affichage des notes
// ----------------------------
function displayNotes(data) {
    const list = document.getElementById("notesList");
    list.innerHTML = "";

    if (data.length === 0) {
        list.innerHTML = '<p class="text-muted">Aucun r√©sultat.</p>';
        return;
    }

    for (const n of data) {
        const div = document.createElement("div");
        div.className = "card p-3 mb-2";

        div.innerHTML = `
            <div class="d-flex justify-content-between">
                <div>
                    <a href="/cat/${n.cat_id}" class="fw-bold">${n.cat_name}</a>
                    <div class="text-muted small">Auteur : ${n.author}</div>
                </div>
                <small class="text-muted">${n.created_at}</small>
            </div>

            ${n.content ? `<p class="mt-2">${n.content}</p>` : ""}

            ${n.file ? `<a href="/uploads/${n.file}" target="_blank">üìé Pi√®ce jointe</a>` : ""}
        `;

        list.appendChild(div);
    }
}

// ----------------------------
// Recherche live dans les chats
// ----------------------------
let selectedCat = "";

document.getElementById("catSearch").addEventListener("input", async () => {
    const q = document.getElementById("catSearch").value;
    const dropdown = document.getElementById("catDropdown");

    if (q.length < 1) {
        dropdown.classList.add("d-none");
        return;
    }

    const res = await fetch(`/api/filter_cats?q=${encodeURIComponent(q)}`);
    const cats = await res.json();

    dropdown.innerHTML = "";
    dropdown.classList.remove("d-none");

    if (cats.length === 0) {
        dropdown.innerHTML = `<div class="list-group-item">Aucun r√©sultat</div>`;
        return;
    }

    cats.forEach(c => {
        const item = document.createElement("button");
        item.className = "list-group-item list-group-item-action";
        item.textContent = c.name;
        item.onclick = () => {
            selectedCat = c.id;
            document.getElementById("catSearch").value = c.name;
            dropdown.classList.add("d-none");
            loadNotes();
        };
        dropdown.appendChild(item);
    });
});

// Cacher dropdown si on clique ailleurs
document.addEventListener("click", e => {
    if (!document.getElementById("catSearch").contains(e.target)) {
        document.getElementById("catDropdown").classList.add("d-none");
    }
});

// ----------------------------
// Events des filtres
// ----------------------------
document.getElementById("searchText").addEventListener("input", loadNotes);
document.getElementById("authorFilter").addEventListener("change", loadNotes);
document.getElementById("dateStart").addEventListener("change", loadNotes);
document.getElementById("dateEnd").addEventListener("change", loadNotes);

// ----------------------------
// Load initial
// ----------------------------
loadNotes();
</script>

{% endblock %}
