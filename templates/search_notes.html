{% extends "base.html" %}
{% block content %}

<h1 class="mb-4 fw-bold">Recherche dans les notes</h1>

<div class="row">

    <!-- ==========================
         COLONNE FILTRES (GAUCHE)
    =========================== -->
    <div class="col-12 col-lg-3">

        <div class="card p-3 shadow-sm">

            <!-- Recherche texte -->
            <label class="form-label fw-semibold">Recherche texte</label>
            <input id="searchText" type="text" class="form-control mb-3" placeholder="Contenu, auteur, chat...">

            <!-- Filtre par chat -->
            <label class="form-label fw-semibold">Chat</label>
            <div class="position-relative mb-3">
                <input id="catSearch" type="text" class="form-control" placeholder="Rechercher un chat...">

                <div id="catDropdown"
                     class="list-group position-absolute w-100 d-none"
                     style="z-index:1000; max-height:200px; overflow-y:auto;">
                </div>
            </div>

            <!-- Auteur -->
            <label class="form-label fw-semibold">Auteur</label>
            <select id="authorFilter" class="form-select mb-3">
                <option value="">Tous</option>
                {% for e in employees %}
                <option value="{{ e.name }}">{{ e.name }}</option>
                {% endfor %}
            </select>

            <!-- Date d√©but -->
            <label class="form-label fw-semibold">Date d√©but</label>
            <input id="dateStart" type="date" class="form-control mb-3">

            <!-- Date fin -->
            <label class="form-label fw-semibold">Date fin</label>
            <input id="dateEnd" type="date" class="form-control mb-3">

        </div>
    </div>

    <!-- ==========================
         COLONNE R√âSULTATS (DROITE)
    =========================== -->
    <div class="col-12 col-lg-9">
        <div id="notesList"></div>
    </div>

</div>

<!-- ==========================
         JS
=========================== -->
<script>

let selectedCat = "";  

// ----------------------------------------------------
// CHARGEMENT DES NOTES
// ----------------------------------------------------
async function loadNotes() {
    const params = new URLSearchParams();

    const q = searchText.value;
    const author = authorFilter.value;
    const start = dateStart.value;
    const end = dateEnd.value;

    if (q) params.append("q", q);
    if (author) params.append("author", author);
    if (start) params.append("start", start);
    if (end) params.append("end", end);
    if (selectedCat) params.append("cat", selectedCat);

    const res = await fetch(`/api/search_notes?${params.toString()}`);
    const data = await res.json();

    displayNotes(data);
}

// ----------------------------------------------------
// AFFICHAGE
// ----------------------------------------------------
function displayNotes(data) {
    const list = document.getElementById("notesList");
    list.innerHTML = "";

    if (data.length === 0) {
        list.innerHTML = `<p class="text-muted mt-3">Aucun r√©sultat.</p>`;
        return;
    }

    for (const n of data) {
        const div = document.createElement("div");
        div.className = "card p-3 mb-3 shadow-sm";

        const imgHtml = n.cat_photo
            ? `<img src="/uploads/${n.cat_photo}" 
                    class="rounded ms-3"
                    style="width:100px;height:100px;object-fit:cover;">`
            : "";

        div.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">

                <div class="flex-grow-1">
                    <a href="/cats/${n.cat_id}" class="fw-bold">${n.cat_name}</a>
                    <div class="text-muted small">Auteur : ${n.author}</div>
                    <div class="text-muted small">${n.created_at}</div>

                    ${n.content ? `<p class="mt-2">${n.content}</p>` : ""}
                    ${n.file ? `<a href="/uploads/${n.file}" target="_blank">üìé Pi√®ce jointe</a>` : ""}
                </div>

                ${imgHtml}
            </div>
        `;

        list.appendChild(div);
    }
}

// ----------------------------------------------------
// AUTOCOMPLETE CHAT
// ----------------------------------------------------
catSearch.addEventListener("input", async () => {
    const q = catSearch.value.trim();
    const dropdown = catDropdown;

    if (q.length < 1) {
        dropdown.classList.add("d-none");
        return;
    }

    const res = await fetch(`/api/search_cats_for_notes?q=${encodeURIComponent(q)}`);
    const cats = await res.json();

    dropdown.innerHTML = "";
    dropdown.classList.remove("d-none");

    if (cats.length === 0) {
        dropdown.innerHTML = `<div class="list-group-item">Aucun r√©sultat</div>`;
        return;
    }

    cats.forEach(c => {
        const item = document.createElement("button");
        item.className = "list-group-item list-group-item-action";
        item.textContent = c.name;

        item.onclick = () => {
            selectedCat = c.id;
            catSearch.value = c.name;
            dropdown.classList.add("d-none");
            loadNotes();
        };

        dropdown.appendChild(item);
    });
});

// Cacher dropdown lors d'un clic ext√©rieur
document.addEventListener("click", e => {
    if (!catSearch.contains(e.target)) {
        catDropdown.classList.add("d-none");
    }
});

// √âv√©nements
searchText.addEventListener("input", loadNotes);
authorFilter.addEventListener("change", loadNotes);
dateStart.addEventListener("change", loadNotes);
dateEnd.addEventListener("change", loadNotes);

// Initial
loadNotes();

</script>

{% endblock %}
