{% extends "base.html" %}
{% block content %}

<div class="container mt-4">

    <h1>Modifier le rendez-vous</h1>

    <form action="{{ url_for('appointment_update', appointment_id=appt.id) }}" method="POST" class="mt-4">

        <div class="row mb-3">

            <!-- DATE -->
            <div class="col-md-4">
                <label class="form-label">Date & heure</label>
                <input type="datetime-local"
                       name="date"
                       class="form-control"
                       value="{{ appt.date.strftime('%Y-%m-%dT%H:%M') }}"
                       required>
            </div>

            <!-- LIEU / VÉTÉRINAIRE -->
            <div class="col-md-4">
                <label class="form-label">Lieu</label>
                <select name="location" class="form-select">
                    <option value="">Lieu du rendez-vous</option>
                    {% for v in veterinarians %}
                        <option value="{{ v.name }}"
                            {% if appt.location == v.name %}selected{% endif %}>
                            {{ v.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- CRÉÉ PAR -->
            <div class="col-md-4">
                <label class="form-label">Créé par</label>
                <select name="created_by" class="form-select">
                    <option value="">—</option>
                    {% for e in employees %}
                        <option value="{{ e.name }}"
                            {% if appt.created_by == e.name %}selected{% endif %}>
                            {{ e.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

        </div>

        <hr>

        <!-- ======================== CHATS DISPONIBLES / SELECTED ======================== -->
        <div class="row">

            <!-- CHATS DISPONIBLES -->
            <div class="col-md-6">
                <label><strong>Chats disponibles</strong></label>
                <div class="p-2 border rounded"
                     style="min-height:150px; max-height:250px; overflow-y:auto;">

                    <input type="text"
                           id="searchCat"
                           class="form-control mb-2"
                           placeholder="Rechercher un chat...">

                    <div id="catsContainer">
                        {% set selected_ids = appt.cats | map(attribute='cat_id') | list %}
                        {% for c in cats %}
                            <div class="cat-pill"
                                 data-id="{{ c.id }}"
                                 {% if c.id in selected_ids %}
                                     style="display:none;"
                                 {% endif %}>
                                {{ c.name }}
                            </div>
                        {% endfor %}
                    </div>

                </div>
            </div>

            <!-- CHATS SÉLECTIONNÉS -->
            <div class="col-md-6">
                <label><strong>Chats sélectionnés</strong></label>
                <div class="p-2 border rounded"
                     style="min-height:150px; max-height:250px; overflow-y:auto;">
                    <div id="selectedCats">
                        {% for ac in appt.cats %}
                            <div class="cat-pill cat-pill-selected" data-id="{{ ac.cat_id }}">
                                {{ ac.cat.name }}
                                <button class="remove-btn" data-id="{{ ac.cat_id }}">×</button>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

        </div>

        <!-- Hidden inputs -->
        <div id="hiddenCatsContainer">
            {% for ac in appt.cats %}
                <input type="hidden" name="cats[]" value="{{ ac.cat_id }}">
            {% endfor %}
        </div>

        <hr>

        <!-- EMPLOYÉS -->
        <h4 class="mt-3">Employés assignés</h4>

        <div class="row">
            {% set assigned = appt.employees | map(attribute='employee_id') | list %}
            {% for e in employees %}
                <div class="col-md-3 mt-2">
                    <label class="border p-2 rounded w-100 d-block">
                        <input type="checkbox"
                               name="employees[]"
                               value="{{ e.id }}"
                               {% if e.id in assigned %}checked{% endif %}>
                        {{ e.name }}
                    </label>
                </div>
            {% endfor %}
        </div>

        <button class="btn btn-primary mt-4">Enregistrer les modifications</button>

    </form>

</div>

<script>
let selected = [];

// Initialise les chats déjà sélectionnés
document.querySelectorAll("#selectedCats .cat-pill-selected").forEach(el => {
    selected.push(el.dataset.id);
});

// Clic — Ajouter un chat
document.addEventListener("click", function(e){
    if(e.target.classList.contains("cat-pill")){
        let id = e.target.dataset.id;
        let name = e.target.innerText;

        if(!selected.includes(id)){
            selected.push(id);

            document.getElementById("selectedCats").innerHTML += `
                <div class="cat-pill cat-pill-selected" data-id="${id}">
                    ${name}
                    <button class="remove-btn" data-id="${id}">×</button>
                </div>
            `;

            e.target.style.display = "none";
            updateHiddenField();
        }
    }

    if(e.target.classList.contains("remove-btn")){
        let id = e.target.dataset.id;

        selected = selected.filter(x => x !== id);
        document.querySelector('.cat-pill-selected[data-id="'+id+'"]').remove();
        document.querySelector('.cat-pill[data-id="'+id+'"]').style.display = "";
        updateHiddenField();
    }
});

// Mise à jour du champ hidden
function updateHiddenField(){
    const container = document.getElementById("hiddenCatsContainer");
    container.innerHTML = "";
    selected.forEach(id => {
        container.innerHTML += `<input type="hidden" name="cats[]" value="${id}">`;
    });
}

// Recherche dynamique
document.getElementById("searchCat").addEventListener("input", function(){
    let q = this.value.toLowerCase();

    document.querySelectorAll("#catsContainer .cat-pill").forEach(el=>{
        if (selected.includes(el.dataset.id)) {
            el.style.display = "none";
            return;
        }
        el.style.display = el.innerText.toLowerCase().includes(q) ? "" : "none";
    });
});
</script>

{% endblock %}
