{% extends "base.html" %}

{% block content %}
<div class="container mt-4">

    <h2 class="mb-4">Modifier le rendez-vous</h2>

    <form method="POST">

        <!-- DATE -->
        <div class="mb-3">
            <label class="form-label">Date et heure</label>
            <input type="datetime-local" name="date" class="form-control"
                   value="{{ appt.date.strftime('%Y-%m-%dT%H:%M') }}">
        </div>

        <!-- LIEU -->
        <div class="mb-3">
            <label class="form-label">Lieu</label>
            <input type="text" name="location" class="form-control"
                   value="{{ appt.location }}">
        </div>

        <hr>

        {# Pr√©pare les listes d'ID d√©j√† s√©lectionn√©s c√¥t√© Jinja #}
        {% set selected_cat_ids = appt.cats | map(attribute='cat_id') | list %}
        {% set selected_emp_ids = appt.employees | map(attribute='employee_id') | list %}

        <!-- ==========================
             1. CHATS
        =========================== -->
        <h4 class="mt-4">Chats associ√©s</h4>
        <div class="row" id="edit-cats-section">

            <!-- Colonne : chats disponibles -->
            <div class="col-md-6 mb-3">
                <label class="form-label">Rechercher un chat</label>
                <input type="text"
                       id="edit-cat-search"
                       class="form-control mb-2"
                       placeholder="Tapez un nom de chat...">

                <ul class="list-group small" id="edit-cats-available">
                    {% for c in cats %}
                        {% if c.id not in selected_cat_ids %}
                        <li class="list-group-item d-flex justify-content-between align-items-center"
                            data-id="{{ c.id }}"
                            data-name="{{ c.name }}">
                            <span>{{ c.name }}</span>
                            <button type="button"
                                    class="btn btn-sm btn-outline-primary"
                                    data-action="add-cat">
                                Ajouter
                            </button>
                        </li>
                        {% endif %}
                    {% endfor %}
                </ul>
            </div>

            <!-- Colonne : chats s√©lectionn√©s -->
            <div class="col-md-6 mb-3">
                <label class="form-label">Chats s√©lectionn√©s</label>
                <ul class="list-group small" id="edit-cats-selected">
                    {% for c in cats %}
                        {% if c.id in selected_cat_ids %}
                        <li class="list-group-item d-flex justify-content-between align-items-center"
                            data-id="{{ c.id }}"
                            data-name="{{ c.name }}">
                            <span>{{ c.name }}</span>
                            <div class="d-flex align-items-center gap-2">
                                <button type="button"
                                        class="btn btn-sm btn-outline-danger"
                                        data-action="remove-cat">
                                    Retirer
                                </button>
                            </div>
                            <!-- input cach√© r√©ellement envoy√© au backend -->
                            <input type="hidden" name="cats[]" value="{{ c.id }}">
                        </li>
                        {% endif %}
                    {% endfor %}
                </ul>
            </div>
        </div>

        <hr>

        <!-- ==========================
             2. EMPLOY√âS
        =========================== -->
        <h4 class="mt-4">Employ√©s associ√©s</h4>
        <div class="row" id="edit-emps-section">

            <!-- Colonne : employ√©s disponibles -->
            <div class="col-md-6 mb-3">
                <label class="form-label">Rechercher un employ√©</label>
                <input type="text"
                       id="edit-emp-search"
                       class="form-control mb-2"
                       placeholder="Tapez un nom d'employ√©...">

                <ul class="list-group small" id="edit-emps-available">
                    {% for e in employees %}
                        {% if e.id not in selected_emp_ids %}
                        <li class="list-group-item d-flex justify-content-between align-items-center"
                            data-id="{{ e.id }}"
                            data-name="{{ e.name }}">
                            <span>{{ e.name }}</span>
                            <button type="button"
                                    class="btn btn-sm btn-outline-primary"
                                    data-action="add-emp">
                                Ajouter
                            </button>
                        </li>
                        {% endif %}
                    {% endfor %}
                </ul>
            </div>

            <!-- Colonne : employ√©s s√©lectionn√©s -->
            <div class="col-md-6 mb-3">
                <label class="form-label">Employ√©s s√©lectionn√©s</label>
                <ul class="list-group small" id="edit-emps-selected">
                    {% for e in employees %}
                        {% if e.id in selected_emp_ids %}
                        <li class="list-group-item d-flex justify-content-between align-items-center"
                            data-id="{{ e.id }}"
                            data-name="{{ e.name }}">
                            <span>{{ e.name }}</span>
                            <div class="d-flex align-items-center gap-2">
                                <button type="button"
                                        class="btn btn-sm btn-outline-danger"
                                        data-action="remove-emp">
                                    Retirer
                                </button>
                            </div>
                            <!-- input cach√© r√©ellement envoy√© au backend -->
                            <input type="hidden" name="employees[]" value="{{ e.id }}">
                        </li>
                        {% endif %}
                    {% endfor %}
                </ul>
            </div>
        </div>

        <hr>

        <button class="btn btn-primary mt-3">üíæ Enregistrer</button>
        <a href="{{ url_for('appointments_page') }}" class="btn btn-secondary mt-3">Annuler</a>

    </form>

</div>

{# ================================
   JS sp√©cifique pour cette page
   (auto-contenu, ne touche pas les autres)
   ================================ #}
<script>
document.addEventListener("DOMContentLoaded", function () {

    function setupSelection(config) {
        const searchInput   = document.getElementById(config.searchId);
        const availableList = document.getElementById(config.availableId);
        const selectedList  = document.getElementById(config.selectedId);

        if (!searchInput || !availableList || !selectedList) return;

        // Filtrage par recherche
        searchInput.addEventListener("input", function () {
            const q = this.value.trim().toLowerCase();
            Array.from(availableList.children).forEach(li => {
                const name = (li.dataset.name || "").toLowerCase();
                li.style.display = name.includes(q) ? "" : "none";
            });
        });

        // Ajout depuis la liste de gauche
        availableList.addEventListener("click", function (e) {
            const btn = e.target.closest("button[data-action='" + config.addAction + "']");
            if (!btn) return;

            const li = btn.closest("li");
            if (!li) return;

            const id   = li.dataset.id;
            const name = li.dataset.name;

            // Cr√©e un nouvel √©l√©ment dans la liste s√©lectionn√©e
            const newLi = document.createElement("li");
            newLi.className = "list-group-item d-flex justify-content-between align-items-center";
            newLi.dataset.id = id;
            newLi.dataset.name = name;

            const span = document.createElement("span");
            span.textContent = name;

            const btnContainer = document.createElement("div");
            btnContainer.className = "d-flex align-items-center gap-2";

            const removeBtn = document.createElement("button");
            removeBtn.type = "button";
            removeBtn.className = "btn btn-sm btn-outline-danger";
            removeBtn.dataset.action = config.removeAction;
            removeBtn.textContent = "Retirer";

            btnContainer.appendChild(removeBtn);

            // input cach√© qui sera envoy√© au backend
            const hidden = document.createElement("input");
            hidden.type = "hidden";
            hidden.name = config.inputName;
            hidden.value = id;

            newLi.appendChild(span);
            newLi.appendChild(btnContainer);
            newLi.appendChild(hidden);

            selectedList.appendChild(newLi);
            li.remove();
        });

        // Retrait depuis la liste de droite
        selectedList.addEventListener("click", function (e) {
            const btn = e.target.closest("button[data-action='" + config.removeAction + "']");
            if (!btn) return;

            const li = btn.closest("li");
            if (!li) return;

            const id   = li.dataset.id;
            const name = li.dataset.name;

            // Cr√©e un √©l√©ment dans la liste disponible
            const newLi = document.createElement("li");
            newLi.className = "list-group-item d-flex justify-content-between align-items-center";
            newLi.dataset.id = id;
            newLi.dataset.name = name;

            const span = document.createElement("span");
            span.textContent = name;

            const addBtn = document.createElement("button");
            addBtn.type = "button";
            addBtn.className = "btn btn-sm btn-outline-primary";
            addBtn.dataset.action = config.addAction;
            addBtn.textContent = "Ajouter";

            newLi.appendChild(span);
            newLi.appendChild(addBtn);

            availableList.appendChild(newLi);
            li.remove();
        });
    }

    // Chats
    setupSelection({
        searchId:    "edit-cat-search",
        availableId: "edit-cats-available",
        selectedId:  "edit-cats-selected",
        inputName:   "cats[]",
        addAction:   "add-cat",
        removeAction:"remove-cat"
    });

    // Employ√©s
    setupSelection({
        searchId:    "edit-emp-search",
        availableId: "edit-emps-available",
        selectedId:  "edit-emps-selected",
        inputName:   "employees[]",
        addAction:   "add-emp",
        removeAction:"remove-emp"
    });

});
</script>

{% endblock %}
