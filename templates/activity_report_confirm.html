{% extends "base.html" %}
{% block content %}
<div class="container mt-4">

    <h2 class="mb-3">Confirmation du rapport d'activité</h2>

    <p>
        Vous êtes sur le point de générer le rapport d’activité pour :
        <strong>{{ month }}/{{ year }}</strong>
    </p>

    <hr>

    <!-- ========================= -->
    <!--        TABLEAU DES ENTRÉES -->
    <!-- ========================= -->

    <h4 class="mt-4 mb-3">Entrées</h4>
    <table class="table table-bordered">
        <tr><th>Abandons</th><td>{{ counts.entries_abandon }}</td></tr>
        <tr><th>Retours après placement</th><td>{{ counts.entries_return }}</td></tr>
        <tr><th>Trouvés</th><td>{{ counts.entries_found }}</td></tr>
        <tr class="table-primary">
            <th>Total des entrées</th>
            <td><strong>{{ counts.entries_total }}</strong></td>
        </tr>
    </table>

    <!-- ========================= -->
    <!--        TABLEAU DES SORTIES -->
    <!-- ========================= -->

    <h4 class="mt-4 mb-3">Sorties</h4>
    <table class="table table-bordered">
        <tr><th>Placés</th><td>{{ counts.exits_placed }}</td></tr>
        <tr><th>Rendus à leur propriétaire</th><td>{{ counts.exits_returned_owner }}</td></tr>
        <tr><th>Décédés</th><td>{{ counts.exits_deceased }}</td></tr>
        <tr><th>Échappés</th><td>{{ counts.exits_escaped }}</td></tr>
        <tr><th>Transférés vers un autre établissement</th><td>{{ counts.exits_transferred }}</td></tr>
        <tr class="table-primary">
            <th>Total des sorties</th>
            <td><strong>{{ counts.exits_total }}</strong></td>
        </tr>
    </table>

    <!-- ========================= -->
    <!--        TABLEAU ANIMAUX -->
    <!-- ========================= -->

    <h4 class="mt-4 mb-3">Nombre d’animaux</h4>

    {% set species = [] %}

	{# Chats début de mois = count_start - autres espèces #}
	{% set chats_start = counts.count_start
						- counts.species1_count
						- counts.species2_count
						- counts.species3_count %}

	{% set _ = species.append({
		'name': 'Chats',
		'count': chats_start
	}) %}

	{# Ajout des espèces supplémentaires #}
	{% for i in [1,2,3] %}
		{% set name = counts['species' ~ i ~ '_name'] %}
		{% set count = counts['species' ~ i ~ '_count'] %}
		{% if name and name|length > 0 %}
			{% set _ = species.append({'name': name, 'count': count}) %}
		{% endif %}
	{% endfor %}


    {# TOTAL DÉBUT #}
    {% set total_start = 0 %}
    {% for sp in species %}
        {% set total_start = total_start + sp.count %}
    {% endfor %}

    {# FIN DE MOIS #}
    {% set species_end = [] %}

	{# Chats fin de mois #}
	{% set chats_end = counts.count_end
						- counts.species1_count_end
						- counts.species2_count_end
						- counts.species3_count_end %}

	{% set _ = species_end.append({
		'name': 'Chats',
		'count': chats_end
	}) %}

	{% for i in [1,2,3] %}
		{% set name = counts['species' ~ i ~ '_name_end'] %}
		{% set count = counts['species' ~ i ~ '_count_end'] %}
		{% if name and name|length > 0 %}
			{% set _ = species_end.append({'name': name, 'count': count}) %}
		{% endif %}
	{% endfor %}


        {% if name and name|length > 0 %}
            {% set _ = species_end.append({'name': name, 'count': count}) %}
        {% endif %}
    {% endfor %}

    {# TOTAL FIN #}
    {% set total_end = species_end | map(attribute='count') | sum %}

    <table class="table table-bordered">

        <!-- DÉBUT DE MOIS -->
        <tr class="table-primary">
            <th>Animaux en début de mois</th>
            <td><strong>{{ total_start }}</strong></td>
        </tr>

        {% for sp in species %}
            <tr>
                <th>{{ sp.name }}</th>
                <td>{{ sp.count }}</td>
            </tr>
        {% endfor %}

        <!-- FIN DE MOIS -->
        <tr class="table-primary">
            <th>Animaux en fin de mois</th>
            <td><strong>{{ total_end }}</strong></td>
        </tr>

        {% for sp in species_end %}
            <tr>
                <th>{{ sp.name }}</th>
                <td>{{ sp.count }}</td>
            </tr>
        {% endfor %}

    </table>

    <hr>

    <!-- ========================= -->
    <!--        VALIDATION -->
    <!-- ========================= -->

    <form action="{{ url_for('generate_activity_report') }}" method="POST">

        <input type="hidden" name="year" value="{{ year }}">
        <input type="hidden" name="month" value="{{ month }}">

        {% for key, val in counts.items() %}
            <input type="hidden" name="{{ key }}" value="{{ val }}">
        {% endfor %}

        <button class="btn btn-primary btn-lg mt-3">Générer le PDF</button>
        <a href="{{ url_for('documents') }}" class="btn btn-secondary btn-lg mt-3">Annuler</a>

    </form>

</div>
{% endblock %}
